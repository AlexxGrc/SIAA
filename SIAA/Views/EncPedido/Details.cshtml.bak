@model SIAAPI.Models.Comercial.EncPedido

@{
    ViewBag.Title = "Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}




    <hr />
    @*<dl class="dl-horizontal">*@
    <div class="row">
        <div class="columna col-md-4 col-sm-1">
            <dl>
                <dt>
                    <h3>Pedido</h3>
                </dt>
                <dt>
                    @Html.DisplayNameFor(model => model.IDCliente)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.Clientes.Nombre)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.Fecha)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.Fecha)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.FechaRequiere)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.FechaRequiere)
                </dd>
                <dt>
                    @Html.DisplayNameFor(model => model.IDVendedor)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.Vendedor.Nombre)
                </dd>
                <dt>
                    @Html.DisplayNameFor(model => model.OCompra)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.OCompra)
                </dd>
                <dt>
                    @Html.DisplayNameFor(model => model.Observacion)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.Observacion)
                </dd>

            </dl>
        </div>


        <div class="columna col-md-4 col-sm-1">
            <dl>
                <dt>
                 <h3>@Html.DisplayFor(model => model.IDPedido)</h3>   
                </dt>
                <dt>
                    @Html.DisplayNameFor(model => model.IDUsoCFDI)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.c_UsoCFDI.Descripcion)
                </dd>
                <dt>
                    @Html.DisplayNameFor(model => model.IDFormapago)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.c_FormaPago.ClaveFormaPago)|@Html.DisplayFor(model => model.c_FormaPago.Descripcion)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.IDMetodoPago)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.c_MetodoPago.ClaveMetodoPago)|@Html.DisplayFor(model => model.c_MetodoPago.Descripcion)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.IDMoneda)
                </dt>
                <dd>

                    @Html.DisplayFor(model => model.c_Moneda.ClaveMoneda)|@Html.DisplayFor(model => model.c_Moneda.Descripcion)

                </dd>
                <dt>
                    @Html.DisplayNameFor(model => model.TipoCambio)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.TipoCambio)
                </dd>

                <dt>
                    @Html.DisplayNameFor(model => model.IDCondicionesPago)
                </dt>

                <dd>
                    @Html.DisplayFor(model => model.CondicionesPago.ClaveCondicionesPago)|@Html.DisplayFor(model => model.CondicionesPago.Descripcion)
                </dd>
            </dl>

        </div>
    </div>
<div class="table-responsive">
    <table class="table table-striped" width="50">
        <thead>
            <tr>
              
               
               <th>Referencia</th>
                <th>Artículo</th>
             
                <th>Nota</th>
<th>Almacén</th>
                <th>Venta Mínima</th>
                <th>Cantidad</th>
                <th>Suministro</th>
                <th>Precio</th>
                <th>Importe</th>
                <th>IVA</th>
                <th>Total</th>
                @*<th>Remisión</th>
                <th>Prefactura</th>*@
                <th>Orden de Producción</th>

            </tr>
        </thead>

        @foreach (SIAAPI.ViewModels.Comercial.VDetPedido item in ViewBag.req)
        {
            SIAAPI.Models.Comercial.Caracteristica car = new SIAAPI.Models.Comercial.ArticuloContext().Database.SqlQuery<SIAAPI.Models.Comercial.Caracteristica>("select * from Caracteristica where ID=" + item.Caracteristica_ID).ToList().FirstOrDefault();

            if (item.Status.Equals("Cancelado"))
            {
                <tr class="danger">
                    <td>
                      <div>@item.Cref</div>
                        @if (item.IDDetExterna != 0)
                        {
                            <div>Cotización @item.IDDetExterna</div>
                        }
                        else
                        {
                            <div>N/A</div>

        }
                    </td>


                    <td>@item.Articulo  </td>

                    <td>@item.Nota</td>
                    <td>
                        @{
                            SIAAPI.Models.Comercial.AlmacenContext db = new SIAAPI.Models.Comercial.AlmacenContext();
                            string cadena = "select codAlm as Dato from Almacen where idAlmacen='" + item.IDAlmacen + "'";
                            SIAAPI.Models.Comercial.ClsDatoString cod = db.Database.SqlQuery<SIAAPI.Models.Comercial.ClsDatoString>(cadena).ToList()[0];
                        }
                        @cod.Dato
                    </td>
                    <td>@item.MinimoVenta</td>
                    <td>@item.Cantidad</td>
                    <td>@item.Suministro</td>
                    <td>@string.Format("{0:C}", @item.Costo)</td>
                    <td>@string.Format("{0:C}", @item.Importe)</td>
                    <td>@string.Format("{0:C}", @item.ImporteIva)</td>
                    <td>@string.Format("{0:C}", @item.ImporteTotal)</td>
                    @*@if (item.IDRemision != 0)
                    {
                        <td>
                            @item.IDRemision
                        </td>
                    }
                    else
                    {
                        <td>
                            N/A
                        </td>
                    }
                    @if (item.IDPrefactura != 0)
                    {
                        <td>
                            @item.IDPrefactura
                        </td>
                    }
                    else
                    {
                        <td>
                            N/A
                        </td>
                    }*@
                    @if (item.GeneraOrdenP)
                    {
                        <td>
                            N/A
                        </td>
                    }
                    else
                    {
                        <td>
                            N/A
                        </td>
                    }
                </tr>
            }
            else
            {
                <tr>
                  
                    @if (item.IDDetExterna != 0)
                    {
                        <td>
                            <div>@item.Cref</div>
                             <div>Cotización   @item.IDDetExterna</div>
                        </td>
                    }
                    else
                    {

                        <td>
                            <div>@item.Cref</div> 
                           
                        </td>
                    }

                    @if (item.Status.Equals("Activo"))
                    {
                        <td class="success">
                          <div>@item.Articulo</div> 
                            <div><h5>Número de Presentación @car.IDPresentacion</h5><h6> @item.Presentacion</h6</div>
                        </td>
                    }
                    else if (item.Status.Equals("Inactivo"))
                    {
                        <td class="danger">
                           <div>@item.Articulo</div> 
                            <div><h5>Número de Presentación @car.IDPresentacion </h5><h6>@item.Presentacion</h6></div>
                        </td>
                    }
                    else if (item.Status.Equals("Finalizado"))
                    {
                        <td>
                           <div>@item.Articulo</div>
                            <div><h5>Número de Presentación @car.IDPresentacion </h5><h6>@item.Presentacion</h6></div>
                        </td>
                    }
                    else if (item.Status.Equals("Recepcionado") || item.Status.Equals("PreFacturado"))
                    {
                        <td class="warning">
                           <div>@item.Articulo</div> 
                            <div><h5>Número de Presentación @car.IDPresentacion </h5><h6>@item.Presentacion</h6></div>
                        </td>
                    }

                   
                    <td>@item.Nota</td>
<td>
                        @{
                            SIAAPI.Models.Comercial.AlmacenContext db1 = new SIAAPI.Models.Comercial.AlmacenContext();
                            string cadena = "select codAlm as Dato from Almacen where idAlmacen='" + item.IDAlmacen + "'";
                            SIAAPI.Models.Comercial.ClsDatoString cod = db1.Database.SqlQuery<SIAAPI.Models.Comercial.ClsDatoString>(cadena).ToList()[0];
                        }
                        @cod.Dato
                    </td>
                    @if (item.Cantidad < item.MinimoVenta)
                    {
                        <td class="danger">@item.MinimoVenta</td>
                    }
                    else
                    {
                        <td>@item.MinimoVenta</td>
                    }
                    <td>@item.Cantidad</td>
                    <td>@item.Suministro</td>
                    <td>@string.Format("{0:C}", @item.Costo)</td>
                    <td>@string.Format("{0:C}", @item.Importe)</td>
                    <td>@string.Format("{0:C}", @item.ImporteIva)</td>
                    <td>@string.Format("{0:C}", @item.ImporteTotal)</td>
                    @*@if (item.IDRemision != 0)
                    {
                        <td>
                            @item.IDRemision
                        </td>
                    }
                    else
                    {
                        <td>
                            N/A
                        </td>
                    }
                    @if (item.IDPrefactura != 0)
                    {
                        <td>
                            @item.IDPrefactura
                        </td>
                    }
                    else
                    {
                        <td>
                            N/A
                        </td>
                    }*@
                    @if (item.GeneraOrdenP != false)
                    {

                        if (item.GeneraOrden.Equals(true) && item.Status.Equals("Activo") || item.Status.Equals("PreFacturado") || item.Status.Equals("Finalizado")|| item.Status.Equals("Recepcionado"))
                        {
                            SIAAPI.Models.Produccion.OrdenProduccionContext db = new SIAAPI.Models.Produccion.OrdenProduccionContext();
                            int iddetpedido = item.IDDetPedido;
                            int idordenc = db.Database.SqlQuery<int>("select count(IDOrden) from OrdenProduccion where IDDetPedido=" + iddetpedido + " and ESTADOORDEN <> 'Cancelada' ").FirstOrDefault();
                            if (idordenc == 0 && item.Status.Equals("Activo") || item.Status.Equals("PreFacturado"))
                            {
                                <td>
                                    @*@Html.ActionLink("Genera Orden Producción", "", "EncRemision", new { id = item.IDRemision }, new { @class = "btn btn-success btn-xs" })*@
                                    @*<a class="edit" onclick=GeneraOrdenP(@item.IDDetPedido)><span class="btn btn-warning btn-xs">Genera Orden Producción</span></a>*@



                                </td>
                            }
                            }
                            else
                            {
                                try
                                {
                                     SIAAPI.Models.Comercial.ClsDatoEntero idorden = db.Database.SqlQuery
                                    <SIAAPI.Models.Comercial.ClsDatoEntero>("select IDOrden as Dato from OrdenProduccion where IDDetPedido=" + iddetpedido + "").ToList()[0];
                                    ViewBag.datoidorden = idorden.Dato.ToString();
                                    string nombre = ViewBag.datoidorden;
                                    <td>

                                        <center>@Html.ActionLink(nombre, "TerminacionProceso", "OrdenProduccion", null, null)</center>


                                    </td>

                                }
                                catch (Exception err)
                                {

                                }

                            }

                        }
                    }
                    else
                    {
                        <td>
                            N/A
                        </td>
                    }

                </tr>
            }
        }

        <tr>
            <td>
                <button type="button" class="btn btn-success btn-xs" data-toggle="modal" data-target="#btn_modal">Generar Ordenes</button>

            </td>
            
        </tr>
    </table>
</div>



@*Modal agregar generaorden*@
        <div class="modal" id="btn_modal">
            <div class="modal-dialog">
                <div class="modal-content">

                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h4 class="modal-title"><strong> Pedido: @Model.IDPedido </strong></h4>

                    </div>

                    <!-- Modal body -->
                    <div class="modal-body">

                        @using (Html.BeginForm("GeneraOrden", "EncPedido", FormMethod.Post))
                        {

                        <table class="table table-striped" width="50">
                            <thead>
                                <tr>



                                    <th>Artículo</th>


                                    <th>Almacén</th>

                                    <th>Cantidad</th>
                                    <th>Existencia</th>
                                    <td></td>

                                </tr>
                            </thead>

                            @{
                            var contador = 0;
                            }

                            @foreach (SIAAPI.ViewModels.Comercial.VDetPedido item in ViewBag.req)
                        {
                            ViewBag.iddetallepedido = item.IDDetPedido;
                            // string cadena1 = "select * from dbo.Articulo where Cref <> '" + item.Cref+"'";
                            //     SIAAPI.Models.Comercial.ArticuloContext dbart = new SIAAPI.Models.Comercial.ArticuloContext();
                            //SIAAPI.Models.Comercial.ClsDatoString cod = dbart.Database.SqlQuery}

                                <tr class="danger">
                                    <td>
                                        <div>@item.Cref</div>

                                    </td>
                                    <td>
                                        @{
                            SIAAPI.Models.Comercial.AlmacenContext db1 = new SIAAPI.Models.Comercial.AlmacenContext();
                            string cadena = "select codAlm as Dato from Almacen where idAlmacen='" + item.IDAlmacen + "'";
                            SIAAPI.Models.Comercial.ClsDatoString cod = db1.Database.SqlQuery<SIAAPI.Models.Comercial.ClsDatoString>(cadena).ToList()[0];
                                        }
                                        @cod.Dato
                                    </td>
                                    <td>
                                        @{string cadenacan = "Cantidad" + contador;
                                        }
                                        <input type="number" step="0.5" class="form-control" id="@cadenacan" name="Cantidad" value="@item.Cantidad">



                                    </td>
                                    <td>

                                        @{
                            decimal disponibilidadInventario = 0;
                            try
                            {
                                string cadenadis = "select Disponibilidad as Dato from InventarioAlmacen where idAlmacen=" + item.IDAlmacen + " and idcaracteristica=" + item.Caracteristica_ID;
                                SIAAPI.Models.Comercial.ClsDatoDecimal disponibilidad = db1.Database.SqlQuery<SIAAPI.Models.Comercial.ClsDatoDecimal>(cadenadis).ToList()[0];
                                if (disponibilidad.Dato < 0)
                                {
                                    disponibilidadInventario = 0;
                                }
                                else
                                {
                                    disponibilidadInventario = disponibilidad.Dato;
                                }

                            }
                            catch (Exception err)
                            {
                                disponibilidadInventario = 0;

                            }

                                        }

                                        @disponibilidadInventario



                                    </td>

                                    <td>



                                        @if (item.GeneraOrdenP != false)
                        {

                            if (item.GeneraOrden.Equals(true) && item.Status.Equals("Activo") || item.Status.Equals("PreFacturado") || item.Status.Equals("Finalizado") || item.Status.Equals("Recepcionado"))
                            {
                                SIAAPI.Models.Produccion.OrdenProduccionContext db = new SIAAPI.Models.Produccion.OrdenProduccionContext();
                                int iddetpedido = item.IDDetPedido;
                                int idordenc = db.Database.SqlQuery<int>("select count(IDOrden) from OrdenProduccion where IDDetPedido=" + iddetpedido + " and ESTADOORDEN <> 'Cancelada' ").FirstOrDefault();
                                if (idordenc == 0 && item.Status.Equals("Activo") || item.Status.Equals("PreFacturado"))
                                {
                                                    <input type="hidden" name="id" class="form-control" value="@item.IDDetPedido" />



                                                    <!-- Modal footer -->
                                                    <div class="modal-footer">

                                                        <input type="submit" value="Generar Orden" class="btn btn-success" />


                                                    </div>



                                }
                                else
                                {
                                    try
                                    {
                                        SIAAPI.Models.Comercial.ClsDatoEntero idorden = db.Database.SqlQuery<SIAAPI.Models.Comercial.ClsDatoEntero>("select IDOrden as Dato from OrdenProduccion where IDDetPedido=" + iddetpedido + "").ToList()[0];
                                        ViewBag.datoidorden = idorden.Dato.ToString();
                                        string nombre = ViewBag.datoidorden;


                                                        <center>@Html.ActionLink(nombre, "TerminacionProceso", "OrdenProduccion", null, null)</center>




                                    }
                                    catch (Exception err)
                                    {

                                    }

                                }

                            }
                        }
                        else
                        {

                                            <h2> N/A</h2>

                        }


                                    </td>


                                </tr>
                                contador++;
                            }
                        </table>

                            }



                    </div>



            </div>
        </div>
    </div>

<div class="table-responsive">
    <table class="table table-striped" width="50">
        <tr>
            <th class="col-lg-1">
                Moneda Origen
            </th>
            <th class="col-lg-1">
                Subtotal
            </th>
            <th class="col-lg-1">
                IVA
            </th>
            <th class="col-lg-1">
                Total
            </th>
            <th class="col-lg-1">
                Total en Pesos Mexicanos
            </th>
        </tr>
        @foreach (var itemresumen in ViewBag.sumatoria)
        {

            <tr>
                <td class="col-lg-1">
                    @itemresumen.MonedaOrigen
                </td>
                <td class="col-lg-1">
                    @String.Format("{0:C}", itemresumen.Subtotal)
                </td>
                <td class="col-lg-1">
                    @String.Format("{0:C}", itemresumen.IVA)
                </td>
                <td class="col-lg-1">
                    @String.Format("{0:C}", itemresumen.Total)
                </td>
                <td class="col-lg-1">
                    @String.Format("{0:C}", itemresumen.TotalenPesos)
                </td>

            </tr>
        }
    </table>
</div>

    <h5 align="right">Elaboró: @Html.DisplayFor(model => model.User.Username)</h5> 
<p>
    @*@Html.ActionLink("Editar", "Edit", new { id = Model.IDRequisicion }, new { @class = "btn btn-success" }) |*@
    @Html.ActionLink("Regresar a la lista", "Index", null, new { @class = "btn btn-default btn-xs" })
</p>

    <script src="~/Scripts/libs/jquery_1.10.2/jquery-1.10.2.min.js"></script>

    <script src="~/Scripts/libs/salert/sweetalert.min.js"></script>


    <script>

    var urledit = '@Url.Action("GeneraOrden", "EncPedido")';

        function GeneraOrdenP(id, numero) {
              var cantidad = document.getElementById("Cantidad" + numero).value
            $.post(urledit, { id: id, cantidad:cantidad}, function (response) {
               if (response.errorMessage) {

                    swal("El producto no tiene planeación", "", "error")
               }
              else if (response) {
                   location.reload();
                   swal("Planeación Encontrada", "", "success")

               }
            })

        }


    </script>