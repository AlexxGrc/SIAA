@*@model IEnumerable<SIAAPI.Models.Soporte.MensajesSoporte>*@
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@*@Paginación@*@
<script src="~/Scripts/jquery-3.2.1.js" type="text/javascript"></script>
<script type="text/javascript">
    $(function () { // Submit pageSizeForm when another pageSize value is selected
        $("#pageSize").change(function () {
            $("#pageSizeForm").submit();
        });
    });
</script>

@model PagedList.IPagedList<SIAAPI.Models.Soporte.MensajesSoporte>
@using PagedList.Mvc;
<link href="~/Content/PagedList.css" rel="stylesheet" type="text/css" />
@*@Paginación@*@

<h3>Tickets</h3>
<hr />

@*@Busqueda@*@
<nav class="navbar navbar-default">

    <div class="container-fluid">

        <form class="navbar-form navbar-left">

            <div class="form-group">
                @using (Html.BeginForm())
                {

    <p>
        @Html.ActionLink("Crear Ticket", "createMensaje", null, new { @class = "btn btn-warning btn-xs" })
        |
        Elementos por página: @Html.DropDownList("pageSize")  |
        Filtro: @Html.TextBox("SearchString", ViewBag.CurrentFilter as string, new { @placeholder = " Introduce el texto a buscar:" })
        Estado Ticket Soporte: @Html.DropDownList("Status")
        Estado Ticket Cliente @Html.DropDownList("StatusCliente")
        <input type="submit" value="Aplicar" class="btn btn-primary btn-xs" /><span class="sr-only">(current)</span>

    </p>}

            </div>
        </form>
    </div>
</nav>
<br>
@*@Busqueda@*@
<table class="table">
    <tr>
        <th>
            @Html.Label("Ticket")
        </th>
        <th>
            @Html.Label("Fecha")
        </th>
        <th>
            @Html.Label("Mensaje")
        </th>
        <th>
            @Html.Label("Área")
        </th>
        <th>
            @Html.Label("Usuario")

        </th>
        <th>
         @Html.Label("Error se genero por")
        </th>
        <th>
            @Html.Label("Estado Soporte")
        </th>
        <th>
            @Html.Label("Estado Cliente")
        </th>
        <th>
            @Html.Label("Tiempo Estimado Solución")
        </th>

        <th></th>
    </tr>

    @foreach (SIAAPI.Models.Soporte.MensajesSoporte item in Model)
    {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.Id_Ticket)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Fecha_Hora)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Mensaje)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Rol)
            </td>
            <td>
                @{
                    SIAAPI.Models.Login.UserContext us = new SIAAPI.Models.Login.UserContext();
                    SIAAPI.Models.Comercial.ClsDatoString nombre = us.Database.SqlQuery<SIAAPI.Models.Comercial.ClsDatoString>("select UserName as Dato from [User] where UserID= " + item.UserID + "").ToList().FirstOrDefault();
                }
                @Html.Label(nombre.Dato)
            </td>
            <td>
                @if (item.ErrorGeneradoPor == "X")
                {
                    @Html.Label("Aun sin definir")
                }
                @if (item.ErrorGeneradoPor == "U")
                {
                    @Html.Label("Usuario")
                }
                @if (item.ErrorGeneradoPor == "D")
                {
                    @Html.Label("Datos")
                }
                @if (item.ErrorGeneradoPor == "SI")
                {
                    @Html.Label("Sistema")
                }
                @if (item.ErrorGeneradoPor == "SS")
                {
                    @Html.Label("Servidor del Sistema")
                }
                @if (item.ErrorGeneradoPor == "BD")
                {
                    @Html.Label("Gestor de la Base de Datos")
                }
                @if (item.ErrorGeneradoPor == "I")
                {
                    @Html.Label("Servicio de Internet")
                }
                @if (item.ErrorGeneradoPor == "L")
                {
                    @Html.Label("Falla de Luz")
                }
                @if (item.ErrorGeneradoPor == "O")
                {
                    @Html.Label("Otro")
                }
            </td>
            <td>
                @if (item.EstadoTicket == true)
                {
                    @Html.Label("Abierto")

                }
                else
                {
                    @Html.Label("Cerrado")
                }
            </td>
            <td>
                @if (item.CerradoPorCliente == true)
                {
                    @Html.Label("Abierto")
                }
                else
                {
                    @Html.Label("Cerrado")
                }
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.TiempoEstimado)
            </td>

            <td>@Html.ActionLink("Detalles", "Details", new { id = item.Id_Ticket }, new { @class = "btn btn-default btn-xs" })
                @if (item.EstadoTicket == false && item.CerradoPorCliente ==false)
                {

                }
                else
                {
                    @Html.ActionLink("Respuesta", "Respuesta", new { id = item.Id_Ticket }, new { @class = "btn btn-success btn-xs" })
                }


                @if (@Roles.IsUserInRole("Administrador"))
                {
                    @Html.ActionLink("TiempoSol", "EditMensaje", new { id = item.Id_Ticket }, new { @class = "btn btn-info btn-xs" })
                    @Html.ActionLink("Eliminar", "Delete", new { id = item.Id_Ticket }, new { @class = "btn btn-danger btn-xs" })
                }
            </td>
        </tr>
    }

</table>


@*@Paginación@*@
@using (Html.BeginForm("Index", "Soporte", FormMethod.Get, new { id = "pageSizeForm" }))
{
    <div class="pager">
        Página @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) de @Model.PageCount<br />

        @Model.Count de @Model.TotalItemCount elementos

        @Html.PagedListPager(Model, page => Url.Action("Index", new
   {
       page,
       sortOrder = ViewBag.CurrentSort,
       currentFilter = ViewBag.CurrentFilter,
       searchString = ViewBag.CurrentFilter,
       pageSize = ViewBag.psize,
       Status= ViewBag.Statusseleccionado,
       StatusCliente = ViewBag.StatusClienteseleccionado
   }))


    </div>}
@*@Paginación@*@

<script src="~/Scripts/libs/salert/sweetalert.min.js"></script>
<script>

        $(function(){
            $("#Status").on("change", function() {
             @ViewBag.Statusseleccionado=  $('[id$=Status] option:selected').text();

            });
        });
    $(function(){
        $("#StatusCliente").on("change", function() {
         @ViewBag.StatusClienteseleccionado=  $('[id$=StatusCliente] option:selected').text();

        });
    });
</script>

<script>
    function DarSoporte(id) {
        var urledit = '@Url.Action("DarSoporte", "MensajesInternos")';


        $.post(urledit, { id: id }, function (response) {
                    if (response) {
                        location.reload();
                        swal("La factura ha sido cancelada!", "", "success")

                    }
                }).fail(function (response) {
                    swal("La factura no pudo ser cancelada!", "", "error")

                })
            }








</script>