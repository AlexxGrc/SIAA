using System;
using System.IO;
using System.Text;
using System.Linq;
using System.Web;
using System.Web.Mvc;
using SIAAPI.Models.Cfdi;
using SIAAPI.Models.Comercial;
using SIAAPI.ViewModels.Cfdi;
using SIAAPI.Models.Administracion;
using System.Globalization;
using SIAAPI.Facturas;
using System.Collections.Generic;
using PagedList;
using static System.Net.Mime.MediaTypeNames;
using System.Net.Mail;

using SIAAPI.ViewModels.Comercial;
using System.Xml;
using System.Net;
using System.Data.SqlClient;
using SIAAPI.Reportes;
using OfficeOpenXml;
using OfficeOpenXml.Style;
using System.Drawing;
using SIAAPI.clasescfdi;
using static SIAAPI.Models.Comercial.ClienteRepository;
using System.Collections;

namespace SIAAPI.Controllers.Cfdi
{

    [Authorize(Roles = "Administrador,Facturacion,Ventas,Sistemas,Almacenista,Comercial,Gerencia, GerenteVentas")]
    public class FacturaAllController : Controller
    {
        EncfacturaContext db = new EncfacturaContext();
        EncfacturasSaldosContext dbs = new EncfacturasSaldosContext();


        // GET: FacturaComplemento
        public ActionResult Index(string Numero, string SerieFac, string ClieFac, string sortOrder, string currentFilter, int? page, int? PageSize, string Fechainicio, string Fechafinal, string FacPag, string Estado = "A")
        {
            //string ConsultaSql = "select * from Encfacturas ";
            string ConsultaSql = "Select * from dbo.EncfacturasSaldos";
            string cadenaSQl = string.Empty;

            if (SerieFac== null)
            {
                SerieFac = "MX";
            }
            try
            {

                //Buscar Facturas: Pagadas o no pagadas
                var FacPagLst = new List<SelectListItem>();


                var EstadoLst = new List<SelectListItem>();
                //FacPagLst.Add(new SelectListItem { Text = "Todos", Value = "na", Selected = true });

                EstadoLst.Add(new SelectListItem { Text = "Cancelada", Value = "C" });
                EstadoLst.Add(new SelectListItem { Text = "Activas", Value = "A" });

                ViewData["Estado"] = EstadoLst;

                ViewBag.Estado = new SelectList(EstadoLst, "Value", "Text");

                ViewBag.Estadoseleccionado = Estado;  /// mandar el viewbag el parametro que viene de la pagina anterior
                //Facturas Pagadas
                FacPagLst.Add(new SelectListItem { Text = "Pagada", Value = "SI" });
                FacPagLst.Add(new SelectListItem { Text = "NoPagada", Value = "NO" });

                ViewData["FacPag"] = FacPagLst;



                ViewBag.FacPag = new SelectList(FacPagLst, "Value", "Text");

                ViewBag.Facpagseleccionado = FacPag; /// mandar el viewbag el parametro que viene de la pagina anterior

                //Buscar Serie Factura
                var SerLst = new List<string>();
                var SerQry = from d in db.encfacturas
                             orderby d.Serie
                             select d.Serie;

                SerLst.AddRange(SerQry.Distinct());

                ViewBag.SerieFac = new SelectList(SerLst);

                ViewBag.SerieFacseleccionado = SerieFac; /// mandar el viewbag el parametro que viene de la pagina anterior

                ViewBag.sumatoria = "";

                //Buscar Cliente
                //var ClieLst = new List<string>();
                //var ClieQry = from d in db.encfacturas
                //              orderby d.Nombre_cliente
                //              select d.Nombre_cliente;
                //ClieLst.AddRange(ClieQry.Distinct());

                ViewBag.ClieFac = new ClienteRepository().GetClientesFactura();

                ViewBag.ClieFacseleccionado = ClieFac;/// mandar el viewbag el parametro que viene de la pagina anterior


                //string ConsultaSqlResumen = "select Moneda as MonedaOrigen, (SUM(Subtotal)) as Subtotal, (SUM(IVA)) as IVA, (SUM(Total)) as Total, (SUM(Total * TC)) as TotalenPesos from encfacturas ";
                string ConsultaSqlResumen = "select Moneda as MonedaOrigen, (SUM(Subtotal)) as Subtotal, (SUM(IVA)) as IVA, (SUM(Total)) as Total, (SUM(Total * TC)) as TotalenPesos from EncfacturasSaldos ";
                string ConsultaAgrupado = "group by Moneda order by Moneda ";
                string Filtro = string.Empty;



                string Orden = " order by fecha desc , serie , numero desc ";

                ///tabla filtro: serie
                if (!String.IsNullOrEmpty(SerieFac))
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Serie='" + SerieFac + "'";
                    }
                    else
                    {
                        Filtro += "and  Serie='" + SerieFac + "'";
                    }

                }

                if (String.IsNullOrEmpty(SerieFac))
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Serie=''";
                    }
                    else
                    {
                        Filtro += "and  Serie=''";
                    }

                }
                //Buscar por numero
                if (!String.IsNullOrEmpty(Numero))
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Numero=" + Numero + "";
                    }
                    else
                    {
                        Filtro += "and  Numero=" + Numero + "";
                    }

                }

                ///tabla filtro: Nombre Cliente
                if (!String.IsNullOrEmpty(ClieFac))
                {

                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Nombre_cliente='" + ClieFac + "'";
                    }
                    else
                    {
                        Filtro += "and  Nombre_cliente='" + ClieFac + "'";
                    }

                }

                ///tabla filtro: Factura pagada/no pagada && Serie, Nombre Cliente
                if (FacPag != "Todas")
                {
                    if (FacPag == "SI")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where pagada='1' ";
                        }
                        else
                        {
                            Filtro += "and  pagada='1' ";
                        }
                    }
                    if (FacPag == "NO")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where pagada='0' ";
                        }
                        else
                        {
                            Filtro += "and  pagada='0' ";
                        }
                    }
                }


                if (Estado != "Todos")
                {
                    if (Estado == "C")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where Estado='C'";
                        }
                        else
                        {
                            Filtro += "and  Estado='C'";
                        }
                    }
                    if (Estado == "A")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where  Estado='A'";
                        }
                        else
                        {
                            Filtro += "and Estado='A'";
                        }
                    }
                }



                if (!String.IsNullOrEmpty(Fechainicio) && String.IsNullOrEmpty(Fechafinal)) //pusieron una fecha
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where  Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechainicio + " 23:59:59.999' ";
                    }
                    else
                    {
                        Filtro += " and Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechainicio + " 23:59:59.999'";
                    }
                }


                if (!String.IsNullOrEmpty(Fechainicio) && !String.IsNullOrEmpty(Fechafinal)) //pusieron una fecha
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where  Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechafinal + " 23:59:59.999' ";
                    }
                    else
                    {
                        Filtro += " and Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechafinal + " 23:59:59.999'";
                    }
                }


                ViewBag.CurrentSort = sortOrder;
                ViewBag.SerieSortParm = String.IsNullOrEmpty(sortOrder) ? "Serie" : "";
                ViewBag.NumeroSortParm = String.IsNullOrEmpty(sortOrder) ? "Numero" : "";
                ViewBag.FechaSortParm = sortOrder == "Fecha" ? "Fecha" : "";
                ViewBag.ClienteSortParm = String.IsNullOrEmpty(sortOrder) ? "Nombre_Cliente" : "";




                // Pass filtering string to view in order to maintain filtering when paging
                ViewBag.Fechainicio = Fechainicio;
                ViewBag.Fechafinal = Fechafinal;

                ////Paginación
                //if (Fechainicio != null)
                //{
                //    page = 1;
                //}
                //else
                //{
                //    Fechainicio = currentFilter;
                //}

                //ViewBag.CurrentFilter = Fechainicio;


                //Ordenacion

                switch (sortOrder)
                {
                    case "Activa":
                        Orden = " order by  Estado ";
                        break;
                    case "Serie":
                        Orden = " order by  serie , numero desc ";
                        break;
                    case "Numero":
                        Orden = " order by   numero asc ";
                        break;
                    case "Fecha":
                        Orden = " order by fecha ";
                        break;
                    case "Nombre_Cliente":
                        Orden = " order by  Nombre_cliente ";
                        break;
                    default:
                        Orden = " order by fecha desc , serie , numero desc ";
                        break;
                }


                // si no ha seleccionado nada muestra las facturas del ultimo mes 

                if (Filtro == " where  Estado='A'")
                {
                    Filtro += " and Fecha >='" + DateTime.Now.AddDays(-30).Year + "-" + DateTime.Now.AddDays(-30).Month + "-" + DateTime.Now.AddDays(-30).Day + "'  and  Fecha<'" + DateTime.Now.AddDays(1).Year + "-" + DateTime.Now.AddDays(1).Month + "-" + DateTime.Now.AddDays(1).Day + "' ";
                    ViewBag.Fechainicio = "" + DateTime.Now.AddDays(-30).Year + "-" + DateTime.Now.AddDays(-30).Month + "-" + DateTime.Now.AddDays(-30).Day + "";
                    ViewBag.Fechafinal = "" + DateTime.Now.Year + "-" + DateTime.Now.Month + "-" + DateTime.Now.Day + "";
                }

                //var elementos = from s in db.encfacturas
                //select s;

                cadenaSQl = ConsultaSql + " " + Filtro + " " + Orden;

                //var elementos = db.Database.SqlQuery<Encfacturas>(cadenaSQl).ToList();
                var elementos = dbs.Database.SqlQuery<EncfacturasSaldos>(cadenaSQl).ToList();


                ViewBag.sumatoria = "";
                try
                {

                    var SumaLst = new List<string>();
                    var SumaQry = ConsultaSqlResumen + " " + Filtro + " " + ConsultaAgrupado;
                    List<ResumenFac> data = db.Database.SqlQuery<ResumenFac>(SumaQry).ToList();
                    ViewBag.sumatoria = data;

                }
                catch (Exception err)
                {
                    string mensaje = err.Message;
                }

                //Paginación
                // DROPDOWNLIST FOR UPDATING PAGE SIZE
                //int count = db.Encfacturas.OrderBy(e => e.Serie).Count();// Total number of elements
                int count = elementos.Count();// Total number of elements
                // Populate DropDownList
                ViewBag.PageSize = new List<SelectListItem>()
            {
                new SelectListItem { Text = "10", Value = "10" },
                new SelectListItem { Text = "25", Value = "25" , Selected = true},
                new SelectListItem { Text = "50", Value = "50" },
                new SelectListItem { Text = "100", Value = "100" },
                new SelectListItem { Text = "Todos", Value = count.ToString() }
             };

                int pageNumber = (page ?? 1);
                int pageSize = (PageSize ?? 25);
                ViewBag.psize = pageSize;


                return View(elementos.ToPagedList(pageNumber, pageSize));
                //Paginación
            }
            catch(Exception err)
            {
                string mensaje = err.Message;

                var reshtml = Server.HtmlEncode(cadenaSQl);

                return Content(reshtml);
            }
        }

        public void FacturacionAnoVsAnterior()
        {
            EncfacturaContext db = new EncfacturaContext();
            ClsDatoEntero anoactual = db.Database.SqlQuery<ClsDatoEntero>("select year(getdate()) as Dato").ToList()[0];
            ClsDatoEntero anoanterior = db.Database.SqlQuery<ClsDatoEntero>("select (year(getdate())-1) as Dato").ToList()[0];
            ClsDatoEntero mesact = db.Database.SqlQuery<ClsDatoEntero>("select (month(getdate())+1) as Dato").ToList()[0];
            var cadEjecini = "update DiferenciaFac set AnoActualMXN = 0, AnoActualUSD = 0, AnoActualTotMXN = 0, AnoAnteriorMXN = 0, AnoAnteriorUSD = 0, AnoAnteriorTotMXN = 0";
            db.Database.ExecuteSqlCommand(cadEjecini);

            DateTime fecAct = DateTime.Today;
            string FA = fecAct.ToString("dd/MM/yyyy");

            List<c_Moneda> monedamxn = db.Database.SqlQuery<c_Moneda>("select * from c_Moneda WHERE ClaveMoneda='MXN'").ToList();
            int mxn = monedamxn.Select(s => s.IDMoneda).FirstOrDefault();
            List<c_Moneda> monedausd = db.Database.SqlQuery<c_Moneda>("select * from c_Moneda WHERE ClaveMoneda='USD'").ToList();
            int usd = monedausd.Select(s => s.IDMoneda).FirstOrDefault();
            string cadena = "";
            decimal AcMXN = 0;
            decimal AcUSD = 0;
            decimal AcTot = 0;
            decimal AnMXN = 0;
            decimal AnUSD = 0;
            decimal AnTot = 0;

            //Actualizo la tabla con los datos de los totales de la suma de los pedidos del año actual y el año anterior
            int n = 1;

            while (n < 13)
            {
                //Año actual
                ClsDatoEntero ActExisten = db.Database.SqlQuery<ClsDatoEntero>("select count(*) as Dato from EncFacturas where year(Fecha) = " + anoactual.Dato + " and month(Fecha)  = " + n + "").ToList()[0];
                if (ActExisten.Dato != 0)
                {
                    var cadMXNAct = "select case WHEN sum(Total) IS NULL THEN (0) ELSE sum(Total) END AS Dato from EncFacturas where Estado != 'C'  and year(Fecha) = " + anoactual.Dato + " and month(Fecha)  = " + n + " and IDMoneda = " + mxn + "";
                    var cadUSDAct = "select case WHEN sum(Total) IS NULL THEN (0) ELSE sum(Total) END AS Dato from EncFacturas where Estado != 'C' and year(Fecha) = " + anoactual.Dato + " and month(Fecha)  = " + n + " and IDMoneda = " + usd + "";
                    var cadtotAct = "select case WHEN sum(Total*TC) IS NULL THEN (0) ELSE sum(Total*TC) END AS Dato from EncFacturas where Estado != 'C' and year(Fecha) = " + anoactual.Dato + " and month(Fecha)  = " + n + " ";
                    ClsDatoDecimal ActMXN = db.Database.SqlQuery<ClsDatoDecimal>(cadMXNAct).ToList().FirstOrDefault();
                    ClsDatoDecimal ActUSD = db.Database.SqlQuery<ClsDatoDecimal>(cadUSDAct).ToList().FirstOrDefault();
                    ClsDatoDecimal ActTot = db.Database.SqlQuery<ClsDatoDecimal>(cadtotAct).ToList().FirstOrDefault();
                    AcMXN = ActMXN.Dato;
                    AcUSD = ActUSD.Dato;
                    AcTot = ActTot.Dato;
                }
                else
                {
                    AcMXN = 0;
                    AcUSD = 0;
                    AcTot = 0;
                }
                //Año anterior
                ClsDatoEntero AntExisten = db.Database.SqlQuery<ClsDatoEntero>("select count(*) as Dato from EncFacturas where year(Fecha) = " + anoanterior.Dato + " and month(Fecha)  = " + n + "").ToList()[0];
                if (AntExisten.Dato != 0)
                {
                    var cadMXNAnt = "select case WHEN sum(Total) IS NULL THEN (0) ELSE sum(Total) END AS Dato from EncFacturas where Estado != 'C' and year(Fecha) = " + anoanterior.Dato + " and month(Fecha)  = " + n + " and IDMoneda = " + mxn + "";
                    var cadUSDAnt = "select case WHEN sum(Total) IS NULL THEN (0) ELSE sum(Total) END AS Dato from EncFacturas where Estado != 'C' and year(Fecha) = " + anoanterior.Dato + " and month(Fecha)  = " + n + " and IDMoneda = " + usd + "";
                    var cadtotAnt = "select case WHEN sum(Total*TC) IS NULL THEN (0) ELSE sum(Total*TC) END AS Dato from EncFacturas where Estado != 'C' and year(Fecha) = " + anoanterior.Dato + " and month(Fecha)  = " + n + " ";
                    ClsDatoDecimal AntMXN = db.Database.SqlQuery<ClsDatoDecimal>(cadMXNAnt).ToList().FirstOrDefault();
                    ClsDatoDecimal AntUSD = db.Database.SqlQuery<ClsDatoDecimal>(cadUSDAnt).ToList().FirstOrDefault();
                    ClsDatoDecimal AntTot = db.Database.SqlQuery<ClsDatoDecimal>(cadtotAnt).ToList().FirstOrDefault();
                    AnMXN = AntMXN.Dato;
                    AnUSD = AntUSD.Dato;
                    AnTot = AntTot.Dato;
                }
                else
                {
                    AnMXN = 0;
                    AnUSD = 0;
                    AnTot = 0;
                }

                // Se actualizan los valores de la tabla
                var cadEjec = "update DiferenciaFac set AnoActualMXN = " + AcMXN + ", AnoActualUSD = " + AcUSD + ", AnoActualTotMXN = " + AcTot + "";
                cadEjec += ", AnoAnteriorMXN = " + AnMXN + ", AnoAnteriorUSD = " + AnUSD + ", AnoAnteriorTotMXN = " + AnTot + " ";
                cadEjec += "where IDMes = " + n + "";
                db.Database.ExecuteSqlCommand(cadEjec);

                ////Diferencia Año Actual - Año Anterior
                //var caddif = "select (AnoActualTotMXN - AnoAnteriorTotMXN) as Dato from DiferenciaPed where IDMes = " + n + "";
                //ClsDatoDecimal difMXN = db.Database.SqlQuery<ClsDatoDecimal>(caddif).ToList()[0];
                //var cadEjecDif = "update DiferenciaPed set DiferenciaMXN =" + difMXN.Dato + " where IDMes = " + n + "";
                //db.Database.ExecuteSqlCommand(cadEjecDif);

                n++;
            }
            //Diferencia Año Actual - Año Anterior
            //var cadEjecDif = "update DiferenciaPed set DiferenciaMXN = (AnoActualTotMXN - AnoAnteriorTotMXN)";
            //db.Database.ExecuteSqlCommand(cadEjecDif);


            // Cargo los datos actualizados para el reporte
            cadena = "select * from DiferenciaFac ";
            var datos = db.Database.SqlQuery<DiferenciaFac>(cadena).ToList();
            ViewBag.datos = datos;


            ExcelPackage Ep = new ExcelPackage();
            //Crear la hoja y poner el nombre de la pestaña del libro
            var Sheet = Ep.Workbook.Worksheets.Add("Facturas");

            // en la fila1 formateo las celdas y coloco el título de la hoja
            // RichText permite agregar las propiedades de tipo de letra: color, negrita, etc.
            int row = 1;
            //Fijar la fuente para A1:Q1
            Sheet.Cells["A1:I1"].Style.Font.Size = 20;
            Sheet.Cells["A1:I1"].Style.Font.Name = "Calibri";
            Sheet.Cells["A1:I3"].Style.Font.Bold = true;
            Sheet.Cells["A1:I1"].Style.Font.Color.SetColor(Color.DarkBlue);
            Sheet.Cells["A1:I1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
            Sheet.Cells["A1"].RichText.Add("Facturación Año Actual vs Año Anterior");

            row = 2;
            Sheet.Cells["A1:I1"].Style.Font.Size = 12;
            Sheet.Cells["A1:I1"].Style.Font.Name = "Calibri";
            Sheet.Cells["A1:I1"].Style.Border.Bottom.Style = ExcelBorderStyle.Hair;
            Sheet.Cells["A2:I2"].Style.Font.Bold = true;
            //Subtitulo según el filtrado del periodo de datos
            row = 2;
            Sheet.Cells[string.Format("A2", row)].Value = "Fecha Reporte";
            Sheet.Cells[string.Format("C2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
            Sheet.Cells[string.Format("C2", row)].Value = fecAct;

            //En la fila3 se da el formato a el encabezado
            row = 3;
            Sheet.Cells.Style.Font.Name = "Calibri";
            Sheet.Cells.Style.Font.Size = 10;
            Sheet.Cells["A3:I3"].Style.Font.Bold = true;
            Sheet.Cells["A3:I3"].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
            Sheet.Cells["A3:I3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

            // Se establece el nombre que identifica a cada una de las columnas de datos. 
            Sheet.Cells["C3:E3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
            Sheet.Cells["C3:E3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.Goldenrod);
            Sheet.Cells[string.Format("C3", row)].Value = anoactual.Dato;

            Sheet.Cells["F3:H3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
            Sheet.Cells["F3:H3"].Style.Font.Color.SetColor(Color.White);
            Sheet.Cells["F3:H3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.MidnightBlue);
            Sheet.Cells[string.Format("F3", row)].Value = anoanterior.Dato;
            //Aplicar borde doble al rango de celdas A3:Q3
            Sheet.Cells["C3:H3"].Style.Border.Bottom.Style = ExcelBorderStyle.Double;


            row = 4;
            Sheet.Cells.Style.Font.Name = "Calibri";
            Sheet.Cells.Style.Font.Size = 10;
            Sheet.Cells["A4:I4"].Style.Font.Bold = true;
            Sheet.Cells["A4:I4"].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
            Sheet.Cells["A4:I4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
            Sheet.Cells["C4:E4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.PaleGoldenrod);
            Sheet.Cells["F4:H4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.PowderBlue);
            // Se establece el nombre que identifica a cada una de las columnas de datos.
            Sheet.Cells["A4"].RichText.Add("No");
            Sheet.Cells["B4"].RichText.Add("Mes");
            Sheet.Cells["C4"].RichText.Add("MXN");
            Sheet.Cells["D4"].RichText.Add("USD");
            Sheet.Cells["E4"].RichText.Add("Total MXN");
            Sheet.Cells["F4"].RichText.Add("MXN");
            Sheet.Cells["G4"].RichText.Add("USD");
            Sheet.Cells["H4"].RichText.Add("Total MXN");
            Sheet.Cells["I4"].RichText.Add("TotalMXN(AñoActual - AñoAnterior)");

            //Aplicar borde doble al rango de celdas A3:Q3
            Sheet.Cells["A4:I4"].Style.Border.Bottom.Style = ExcelBorderStyle.Double;

            // en la fila4, el foreach llenara cada fila de la hoja de excel, con cada fila que trae de la bd.
            // Se establecen los formatos para las celdas: Fecha, Moneda
            row = 5;
            Sheet.Cells.Style.Font.Bold = false;
            foreach (DiferenciaFac item in ViewBag.datos)
            {
                Sheet.Cells[string.Format("A{0}", row)].Value = item.IDMes;
                Sheet.Cells[string.Format("B{0}", row)].Value = item.Mes;
                Sheet.Cells[string.Format("C{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("C{0}", row)].Value = item.AnoActualMXN;
                Sheet.Cells[string.Format("D{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("D{0}", row)].Value = item.AnoActualUSD;
                Sheet.Cells[string.Format("E{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("E{0}", row)].Value = item.AnoActualTotMXN;
                Sheet.Cells[string.Format("F{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("F{0}", row)].Value = item.AnoAnteriorMXN;
                Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("G{0}", row)].Value = item.AnoAnteriorUSD;
                Sheet.Cells[string.Format("H{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("H{0}", row)].Value = item.AnoAnteriorTotMXN;
                Sheet.Cells[string.Format("I{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("I{0}", row)].Value = item.AnoActualTotMXN - item.AnoAnteriorTotMXN;
                row++;
            }

            //Se genera el archivo y se descarga
            Sheet.Cells["A:AZ"].AutoFitColumns();
            Response.Clear();
            Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
            Response.AddHeader("content-disposition", "attachment: filename=" + "FacturacionAnoVsAnterior.xlsx");
            Response.BinaryWrite(Ep.GetAsByteArray());
            Response.End();
            //return Redirect("/blah");
        }
        public void Descargarxml(int id)
        {
            // Obtener contenido del archivo
            var elemento = db.encfacturas.Single(m => m.ID == id);

            System.Web.HttpContext.Current.Response.Buffer = true;
            System.Web.HttpContext.Current.Response.Clear();
            System.Web.HttpContext.Current.Response.AddHeader("content-disposition", "attachment; filename=Factura-" + elemento.Serie+ elemento.Numero +".Xml");
            System.Web.HttpContext.Current.Response.WriteFile(System.Web.HttpContext.Current.Server.MapPath("~/Xmlfacturas/"+ elemento.UUID + ".Xml"));

        }                                              


        


        public ActionResult DescargarPdf(int id)
        {
            // Obtener contenido del archivo
            var elemento = db.encfacturas.Single(m => m.ID == id);



            string rutaArchivo = elemento.UUID + ".xml";
            string fileName = System.Web.HttpContext.Current.Server.MapPath("~/Xmlfacturas/" + rutaArchivo);
            string xmlString = System.IO.File.ReadAllText(fileName);

            //Console.WriteLine("Esto es mi mensaje : entre aqui" );
            // toma la empresa que tenga el id 1 via de mientras 
            var empresa = db.Empresa.Single(m => m.IDEmpresa == 2);

            System.Drawing.Image logoempresa = byteArrayToImage(empresa.Logo);



            List<EncPrefactura> prefactura = new PrefacturaContext().Database.SqlQuery<EncPrefactura>("select * from encprefactura where Seriedigital='" + elemento.Serie + "' and [NumeroDigital]=" + elemento.Numero ).ToList();
            Generador.CreaPDF documento = null;
            string contentType = System.Net.Mime.MediaTypeNames.Application.Pdf;
            if (prefactura.Count==0 || elemento.NotaCredito==true)  /// checa prefactura
            {
                documento = new Generador.CreaPDF(xmlString, logoempresa, "Tel. " + empresa.Telefono + " " + empresa.mail, true);
              
                return new FilePathResult(documento.nombreDocumento, contentType);
            }
            else
            {
                EncPrefactura prefact = prefactura[0];
                documento = new Generador.CreaPDF(xmlString, logoempresa, prefact, "Tel. " + empresa.Telefono +" " + empresa.mail, true);
              
                return new FilePathResult(documento.nombreDocumento, contentType);
            }

        }

       


        public ActionResult EnviarPdf(int id)
        {
            // Obtener contenido del archivo
            var elemento = db.encfacturas.Single(m => m.ID == id);

            Clientes Cliente = null;

            try
            {

                ClsDatoEntero idcliente = db.Database.SqlQuery<ClsDatoEntero>("select IDCliente as Dato from [dbo].[Clientes] where Nombre='" + elemento.Nombre_cliente + "'").ToList()[0];

                ClientesContext clientes = new ClientesContext();
                Cliente = clientes.Clientes.Find(idcliente.Dato);
            }

            catch(Exception err)
            {
                string error = err.Message;
                Cliente = null;
            }

            try
            {
                if (string.IsNullOrEmpty(Cliente.CorreoCfdi))
                {
                    var reshtml = Server.HtmlEncode("No hay correo cfdi registrado o no existe registro del cliente");

                    return Content(reshtml);
                }
            }
            catch(Exception err)
            {

                string error = err.Message;
                var reshtml = Server.HtmlEncode("No hay correo cfdi registrado o no existe registro del cliente ");

                return Content(reshtml);

            }

            string rutaArchivo = elemento.UUID + ".xml";
            string fileName=    System.Web.HttpContext.Current.Server.MapPath("~/Xmlfacturas/" + rutaArchivo);
            string xmlString = System.IO.File.ReadAllText(fileName);

         
            //Console.WriteLine("Esto es mi mensaje : entre aqui" );
            // toma la empresa que tenga el id 1 via de mientras 
            var empresa = db.Empresa.Single(m => m.IDEmpresa == 2);

            System.Drawing.Image logoempresa = byteArrayToImage(empresa.Logo);


            List<EncPrefactura> prefactura = new PrefacturaContext().Database.SqlQuery<EncPrefactura>("select * from encprefactura where Seriedigital='" + elemento.Serie + "' and [NumeroDigital]=" + elemento.Numero).ToList();
            Generador.CreaPDF documento = null;
            string contentType = System.Net.Mime.MediaTypeNames.Application.Pdf;

            if (prefactura.Count == 0)  /// checa prefactura
            {
                documento = new Generador.CreaPDF(xmlString, logoempresa, "Tel. " + empresa.Telefono + " " + empresa.mail, false);

            
            }
            else
            {
                EncPrefactura prefact = prefactura.FirstOrDefault();
                documento = new Generador.CreaPDF(xmlString, logoempresa, prefact, "Tel. " + empresa.Telefono + " " + empresa.mail, true);

             
            }




        //    Generador.CreaPDF documento = new Generador.CreaPDF(xmlString, logoempresa, "Tel. " + empresa.Telefono +" " + empresa.mail, false);

            string correo = string.Empty;
            string password = string.Empty;
            string correofirma = string.Empty;
            string servidor = "smtp.gmail.com";
            int puerto = 587;
            string nombrecorreo = empresa.RazonSocial;
            string asunto = "Factura";
            string titulo = "Gracias por su preferencia  ";
            string cuerpo = "Adjuntamos su factura electronica";
            string firma = "Si tiene alguna duda o comentario no replique este mail, favor de escribir a";
            string copiaoculta = string.Empty;

            XmlDocument xmail = new XmlDocument();
           xmail.Load(System.Web.HttpContext.Current.Server.MapPath("~/configcorreofactura.xml"));
           

                XmlNode mailnode = xmail.FirstChild;
                try
                {
                foreach (XmlNode elementomail in mailnode.ChildNodes)
                {
                    
                    if (elementomail.Name=="correo")
                        {
                            correo = elementomail.InnerText;
                        }
                        if (elementomail.Name == "password")
                    {
                        password = elementomail.InnerText;
                    }
                    if (elementomail.Name == "CorreofirmaFactura")
                    {
                        correofirma = elementomail.InnerText;
                    }
                    if (elementomail.Name == "servidor")
                    {
                        servidor = elementomail.InnerText;
                    }

                    if (elementomail.Name == "puerto")
                    {
                        puerto = Int32.Parse( elementomail.InnerText);
                    }

                    if (elementomail.Name == "nombre")
                    {
                        nombrecorreo = elementomail.InnerText;
                    }

                    if (elementomail.Name == "asunto")
                    {
                        asunto = elementomail.InnerText;
                    }

                    if (elementomail.Name == "titulo")
                    {
                        titulo = elementomail.InnerText;
                    }
                    if (elementomail.Name == "cuerpo")
                    {
                        cuerpo = elementomail.InnerText;
                    }
                    if (elementomail.Name == "copiaoculta")
                    {
                        copiaoculta = elementomail.InnerText;
                    }

                    
                }
                }
                catch (Exception err)
                {
                    string error = err.Message;
                }



            try
            {


                SmtpClient mySmtpClient = new SmtpClient();

                // set smtp-client with basicAuthentication
                mySmtpClient.UseDefaultCredentials = false;
                System.Net.NetworkCredential basicAuthenticationInfo = new System.Net.NetworkCredential(correo, password);
                mySmtpClient.Credentials = basicAuthenticationInfo;
                mySmtpClient.Host = servidor;
                mySmtpClient.Port = puerto;
                mySmtpClient.EnableSsl = false;
                mySmtpClient.DeliveryMethod = SmtpDeliveryMethod.Network;

                // add from,to mailaddresses
                MailAddress from = new MailAddress(correo, nombrecorreo);
                // MailAddress to = new MailAddress(Cliente.CorreoCfdi, elemento.Nombre_cliente);

                Cliente.CorreoCfdi.Replace(';', ',');
                string[] mails = Cliente.CorreoCfdi.Split(',');


                if (mails.Length == 0)
                {
                    throw new Exception("No hay Correos registrados");
                }


                MailAddress to = new MailAddress(mails[0], elemento.Nombre_cliente);
                MailMessage myMail = new MailMessage(from, to);


                if (mails.Length > 1)
                {
                    for (int it = 1; it <= mails.Length - 1; it++)
                    {
                        myMail.CC.Add(mails[it]);
                    }
                }
                //Con copia a 
                myMail.Bcc.Add(copiaoculta);


                // set subject and encoding
                myMail.Subject = asunto;
                myMail.SubjectEncoding = Encoding.UTF8;


                System.Text.StringBuilder sb = new System.Text.StringBuilder();

                sb.Append("<html>");
                sb.Append("<head><title>" + titulo +"</title></ head >");

                sb.Append("</head>");
                sb.Append("<body>");
                sb.Append("<h4>" + cuerpo+ " " + elemento.Serie + elemento.Numero + " del dia " + elemento.Fecha.ToShortDateString() + " </h4>");
                sb.Append("<h6>" + firma + "</h6 >" + correofirma);

                sb.Append("</body></html>");
                // set body-message and encoding
                myMail.Body = sb.ToString();
                //_memoryStream.Position = 0;
                myMail.Attachments.Add(new Attachment(documento.nombreDocumento));

                string archivoxml = System.Web.HttpContext.Current.Server.MapPath("~/Xmlfacturas/" + elemento.UUID + ".xml");
                myMail.Attachments.Add(new Attachment(archivoxml));


                myMail.BodyEncoding = Encoding.UTF8;
                // text or html
                myMail.IsBodyHtml = true;

                mySmtpClient.Send(myMail);
           
            
            }
            catch (Exception err)
            {
                return Content("<html><body><h2>tu mail no se ha enviado</h2><div>"+err.Message+"</div></body></html>", "text/html");
            }
            //   return RedirectToAction("Index");
            return Content("<html><body>tu mail se ha enviado correctamente</body></html>", "text/html");
            //return File(nombrededocumento, "application / pdf", nombrededocumento); 
        }

     
        public ActionResult ValidarClie()
        {
           
           
            string querySQL2 = "update dbo.EncFacturas set IDCliente = t2.IDCliente from dbo.EncFacturas t1, dbo.Clientes as t2  where t1.Nombre_Cliente = t2.Nombre";
            db.Database.ExecuteSqlCommand(querySQL2);

           

            return RedirectToAction("Index");
        }

        public ActionResult CreatedesdeArchivo()
        {
            return View();
        }

       
        [HttpPost]
        public ActionResult CreatedesdeArchivo(FormCollection collection)
        {
            Encfacturas elemento = new Encfacturas();

            try
            {
                /*Aqui voy intentar guardar la imagen que me pase la vista*/
                try
                {
                    HttpPostedFileBase archivo = Request.Files["Imag1"];
                    //archivo.SaveAs(Path.Combine(directory, Path.GetFileName(archivo.FileName)));
                    // Generador.CreaPDF(Path.Combine(@".\facturas", Path.GetFileName(archivo.FileName)));
                    StreamReader reader = new StreamReader(archivo.InputStream);
                    String contenidoxml = reader.ReadToEnd();


                    Generador.CreaPDF temp = new Generador.CreaPDF(contenidoxml);


                    try
                    {
                        EncfacturaContext dbp = new EncfacturaContext();
                        Encfacturas proveedorenlabase = dbp.Database.SqlQuery<Encfacturas>("select * from Encfacturas where UUID='" + temp._templatePDF.folioFiscalUUID + "'").ToList()[0];
                        int IDpbase = proveedorenlabase.ID; /// si la consulta no devolvio fila lanazara una excepcion 
                        string mensajealusuario = "LA FACTURA YA SE ENCUENTRA EN EL SISTEMA ";
                        ViewBag.Mensajeerror = mensajealusuario;
                        return View();
                    }
                    catch (Exception err)
                    {
                        //string error = err.Message;
                        String mensaje = err.Message;

                    }


                    elemento.Fecha = System.DateTime.Parse(temp._templatePDF.fechaEmisionCFDI);
                    elemento.Serie = temp._templatePDF.serie;
                    elemento.Numero = Int32.Parse(temp._templatePDF.folio);
                    elemento.Nombre_cliente = temp._templatePDF.receptor.razonSocial;
                    elemento.Subtotal = decimal.Parse(temp._templatePDF.subtotal.ToString());
                    elemento.Total = decimal.Parse(temp._templatePDF.total.ToString());
                    elemento.IVA = elemento.Total - elemento.Subtotal;

                    int idcliente = 0;

                    try
                    {
                        ClsDatoEntero clientecapturado = db.Database.SqlQuery<ClsDatoEntero>("select IDCLIENTE AS dato from clientes NOMBRE='" + elemento.Nombre_cliente + "'").ToList()[0];
                        idcliente = clientecapturado.Dato;
                    }

                    catch
                    {

                    }

                    List<c_Moneda> clavemoneda;
                    clavemoneda = db.Database.SqlQuery<c_Moneda>("select * from c_Moneda WHERE claveMoneda='" + temp._templatePDF.claveMoneda + "'").ToList();
                    int clave = clavemoneda.Select(s => s.IDMoneda).FirstOrDefault();
                    elemento.IDMoneda = clave;
                    elemento.Moneda = temp._templatePDF.claveMoneda;
                    elemento.Estado = "A";
                    elemento.TC = decimal.Parse(temp._templatePDF.tipo_cambio);
                    elemento.IDCliente = idcliente;
                    // elemento.RutaXML = contenidoxml;

                    elemento.FechaRevision= System.DateTime.Parse(temp._templatePDF.fechaEmisionCFDI);
                    elemento.FechaVencimiento = System.DateTime.Parse(temp._templatePDF.fechaEmisionCFDI);

                    elemento.Anticipo = false;
                        if (temp._templatePDF.productos.Count==1 && temp._templatePDF.productos[0].desc.Contains("Anticipo") && temp._templatePDF.TipoDecomprobrante=="I")
                    {
                        elemento.Anticipo = true;
                    }
                    elemento.NotaCredito = false;
                    if (temp._templatePDF.productos.Count == 1 && (temp._templatePDF.TipoDeRelacion=="01" || temp._templatePDF.TipoDeRelacion == "03") && temp._templatePDF.TipoDecomprobrante == "E")
                    {
                        elemento.NotaCredito = true;
                    }


                    elemento.RutaXML = "";

                  
                    elemento.UUID = temp._templatePDF.folioFiscalUUID;

                    try
                    {
                        EscribeEnArchivo(contenidoxml, elemento.UUID + ".xml", true);
                    }
                    catch(Exception err)
                    {
                        string mensaje = err.Message;
                    }



                    elemento.IDMetododepago = temp._templatePDF.metodoPago;

                  
                    elemento.ConPagos = false;

                    db.encfacturas.Add(elemento);
                    db.SaveChanges();
                    return RedirectToAction("Index");
                }
                catch (Exception ERR)
                {
                    ViewBag.Mensajeerror = ERR.InnerException.Message;
                    return View();
                }

              
            }
            catch(Exception ERR2)
            {
                string Mensaje = ERR2.Message;
                ViewBag.Mensajeerror = "Este archivo Xml no contiene una factura valida";
                return View();
            }
        }


        public System.Drawing.Image byteArrayToImage(byte[] byteArrayIn)
        {
            System.Drawing.Image returnImage = null;
            try
            {
                MemoryStream ms = new MemoryStream(byteArrayIn, 0, byteArrayIn.Length);
                ms.Write(byteArrayIn, 0, byteArrayIn.Length);
                returnImage = System.Drawing.Image.FromStream(ms, true);//Exception occurs here
            }
            catch { }
            return returnImage;
            
        }

        public ActionResult Darpagada(int id)
        {
            Encfacturas factura = new EncfacturaContext().encfacturas.Find(id);
            try
            {
                new EncfacturaContext().Database.ExecuteSqlCommand("update encfacturas set pagada='1' where id=" + id);
                new EncfacturaContext().Database.ExecuteSqlCommand("update saldofactura importesaldoinsoluto=0 , importepagado=total where idfactura=" + id);   

            }
            catch(Exception err)
            {

            }
            return RedirectToAction("Index", new { Numero = factura.Numero, SerieFac = factura.Serie });
        }


        [HttpPost]
        public JsonResult cancelarFactura(int id)
        {
            var elemento = db.encfacturas.Find(id);

            //var stream = new MemoryStream(Encoding.ASCII.GetBytes(elemento.RutaXML));
            //StreamReader reader = new StreamReader(stream);
            //String contenidoxml = reader.ReadToEnd();

            string rutaArchivo = elemento.UUID + ".xml";
            string fileName = System.Web.HttpContext.Current.Server.MapPath("~/Xmlfacturas/" + rutaArchivo);
            string xmlString = elemento.RutaXML;

            String cadenaxml = System.Web.HttpContext.Current.Server.MapPath("~/Documentostemporales/cancelar.xml");

            StreamWriter sw = new StreamWriter(cadenaxml, true);

            sw.Write(xmlString);
            sw.Close();

              Generador.CreaPDF temp = new Generador.CreaPDF(xmlString);
            
            
           
            try
            {


                bool salida = new ClsFactura().cancelarbyid(temp._templatePDF.folioFiscalUUID, xmlString);


                if (salida)
                {
                    //   MultiFacturasSDK.SDKRespuesta respuesta = new ClsFactura().Cancelarxsdk(elemento.UUID, temp._templatePDF.emisor.rfc );

                    if (temp._templatePDF.UUIDrelacionados.Count() > 0 && (temp._templatePDF.TipoDeRelacion == "03" || temp._templatePDF.TipoDeRelacion == "01"))
                    {
                        try
                        {
                            string folio = temp._templatePDF.UUIDrelacionados[0].UUID;
                            decimal total = temp._templatePDF.total;
                            Encfacturas factura = new EncfacturaContext().encfacturas.Where(s => s.UUID == folio).FirstOrDefault();
                            new EncfacturaContext().Database.ExecuteSqlCommand("update saldofactura set ImportePagado - " + total + ", ImporteSaldoInsoluto -" + total + ", ImporteSaldoAnterior + " + total + " where serie ='" + factura.Serie + "' and numero =" + factura.Numero);
                        }
                        catch (Exception err)
                        {

                        }
                    }
                    //if (respuesta.Codigo_MF_Texto == "OK")
                    //{

                    //  Descargarxmlcancelacion(respuesta.CFDI, elemento.Serie, elemento.Numero);
                    string cadenasql = "update encfacturas set Estado='C' where ID=" + id;
                    
                    db.Database.ExecuteSqlCommand(cadenasql);

                    //string cadenasaleante = "update prefactura set idfacturadigital=0,seriedigital='', numerodigital=0, status='Activo' where seriedigital='" + temp._templatePDF.serie  + "' and numerodigital=" + temp._templatePDF.folio  +"";
                    //esta era la que tenia antes; 
                    string cadenasale = "update encprefactura set idfacturadigital=0, seriedigital='', numerodigital=0, status='Activo' where idfacturadigital=" + id;
                    db.Database.ExecuteSqlCommand(cadenasale);
                    string cadenasaldo = "update dbo.saldofactura set importesaldoinsoluto=0 where idfactura=" + id;
                    db.Database.ExecuteSqlCommand(cadenasaldo);

                    return Json(new HttpStatusCodeResult(200));
                }
                else
                {
                    return Json(new HttpStatusCodeResult(500));
                }


            }
            catch (Exception err)
            {
                return Json(500, err.Message); 
            }
            
        }

        public ActionResult AddendaEnvanses(int id)
        {
            AddendaEnvases elemento = new AddendaEnvases();

            elemento.ID = id;
            elemento.OrdenCompra = "";
            elemento.Albaran = "";
            return View(elemento);
        }





        [HttpPost]
        public ActionResult AddendaEnvanses(AddendaEnvases modelo)
        {
            var elemento = db.encfacturas.Single(m => m.ID == modelo.ID);


            string rutaArchivo = elemento.UUID + ".xml";
            string fileName = System.Web.HttpContext.Current.Server.MapPath("~/Xmlfacturas/" + rutaArchivo);
            string xmlString = System.IO.File.ReadAllText(fileName);


            var stream = new MemoryStream(Encoding.ASCII.GetBytes(xmlString));
            StreamReader reader = new StreamReader(stream);
            string contenidoxml = reader.ReadToEnd();

            try
            {


                Generador.CreaPDF factura = new Generador.CreaPDF(contenidoxml);
                StringBuilder adde = new StringBuilder();
                contenidoxml = contenidoxml.Substring(0, contenidoxml.Length - 19);
                contenidoxml = contenidoxml.Substring(0,38)+ Environment.NewLine + contenidoxml.Substring(38, (contenidoxml.Length - 38));
                contenidoxml.Replace("?>", "?>"+ @Environment.NewLine);
                int posicion = contenidoxml.IndexOf("<cfdi:Emisor");
                contenidoxml=contenidoxml.Substring(0, posicion) + Environment.NewLine +"\t"+ contenidoxml.Substring(posicion, (contenidoxml.Length - posicion)) ;
                posicion = contenidoxml.IndexOf("<cfdi:Receptor");
                contenidoxml = contenidoxml.Substring(0, posicion) + Environment.NewLine+ "\t"  + contenidoxml.Substring(posicion, (contenidoxml.Length - posicion)) ;
                posicion = contenidoxml.IndexOf("<cfdi:Conceptos>");
                contenidoxml = contenidoxml.Substring(0, posicion) + Environment.NewLine + "\t\t" + contenidoxml.Substring(posicion, (contenidoxml.Length - posicion));
                posicion = contenidoxml.IndexOf("</cfdi:Conceptos>");
                contenidoxml = contenidoxml.Substring(0, posicion) + Environment.NewLine + "\t\t" + contenidoxml.Substring(posicion, (contenidoxml.Length - posicion)) ;

                posicion = contenidoxml.IndexOf("<cfdi:Impuestos");
                contenidoxml = contenidoxml.Substring(0, posicion) + Environment.NewLine + "\t\t" + contenidoxml.Substring(posicion, (contenidoxml.Length - posicion)) ;
                posicion = contenidoxml.IndexOf("</cfdi:Impuestos");
                contenidoxml = contenidoxml.Substring(0, posicion) + Environment.NewLine + "\t\t" + contenidoxml.Substring(posicion, (contenidoxml.Length - posicion)) ;

                posicion = contenidoxml.IndexOf("<cfdi:Complemento>");
                contenidoxml = contenidoxml.Substring(0, posicion) + Environment.NewLine + "\t" + contenidoxml.Substring(posicion, (contenidoxml.Length - posicion)) ;
                posicion = contenidoxml.IndexOf("</cfdi:Complemento");
                contenidoxml = contenidoxml.Substring(0, posicion) + Environment.NewLine + "\t" + contenidoxml.Substring(posicion, (contenidoxml.Length - posicion)) ;




                adde.Append(contenidoxml );

                char comilla = (char)34;
                adde.Append("<cfdi:Addenda>\n");
                adde.Append("\t\t<eu:AddendaEU xmlns:eu="+ comilla+"http://factura.envasesuniversales.com/addenda/eu"+comilla+" xsi:schemaLocation="+comilla+ "http://factura.envasesuniversales.com/addenda/eu http://factura.envasesuniversales.com/addenda/eu/EU_Addenda.xsd" + comilla+">\n");
                adde.Append("\t\t\t<eu:TipoFactura>\n");
                adde.Append("\t\t\t<eu:IdFactura>Factura</eu:IdFactura>\n");
                adde.Append("\t\t\t\t<eu:Version>1.0</eu:Version>\n");
                adde.Append("\t\t\t\t<eu:FechaMensaje>" + DateTime.Now.ToString("yyyy-MM-dd") + "</eu:FechaMensaje>\n");
                adde.Append("\t\t\t</eu:TipoFactura>\n");
                adde.Append("\t\t\t<eu:TipoTransaccion>\n");
                adde.Append("\t\t\t\t<eu:IdTransaccion>Con_Pedido</eu:IdTransaccion>\n");
                adde.Append("\t\t\t<eu:Transaccion>" + factura._templatePDF.serie + factura._templatePDF.folio + "</eu:Transaccion>\n");
                adde.Append("\t\t\t</eu:TipoTransaccion>\n");
                adde.Append("\t\t<eu:OrdenesCompra>\n");
                adde.Append("\t\t\t\t<eu:Secuencia consec=" + comilla+"1"+comilla+">\n");

                adde.Append("\t\t\t\t\t<eu:IdPedido>" + modelo.OrdenCompra+ "</eu:IdPedido>\n");
                adde.Append("\t\t\t\t\t<eu:EntradaAlmacen>\n");
                adde.Append("\t\t\t\t\t\t<eu:Albaran>" + modelo.Albaran+ "</eu:Albaran>\n");
                adde.Append("\t\t\t\t\t</eu:EntradaAlmacen>\n");
                adde.Append("\t\t\t\t</eu:Secuencia>\n");
                adde.Append("\t\t</eu:OrdenesCompra>\n");
                adde.Append("\t\t<eu:Moneda>\n");

                adde.Append("\t\t\t<eu:MonedaCve>" + factura._templatePDF.claveMoneda+ "</eu:MonedaCve>\n");

                adde.Append("\t\t\t\t<eu:TipoCambio>" + factura._templatePDF.tipo_cambio+ "</eu:TipoCambio>\n");
                adde.Append("\t\t\t\t<eu:SubtotalM>" + factura._templatePDF.subtotal + "</eu:SubtotalM>\n");
                adde.Append("\t\t\t\t<eu:TotalM>" + factura._templatePDF.total + "</eu:TotalM>\n");
                adde.Append("\t\t\t\t<eu:ImpuestoM>" + factura._templatePDF.totalImpuestosRetenidos + "</eu:ImpuestoM>\n");
                adde.Append("\t\t</eu:Moneda>\n");
                adde.Append("\t\t</eu:AddendaEU>\n");
                adde.Append("\t</cfdi:Addenda>");
                adde.Append("</cfdi:Comprobante>");

                var stream2 = new MemoryStream(Encoding.ASCII.GetBytes(adde.ToString()));

                return File(stream2, "text/plain", "Addenda" + factura._templatePDF.serie + factura._templatePDF.folio + ".xml");
                
            }
            catch (Exception err)
            {
                string MENSAJE = err.Message;
                RedirectToAction("Index"); 
            }
            RedirectToAction("Index");
            return null;
        }
    



        public ActionResult VPagos(int id, List<VEncPagos> enc)
        {
            try
            {

                VEncPagos encFac = db.Database.SqlQuery<VEncPagos>("select ID, Nombre_Cliente, Numero as NoFactura, Total from dbo.EncFacturas where ID = " + id + "").ToList()[0];
            
            ViewBag.Nombre = encFac.Nombre_cliente;
            ViewBag.NoFactura = encFac.NoFactura;
            ViewBag.Total = encFac.Total; 

            }
            catch (Exception err)
            {
                string MENSAJE = err.Message;
                ViewBag.Nombre = "";
                ViewBag.NoFactura = "";
                ViewBag.Total = "";
            }

           

                List<VPagos> elemento = db.Database.SqlQuery<VPagos>("select P.[FechaPago],  D.ImporteSaldoInsoluto, D.importepagado, D.NoParcialidad, D.StatusDocto from dbo.PagoFactura as P right join ([dbo].[DocumentoRelacionado]as D left join [dbo].[PagoFacturaSPEI] as S on D.IDPagoFactura = S.IDPagoFactura) on P.[IDPagoFactura] = D.[IDPagoFactura] where  D.IDFactura = " + id + " order by NoParcialidad ").ToList();
            if (elemento == null)
            {
                return HttpNotFound();
            }
                return View(elemento);
           
        }







        /////////////////////////////////REPORTE POR HORA/////////////////////////////////////////////////////////////////////////////////////

        public ActionResult CreaReporteEstado()
        {

            var EstadoLst = new List<SelectListItem>();

            EstadoLst.Add(new SelectListItem { Text = "Todos", Value = "T" });
            EstadoLst.Add(new SelectListItem { Text = "Activo", Value = "A" });
            EstadoLst.Add(new SelectListItem { Text = "Cancelado", Value = "C" });


            ViewBag.Estado = new SelectList(EstadoLst, "Value", "Text");


            return View();
        }



        /////////////////////////////////REPORTE POR CLIENTE/////////////////////////////////////////////////////////////////////////////////////


        public ActionResult CreaReporteporFecha()
        {
            //Buscar Cliente
            ClientesContext dbc = new ClientesContext();
            var cliente = dbc.Clientes.OrderBy(m => m.Nombre).ToList();
            List<SelectListItem> listaCliente = new List<SelectListItem>();
            listaCliente.Add(new SelectListItem { Text = "--Selecciona Cliente--", Value = "0" });

            var EstadoLst = new List<SelectListItem>();
            EstadoLst.Add(new SelectListItem { Text = "Todos", Value = "T" });
            EstadoLst.Add(new SelectListItem { Text = "Activo", Value = "A" });
            EstadoLst.Add(new SelectListItem { Text = "Cancelado", Value = "C" });
            ViewBag.Estado = new SelectList(EstadoLst, "Value", "Text");

            //Facturas Pagadas
            var PagoLst = new List<SelectListItem>();
            PagoLst.Add(new SelectListItem { Text = "Todas", Value = "T" });
            PagoLst.Add(new SelectListItem { Text = "Pagada", Value = "SI" });
            PagoLst.Add(new SelectListItem { Text = "NoPagada", Value = "NO" });
            ViewBag.Pagada = new SelectList(PagoLst, "Value", "Text");

            foreach (var m in cliente)
            {
                listaCliente.Add(new SelectListItem { Text = m.Nombre, Value = m.IDCliente.ToString() });
            }
            ViewBag.cliente = listaCliente;
            return View();
        }

      





        //////////////////////////////////MONEDA////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        public ActionResult CreaReporteporMoneda()
        {
            //Buscar 
            c_MonedaContext dbc = new c_MonedaContext();
            var mone = dbc.c_Monedas.OrderBy(m => m.Descripcion).ToList();
            List<SelectListItem> listaMonedas = new List<SelectListItem>();
            listaMonedas.Add(new SelectListItem { Text = "--Selecciona Moneda--", Value = "0" });

            var EstadoLst = new List<SelectListItem>();
            EstadoLst.Add(new SelectListItem { Text = "Todos", Value = "T" });
            EstadoLst.Add(new SelectListItem { Text = "Activo", Value = "A" });
            EstadoLst.Add(new SelectListItem { Text = "Cancelado", Value = "C" });

            //ViewData["Estado"] = EstadoLst;
            ViewBag.Estado = new SelectList(EstadoLst, "Value", "Text");

            foreach (var m in mone)
            {
                listaMonedas.Add(new SelectListItem { Text = m.Descripcion, Value = m.IDMoneda.ToString() });
            }
            ViewBag.moneda = listaMonedas;
            return View();
        }


    
        public FileResult DescargaExcel(string Numero, string SerieFac, string ClieFac, string sortOrder, string currentFilter, string Fechainicio, string Fechafinal, string FacPag, string Estado = "A")
        {
            string ConsultaSql = "select * from Encfacturas ";
            string cadenaSQl = string.Empty;
            try
            {

             

                string Filtro = string.Empty;



                string Orden = " order by fecha desc , serie , numero desc ";

                ///tabla filtro: serie
                if (!String.IsNullOrEmpty(SerieFac))
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Serie='" + SerieFac + "'";
                    }
                    else
                    {
                        Filtro += "and  Serie='" + SerieFac + "'";
                    }

                }
                //Buscar por numero
                if (!String.IsNullOrEmpty(Numero))
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Numero=" + Numero + "";
                    }
                    else
                    {
                        Filtro += "and  Numero=" + Numero + "";
                    }

                }

                ///tabla filtro: Nombre Cliente
                if (!String.IsNullOrEmpty(ClieFac) && ClieFac!="Todas")
                {

                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Nombre_cliente='" + ClieFac + "'";
                    }
                    else
                    {
                        Filtro += "and  Nombre_cliente='" + ClieFac + "'";
                    }

                }

                ///tabla filtro: Factura pagada/no pagada && Serie, Nombre Cliente
                if (FacPag != "Todas")
                {
                    if (FacPag == "SI")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where pagada='1' ";
                        }
                        else
                        {
                            Filtro += "and  pagada='1' ";
                        }
                    }
                    if (FacPag == "NO")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where pagada='0' ";
                        }
                        else
                        {
                            Filtro += "and  pagada='0' ";
                        }
                    }
                }


                if (Estado != "Todos")
                {
                    if (Estado == "C")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where Estado='C'";
                        }
                        else
                        {
                            Filtro += "and  Estado='C'";
                        }
                    }
                    if (Estado == "A")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where  Estado='A'";
                        }
                        else
                        {
                            Filtro += "and Estado='A'";
                        }
                    }
                }



                if (!String.IsNullOrEmpty(Fechainicio) && String.IsNullOrEmpty(Fechafinal)) //pusieron una fecha
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where  Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechainicio + " 23:59:59.999' ";
                    }
                    else
                    {
                        Filtro += " and Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechainicio + " 23:59:59.999'";
                    }
                }


                if (!String.IsNullOrEmpty(Fechainicio) && !String.IsNullOrEmpty(Fechafinal)) //pusieron una fecha
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where  Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechafinal + " 23:59:59.999' ";
                    }
                    else
                    {
                        Filtro += " and Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechafinal + " 23:59:59.999'";
                    }
                }



           

                switch (sortOrder)
                {
                    case "Activa":
                        Orden = " order by  Estado ";
                        break;
                    case "Serie":
                        Orden = " order by  serie , numero desc ";
                        break;
                    case "Numero":
                        Orden = " order by   numero asc ";
                        break;
                    case "Fecha":
                        Orden = " order by fecha ";
                        break;
                    case "Nombre_Cliente":
                        Orden = " order by  Nombre_cliente ";
                        break;
                    default:
                        Orden = " order by fecha desc , serie , numero desc ";
                        break;
                }


                // si no ha seleccionado nada muestra las facturas del ultimo mes 

                if (Filtro == "where  Estado='A'")
                {
                    Filtro += " and Fecha >='" + DateTime.Now.AddDays(-30).Year + "-" + DateTime.Now.AddDays(-30).Month + "-" + DateTime.Now.AddDays(-30).Day + "'  and  Fecha<'" + DateTime.Now.AddDays(1).Year + "-" + DateTime.Now.AddDays(1).Month + "-" + DateTime.Now.AddDays(1).Day + "' ";
                   
                }

                //var elementos = from s in db.encfacturas
                //select s;
                cadenaSQl = ConsultaSql + " " + Filtro + " " + Orden;

                var elementos = db.Database.SqlQuery<Encfacturas>(cadenaSQl).ToList();
                string renglon = string.Empty;
                renglon = "Fecha,Serie,Numero,Nombre de cliente,Subtotal,IVA,Total,Moneda, Tipo de cambio, Esta Pagada,  UUID, Estado, Metodo de pago \n";
                foreach (Encfacturas Ele in elementos)
                {
                    
                    renglon +=Ele.Fecha+","+ Ele.Serie + "," + Ele.Numero + "," + Ele.Nombre_cliente.Replace(","," ") + "," + Ele.Subtotal + "," + Ele.IVA + "," + Ele.Total + "," + Ele.Moneda + "," + Ele.TC + "," + Ele.pagada + "," + Ele.UUID + "," + Ele.Estado + "," + Ele.IDMetododepago + "\n";
                }

                if (renglon!=string.Empty)
                {
                    renglon = renglon.TrimEnd('\n');  // le quita el enter
                }


                var stream = new MemoryStream(Encoding.ASCII.GetBytes(renglon));

                return File(stream, "text/plain", "Listado de Facturas.csv");

                //Response.Clear();
                //Response.AddHeader("Content-Disposition", "attachment; filename=adressenbestand.csv");
                //Response.ContentType = "text/csv";
                //Response.Write(renglon);
                //Response.End();

                //return new HttpStatusCodeResult(HttpStatusCode.OK);

            }
            catch (Exception err)
            {
                string mensaje = err.Message;
                string renglon = "Tu consulta causo un problema o no presionaste el boton aplicar antes de este boton\n " + ConsultaSql +"\n" + err.Message;

             //   var filresult = File(new System.Text.UTF8Encoding().GetBytes(renglon), "application/csv", "downloaddocuments.csv");
                // return filresult;

                var stream = new MemoryStream(Encoding.ASCII.GetBytes(renglon));

                return File(stream, "text/plain", "Listado de Factura.csv");
             


            }
        }


        public FileResult DescargaPoliza(string Numero, string SerieFac, string ClieFac, string sortOrder, string currentFilter, string Fechainicio, string Fechafinal, string FacPag, string Estado = "A")
        {
            string ConsultaSql = "select * from Encfacturas ";
            string cadenaSQl = string.Empty;
            try
            {



                string Filtro = string.Empty;



                string Orden = " order by fecha desc , serie , numero desc ";

                ///tabla filtro: serie
                if (!String.IsNullOrEmpty(SerieFac))
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Serie='" + SerieFac + "'";
                    }
                    else
                    {
                        Filtro += "and  Serie='" + SerieFac + "'";
                    }

                }

                if (String.IsNullOrEmpty(SerieFac))
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Serie=' '";
                    }
                    else
                    {
                        Filtro += "and  Serie=' '";
                    }

                }

                //Buscar por numero
                if (!String.IsNullOrEmpty(Numero))
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Numero=" + Numero + "";
                    }
                    else
                    {
                        Filtro += "and  Numero=" + Numero + "";
                    }

                }

                ///tabla filtro: Nombre Cliente
                if (!String.IsNullOrEmpty(ClieFac) && ClieFac != "Todas")
                {

                    if (Filtro == string.Empty)
                    {
                        Filtro = "where Nombre_cliente='" + ClieFac + "'";
                    }
                    else
                    {
                        Filtro += "and  Nombre_cliente='" + ClieFac + "'";
                    }

                }

                ///tabla filtro: Factura pagada/no pagada && Serie, Nombre Cliente
                if (FacPag != "Todas")
                {
                    if (FacPag == "SI")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where pagada='1' ";
                        }
                        else
                        {
                            Filtro += "and  pagada='1' ";
                        }
                    }
                    if (FacPag == "NO")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where pagada='0' ";
                        }
                        else
                        {
                            Filtro += "and  pagada='0' ";
                        }
                    }
                }


                if (Estado != "Todos")
                {
                    if (Estado == "C")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where Estado='C'";
                        }
                        else
                        {
                            Filtro += "and  Estado='C'";
                        }
                    }
                    if (Estado == "A")
                    {
                        if (Filtro == string.Empty)
                        {
                            Filtro = "where  Estado='A'";
                        }
                        else
                        {
                            Filtro += "and Estado='A'";
                        }
                    }
                }



                if (!String.IsNullOrEmpty(Fechainicio) && String.IsNullOrEmpty(Fechafinal)) //pusieron una fecha
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where  Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechainicio + " 23:59:59.999' ";
                    }
                    else
                    {
                        Filtro += " and Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechainicio + " 23:59:59.999'";
                    }
                }


                if (!String.IsNullOrEmpty(Fechainicio) && !String.IsNullOrEmpty(Fechafinal)) //pusieron una fecha
                {
                    if (Filtro == string.Empty)
                    {
                        Filtro = "where  Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechafinal + " 23:59:59.999' ";
                    }
                    else
                    {
                        Filtro += " and Fecha BETWEEN '" + Fechainicio + " 00:00:00.1' and '" + Fechafinal + " 23:59:59.999'";
                    }
                }





                switch (sortOrder)
                {
                    case "Activa":
                        Orden = " order by  Estado ";
                        break;
                    case "Serie":
                        Orden = " order by  serie , numero desc ";
                        break;
                    case "Numero":
                        Orden = " order by   numero asc ";
                        break;
                    case "Fecha":
                        Orden = " order by fecha ";
                        break;
                    case "Nombre_Cliente":
                        Orden = " order by  Nombre_cliente ";
                        break;
                    default:
                        Orden = " order by fecha desc , serie , numero desc ";
                        break;
                }


                // si no ha seleccionado nada muestra las facturas del ultimo mes 

                if (Filtro == "where  Estado='A'")
                {
                    Filtro += " and Fecha >='" + DateTime.Now.AddDays(-30).Year + "-" + DateTime.Now.AddDays(-30).Month + "-" + DateTime.Now.AddDays(-30).Day + "'  and  Fecha<'" + DateTime.Now.AddDays(1).Year + "-" + DateTime.Now.AddDays(1).Month + "-" + DateTime.Now.AddDays(1).Day + "' ";

                }

                //var elementos = from s in db.encfacturas
                //select s;
                cadenaSQl = ConsultaSql + " " + Filtro + " " + Orden;

                var elementos = db.Database.SqlQuery<Encfacturas>(cadenaSQl).ToList();

                StringBuilder renglon = new StringBuilder();
                Char comillas = new Char();
                comillas = System.Char.Parse("\""); //comillas ;


                string cuentaVentas = string.Empty;
                string VentasConcepto = string.Empty;
                string cuentaiva16 = string.Empty;
                string conceptoiva16 = string.Empty;
                string VersionCOI = string.Empty;

                try
                {
                    XmlDocument xm = new XmlDocument();
                    xm.Load(System.Web.HttpContext.Current.Server.MapPath("~/configCuentas.xml"));


                    XmlNode cuentasnode = xm.FirstChild;
                    try
                    {
                        foreach (XmlNode cuentas in cuentasnode.ChildNodes)
                        {

                            if (cuentas.Name == "VentasCuenta")
                            {
                                cuentaVentas = cuentas.InnerText;
                            }
                            if (cuentas.Name == "VentasConcepto")
                            {
                                VentasConcepto = cuentas.InnerText;
                            }
                            if (cuentas.Name == "IVACuenta16")
                            {
                                cuentaiva16 = cuentas.InnerText;
                            }
                            if (cuentas.Name == "IVAConcepto16")
                            {
                                conceptoiva16 = cuentas.InnerText;
                            }

                            if (cuentas.Name == "versionCOI")
                            {
                                VersionCOI = cuentas.InnerText;
                            }


                        }
                    }
                    catch (Exception err)
                    {
                        throw new Exception("Hay un error con una configuracion de cuentas Contables "+ err.Message);
                    }
                }

                catch(Exception err)
                    {
                    throw new Exception("Hay un error con tu archivo de configuracion de cuentas Contables " + err.Message);
                }

                decimal acusubtotal = 0;
                decimal acuiva = 0;
                decimal acutotal = 0;

                renglon.Append("<?xml version=" + comillas + "1.0" + comillas + " encoding=" + comillas + "utf-8" + comillas + " standalone=" + comillas + "yes" + comillas + "?>\n");
                renglon.Append("<DATAPACKET Version=" + comillas + "2.0" + comillas + ">\n");
                renglon.Append("<METADATA>\n");
                renglon.Append("<FIELDS>\n");
                renglon.Append( "<FIELD attrname=" + comillas + "VersionCOI" + comillas + " fieldtype=" + comillas + "i2" + comillas + " />\n");
                renglon.Append( "<FIELD attrname=" + comillas + "TipoPoliz" + comillas + " fieldtype=" + comillas + "string" + comillas + " WIDTH=" + comillas + "2" + comillas + " />\n");
                renglon.Append( "<FIELD attrname=" + comillas + "DiaPoliz" + comillas + " fieldtype=" + comillas + "string" + comillas + " WIDTH=" + comillas + "2" + comillas + " />\n");
                renglon.Append( "<FIELD attrname=" + comillas + "ConcepPoliz" + comillas + " fieldtype=" + comillas + "string" + comillas + " WIDTH=" + comillas + "120" + comillas + " />\n");
                renglon.Append("<FIELD attrname=" + comillas + "Partidas" + comillas + " fieldtype=" + comillas + "nested" + comillas + ">\n");
                renglon.Append("<FIELDS>\n");
                renglon.Append( "<FIELD attrname=" + comillas + "Cuenta" + comillas + " fieldtype=" + comillas + "string" + comillas + " WIDTH=" + comillas + "21" + comillas + " />\n");
                renglon.Append( "<FIELD attrname=" + comillas + "Depto" + comillas + " fieldtype=" + comillas + "i4" + comillas + " />\n");
                renglon.Append( "<FIELD attrname=" + comillas + "ConceptoPol" + comillas + " fieldtype=" + comillas + "string" + comillas + " WIDTH=" + comillas + "120" + comillas + " />\n");
                renglon.Append( "<FIELD attrname=" + comillas + "Monto" + comillas + " fieldtype=" + comillas + "r8" + comillas + " />\n");
                renglon.Append( "<FIELD attrname=" + comillas + "TipoCambio" + comillas + " fieldtype=" + comillas + "r8" + comillas + " />\n");
                renglon.Append( "<FIELD attrname=" + comillas + "DebeHaber" + comillas + " fieldtype=" + comillas + "string" + comillas + " WIDTH=" + comillas + "1" + comillas + " />\n");
                renglon.Append("</FIELDS>\n");
                renglon.Append( "<PARAMS />\n");
                renglon.Append("</FIELD>\n");
                renglon.Append("</FIELDS>\n");
                 renglon.Append( "<PARAMS />\n");
                renglon.Append("</METADATA>\n");
                renglon.Append("<ROWDATA>\n");
                renglon.Append("<ROW VersionCOI=" + comillas + VersionCOI + comillas + " TipoPoliz=" + comillas + "Dr" + comillas + " DiaPoliz=" + comillas + "1" + comillas + " ConcepPoliz=" + comillas + "Poliza de Ventas" + comillas + ">\n");
                renglon.Append("<Partidas>\n");

                string TIPO = "D";
                foreach (Encfacturas Ele in elementos)
                {
                    if (Ele.IDCliente==0)
                    {
                        throw new Exception("El Cliente " + Ele.Nombre_cliente + " no tiene correspondencia en el Siaapi ");
                    }



                    decimal Monto = Ele.Total;
                    Clientes cliente = new ClientesContext().Clientes.Find(Ele.IDCliente);

                    string cuenta = cliente.cuentaContable;

                    if (cliente.cuentaContable == string.Empty)
                    {
                        throw new Exception("El Cliente " + Ele.Nombre_cliente + " no tiene cuenta contable registrada ");
                    }
                    String REF = "FACTURA "   + Ele.Serie + " " + Ele.Numero + "  " + Ele.Nombre_cliente.Substring(0,20) ;

                    if (Ele.Estado == "A")
                    {
                        if (Ele.Moneda == "MXN")
                        {
                            acusubtotal = acusubtotal + Ele.Subtotal;
                            acuiva = acuiva + Ele.IVA;
                            acutotal = acutotal + Ele.Total;
                        }
                        else
                        {
                            acusubtotal = acusubtotal + Math.Round(Ele.Subtotal * Ele.TC, 2);
                            acuiva = acuiva + Math.Round(Ele.IVA * Ele.TC, 2);
                            acutotal = acutotal + Math.Round(Ele.Total * Ele.TC, 2);
                            Monto = Math.Round(Ele.Total * Ele.TC, 2);
                        }
                    }
                    else
                    {
                        REF = REF + " CANCELADA";
                        Monto = 0;
                    }

                    renglon.Append("<ROWPartidas Cuenta=" + comillas + cuenta + comillas + " Depto=" + comillas + "0" + comillas + " ConceptoPol=" + comillas + REF + comillas + " Monto=" + comillas + Monto + comillas + " TipoCambio=" + comillas + Ele.TC + comillas + " DebeHaber=" + comillas + TIPO + comillas + " />\n");
                    



                }
               

                renglon.Append("<ROWPartidas Cuenta=" + comillas + cuentaVentas + comillas + " Depto=" + comillas + "0" + comillas + " ConceptoPol=" + comillas + VentasConcepto + comillas + " Monto=" + comillas + acusubtotal + comillas + " TipoCambio=" + comillas + 1 + comillas + " DebeHaber=" + comillas + "H" + comillas + " />\n");
                renglon.Append("<ROWPartidas Cuenta=" + comillas + cuentaiva16 + comillas + " Depto=" + comillas + "0" + comillas + " ConceptoPol=" + comillas + conceptoiva16 + comillas + " Monto=" + comillas + acuiva + comillas + " TipoCambio=" + comillas + 1 + comillas + " DebeHaber=" + comillas + "H" + comillas + " />\n");
 
                renglon.Append("</Partidas>\n");
                renglon.Append("</ROW>\n");
                renglon.Append("</ROWDATA>\n");
                renglon.Append("</DATAPACKET>\n");


                var stream = new MemoryStream(Encoding.ASCII.GetBytes(renglon.ToString()));

                return File(stream, "text/plain", "PolizaFacturacion.Pol");


            }
            catch (Exception err)
            {
                string mensaje = err.Message;
                string renglon = "Error : " + err.Message;

                //   var filresult = File(new System.Text.UTF8Encoding().GetBytes(renglon), "application/csv", "downloaddocuments.csv");
                // return filresult;

                var stream = new MemoryStream(Encoding.ASCII.GetBytes(renglon));

                return File(stream, "text/plain", "Error.txt");



            }
        }

        public ActionResult CreaXmlFacturas()
        {
            DateTime fechax = DateTime.Parse("2020-01-01");
            var facturas = new EncfacturaContext().encfacturas.Where(s=> s.Fecha>=fechax).ToList();
            try
            {
                foreach (Encfacturas factura in facturas)
                {
                    if (factura.RutaXML.Length > 1)
                    {
                        Generador.CreaPDF temp = new Generador.CreaPDF(factura.RutaXML.ToString());
                        string fileName = temp._templatePDF.folioFiscalUUID + ".xml";

                        EscribeEnArchivo(factura.RutaXML, fileName, true);
                    }
                }
                ViewBag.Error = "Termine";
            }
            catch (Exception err)
            {
                ViewBag.Error = "Este error ocurrio" + err.Message;
            }

            return View();

        }

        public ActionResult CreaXmlFacturasT()
        {
           // DateTime fechax = DateTime.Parse("2019-08-01");
            var facturas = new EncfacturaContext().encfacturas.ToList();
            try
            {
                foreach (Encfacturas factura in facturas)
                {
                    if( factura.RutaXML.Length > 1)
                   { Generador.CreaPDF temp = new Generador.CreaPDF(factura.RutaXML.ToString());
                        string fileName = temp._templatePDF.folioFiscalUUID + ".xml";

                        EscribeEnArchivo(factura.RutaXML, fileName, true);
                    }
                }
                ViewBag.Error = "Termine";
            }
            catch (Exception err)
            {
                ViewBag.Error = "Este error ocurrio" + err.Message;
            }

            return View();

        }

        public static void EscribeEnArchivo(string contenido, string rutaArchivo, bool sobrescribir = true)
        {
            string archivoxml = System.Web.HttpContext.Current.Server.MapPath("~/Xmlfacturas/"+ rutaArchivo);

            using (FileStream fs = System.IO.File.Create(archivoxml))
            {
                AddText(fs, contenido);
            }

        }


        private static void AddText(FileStream fs, string value)
        {
            byte[] info = new UTF8Encoding(true).GetBytes(value);
            fs.Write(info, 0, info.Length);
        }

        public ActionResult reporteSaldos()
        {
            List<ClientesFacturas> clientes = new List<ClientesFacturas>();
            string cadena = "select C.IDCliente, C.Nombre from Clientes as c inner join tempClienteSaldo as t on c.IDCliente=t.IDCliente order by c.Nombre";
            clientes = db.Database.SqlQuery<ClientesFacturas>(cadena).ToList();
            List<SelectListItem> listacliente = new List<SelectListItem>();
            listacliente.Add(new SelectListItem { Text = "--Selecciona Cliente--", Value = "0" });

            foreach (var m in clientes)
            {
                listacliente.Add(new SelectListItem { Text = m.Nombre, Value = m.IDCliente.ToString() });
            }
            ViewBag.cliente = listacliente;
            return View();
        }


        [HttpPost]
        public ActionResult reporteSaldos(ReporteSaldoInsoluto r, ClientesFacturas C)
        {
            int idcliente = C.IDCliente;
            try
            {

                ClientesContext dbc = new ClientesContext();
                Clientes cls = dbc.Clientes.Find(C.IDCliente);
            }
            catch (Exception ERR)
            {

            }

            try
            {
                string cadena = "drop table [dbo].[tempClienteSaldo]";

                db.Database.ExecuteSqlCommand(cadena);
            }
            catch (Exception err)
            {
                string mensajeerror = err.Message;
            }
            string cadena1 = "CREATE TABLE [dbo].[tempClienteSaldo]([IDCliente] [int] NULL) ON [PRIMARY]";
            db.Database.ExecuteSqlCommand(cadena1);
            string cadena2 = "insert into [tempClienteSaldo] select distinct e.IDCliente from EncFacturas as e inner join SaldoFactura as s on e.ID=s.IDFactura where s.ImporteSaldoInsoluto>0";
            db.Database.ExecuteSqlCommand(cadena2);


            ReporteSaldoInsoluto report = new ReporteSaldoInsoluto();
            byte[] abytes = report.PrepareReport(idcliente);
            return File(abytes, "application/pdf");
        }

        

        public ActionResult AntiguedadSaldos()
        {
            List<Clientes> clientes = new List<Clientes>();
            string cadena = "select * from Clientes order by Nombre";
            clientes = db.Database.SqlQuery<Clientes>(cadena).ToList();
            List<SelectListItem> listacliente = new List<SelectListItem>();
            listacliente.Add(new SelectListItem { Text = "--Selecciona Cliente--", Value = "0" });

            foreach (var m in clientes)
            {
                listacliente.Add(new SelectListItem { Text = m.Nombre, Value = m.IDCliente.ToString() });
            }
            ViewBag.cliente = listacliente;




            return View();
        }

        [HttpPost]
        public ActionResult AntiguedadSaldos(AntiguedadSaldos r, ClientesFacturasA C, FormCollection coleccion)
        {
            int idcliente = C.IDCliente;

            string cual = coleccion.Get("Enviar");
            string cadena = "";

            if (cual == "Generar reporte")
            {
                try
                {
                    ClientesContext dbc = new ClientesContext();
                    Clientes cls = dbc.Clientes.Find(C.IDCliente);
                }
                catch (Exception ERR)
                {

                }


                try
                {
                    string cadena21 = "drop table [dbo].[tempClienteSaldo]";

                    db.Database.ExecuteSqlCommand(cadena21);
                }
                catch (Exception err)
                {
                    string mensajeerror = err.Message;
                }
                string cadena1 = "CREATE TABLE [dbo].[tempClienteSaldo]([IDCliente] [int] NULL) ON [PRIMARY]";
                db.Database.ExecuteSqlCommand(cadena1);
                string cadena2 = "insert into [tempClienteSaldo] select distinct e.IDCliente from EncFacturas as e inner join SaldoFactura as s on e.ID=s.IDFactura where s.ImporteSaldoInsoluto>0";
                db.Database.ExecuteSqlCommand(cadena2);

                AntiguedadSaldos report1 = new AntiguedadSaldos();
                byte[] abytes1 = report1.PrepareReport(idcliente);
                return File(abytes1, "application/pdf");
            }
            else if (cual == "Generar Excel")
            {
                if (idcliente == 0)
                {
                    cadena = "Select ID, Serie, Numero, Fecha, Nombre_Cliente,  Total, Moneda, TC, ImportePagado,  FechaVencimiento, ImporteSaldoInsoluto, FechaRevision, oficina, Vendedor, noExpediente,Telefono from[dbo].[EncFacturaOfVen]   Where Estado = 'A'  and ImporteSaldoInsoluto> 0 Order by Nombre_Cliente Asc, Numero desc";
                }
                else
                {
                    cadena = "Select ID, Serie, Numero, Fecha, Nombre_Cliente, Total, Moneda, TC, ImportePagado,  FechaVencimiento, ImporteSaldoInsoluto, FechaRevision, oficina, Vendedor, noExpediente,Telefono from[dbo].[EncFacturaOfVen]   Where Estado = 'A'  and ImporteSaldoInsoluto> 0 and  IDCliente = " + idcliente + " Order by Nombre_Cliente Asc, Numero desc";
                }


                var facturassaldos = dbs.Database.SqlQuery<EncFacturaOfVen>(cadena).ToList();
                ViewBag.facturassaldos = facturassaldos;
                ExcelPackage Ep = new ExcelPackage();
                //Crear la hoja y poner el nombre de la pestaña del libro
                var Sheet = Ep.Workbook.Worksheets.Add("Antiguedad Saldos");

                // en la fila1 formateo las celdas y coloco el título de la hoja
                // RichText permite agregar las propiedades de tipo de letra: color, negrita, etc.
                int row = 1;
                //Fijar la fuente para A1:Q1
                Sheet.Cells["A1:U1"].Style.Font.Size = 20;
                Sheet.Cells["A1:U1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:U3"].Style.Font.Bold = true;
                Sheet.Cells["A1:U1"].Style.Font.Color.SetColor(Color.DarkBlue);
                Sheet.Cells["A1:U1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["A1"].RichText.Add("Antiguedad de Saldos");

                row = 2;
                Sheet.Cells["A1:U1"].Style.Font.Size = 12;
                Sheet.Cells["A1:U1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:U1"].Style.Border.Bottom.Style = ExcelBorderStyle.Hair;
                Sheet.Cells["A2:U2"].Style.Font.Bold = true;
                //Subtitulo según el filtrado del periodo de datos
                row = 2;
                string Fec = DateTime.Now.Year.ToString() + "-" + DateTime.Now.Month.ToString() + "-" + DateTime.Now.Day.ToString();
                Sheet.Cells[string.Format("A2", row)].Value = "Fecha";
                Sheet.Cells[string.Format("B2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("B2", row)].Value = Fec;
                //Sheet.Cells[string.Format("D2", row)].Value = "Fecha Final";
                //Sheet.Cells[string.Format("E2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                //Sheet.Cells[string.Format("E2", row)].Value = FF;
                //En la fila3 se da el formato a el encabezado
                row = 3;
                Sheet.Cells.Style.Font.Name = "Calibri";
                Sheet.Cells.Style.Font.Size = 10;
                Sheet.Cells["A3:X3"].Style.Font.Bold = true;
                Sheet.Cells["A3:X3"].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                Sheet.Cells["A3:X3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                // Se establece el nombre que identifica a cada una de las columnas de datos.

                Sheet.Cells["A3"].RichText.Add("Serie");
                Sheet.Cells["B3"].RichText.Add("Numero");
                Sheet.Cells["C3"].RichText.Add("Fecha");
                Sheet.Cells["D3"].RichText.Add("No.Expediente");
                Sheet.Cells["E3"].RichText.Add("Cliente");
                Sheet.Cells["F3"].RichText.Add("Subtotal");
                Sheet.Cells["G3"].RichText.Add("Iva");
                Sheet.Cells["H3"].RichText.Add("Total");
                Sheet.Cells["I3"].RichText.Add("Moneda");
                Sheet.Cells["J3"].RichText.Add("Tipo de Cambio");
                Sheet.Cells["K3"].RichText.Add("Importe Pagado");
                Sheet.Cells["L3"].RichText.Add("Al Corriente");
                Sheet.Cells["M3"].RichText.Add("0-7 días");
                Sheet.Cells["N3"].RichText.Add("8-14 días");
                Sheet.Cells["O3"].RichText.Add("14-21 días");
                Sheet.Cells["P3"].RichText.Add("22-30 días");
                Sheet.Cells["Q3"].RichText.Add("31-60 días");
                Sheet.Cells["R3"].RichText.Add("61-90 días");
                Sheet.Cells["S3"].RichText.Add("91 o mas");
                //Sheet.Cells["M3"].RichText.Add("Saldo Insoluto");
                Sheet.Cells["T3"].RichText.Add("Fecha de Revisión");
                Sheet.Cells["U3"].RichText.Add("Fecha de Vencimiento");
                Sheet.Cells["V3"].RichText.Add("Oficina");
                Sheet.Cells["W3"].RichText.Add("Vendedor");
                Sheet.Cells["X3"].RichText.Add("Teléfono Cliente");
                //.Value solo trae datos, sin formato, a diferencia de .RichText que permite aplicar: tipos, tamaños, colores, negrita
                //Sheet.Cells["A3"].Value = "Serie";
                //Aplicar borde doble al rango de celdas A3:Q3
                Sheet.Cells["A3:X3"].Style.Border.Bottom.Style = ExcelBorderStyle.Double;

                // en la fila4, el foreach llenara cada fila de la hoja de excel, con cada fila que trae de la bd.
                // Se establecen los formatos para las celdas: Fecha, Moneda
                row = 4;
                Sheet.Cells.Style.Font.Bold = false;
                foreach (EncFacturaOfVen item in ViewBag.facturassaldos)
                {
                    Sheet.Cells[string.Format("A{0}", row)].Value = item.Serie;
                    Sheet.Cells[string.Format("B{0}", row)].Value = item.Numero;
                    Sheet.Cells[string.Format("C{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("C{0}", row)].Value = item.Fecha;
                    if (item.NoExpediente == null)
                    {
                        Sheet.Cells[string.Format("D{0}", row)].Value = "S/N";
                    }
                    else
                    {
                        Sheet.Cells[string.Format("D{0}", row)].Value = item.NoExpediente;
                    }
                    Sheet.Cells[string.Format("E{0}", row)].Value = item.Nombre_cliente;
                    Sheet.Cells[string.Format("F{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("F{0}", row)].Value = item.Subtotal;
                    Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("G{0}", row)].Value = item.IVA;

                    Sheet.Cells[string.Format("H{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("H{0}", row)].Value = item.Total;
                    Sheet.Cells[string.Format("I{0}", row)].Value = item.Moneda;
                    Sheet.Cells[string.Format("J{0}", row)].Style.Numberformat.Format = "#,##0.00";
                    Sheet.Cells[string.Format("J{0}", row)].Value = item.TC;
                    Sheet.Cells[string.Format("K{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("K{0}", row)].Value = item.ImportePagado;
                    ClsOperacionesFecha fechas = new ClsOperacionesFecha();
                    fechas.fechaini = item.FechaVencimiento;
                    fechas.fechafin = DateTime.Now;
                    if (fechas.getcorriente())
                    {
                        Sheet.Cells[string.Format("L{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("L{0}", row)].Value = item.ImporteSaldoInsoluto;
                    }
                    else
                    {
                        Sheet.Cells[string.Format("L{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("L{0}", row)].Value = 0;
                    }

                    if (fechas.get7())
                    {

                        Sheet.Cells[string.Format("M{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("M{0}", row)].Value = item.ImporteSaldoInsoluto;
                    }
                    else
                    {
                        Sheet.Cells[string.Format("M{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("M{0}", row)].Value = 0;
                    }

                    if (fechas.get814())
                    {

                        Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("N{0}", row)].Value = item.ImporteSaldoInsoluto;
                    }
                    else
                    {
                        Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("N{0}", row)].Value = 0;
                    }

                    if (fechas.get1421())
                    {

                        Sheet.Cells[string.Format("O{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("O{0}", row)].Value = item.ImporteSaldoInsoluto;
                    }
                    else
                    {
                        Sheet.Cells[string.Format("O{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("O{0}", row)].Value = 0;
                    }

                    if (fechas.get2230())
                    {

                        Sheet.Cells[string.Format("P{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("P{0}", row)].Value = item.ImporteSaldoInsoluto;
                    }
                    else
                    {
                        Sheet.Cells[string.Format("P{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("P{0}", row)].Value = 0;
                    }

                    

                    if (fechas.get3160())
                    {
                        Sheet.Cells[string.Format("Q{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("Q{0}", row)].Value = item.ImporteSaldoInsoluto;

                    }
                    else
                    {
                        Sheet.Cells[string.Format("Q{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("Q{0}", row)].Value = 0;
                    }

                    if (fechas.get6190())
                    {
                        Sheet.Cells[string.Format("R{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("R{0}", row)].Value = item.ImporteSaldoInsoluto;

                    }
                    else
                    {
                        Sheet.Cells[string.Format("R{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("R{0}", row)].Value = 0;
                    }

                    if (fechas.get91mas())
                    {
                        Sheet.Cells[string.Format("S{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("S{0}", row)].Value = item.ImporteSaldoInsoluto;
                    }
                    else
                    {
                        Sheet.Cells[string.Format("S{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("S{0}", row)].Value = 0;
                    }
                    //Sheet.Cells[string.Format("L{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    //Sheet.Cells[string.Format("L{0}", row)].Value = item.ImporteSaldoInsoluto;
                    Sheet.Cells[string.Format("T{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("T{0}", row)].Value = item.FechaRevision;
                    Sheet.Cells[string.Format("U{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("U{0}", row)].Value = item.FechaVencimiento;
                    Sheet.Cells[string.Format("V{0}", row)].Value = item.Oficina;
                    Sheet.Cells[string.Format("W{0}", row)].Value = item.Vendedor;
                    Sheet.Cells[string.Format("X{0}", row)].Value = item.Telefono;

                    row++;
                }
                //Se genera el archivo y se descarga

                Sheet.Cells["A:AZ"].AutoFitColumns();
                Response.Clear();
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
                Response.AddHeader("content-disposition", "attachment: filename=" + "ReporteExcelFacturasCliente.xlsx");
                Response.BinaryWrite(Ep.GetAsByteArray());
                Response.End();
                return Redirect("/blah");
            }
            return Redirect("index");



            AntiguedadSaldos report = new AntiguedadSaldos();
            byte[] abytes = report.PrepareReport(idcliente);
            return File(abytes, "application/pdf");
        }

        public ActionResult AntiguedadSaldosV()
        {
            List<Vendedor> ven = new List<Vendedor>();
            string cadena = "select  * from Vendedor order by Vendedor.Nombre";
            ven = db.Database.SqlQuery<Vendedor>(cadena).ToList();
            List<SelectListItem> listaven = new List<SelectListItem>();
            listaven.Add(new SelectListItem { Text = "--Selecciona Vendedor--", Value = "0" });

            foreach (var m in ven)
            {
                listaven.Add(new SelectListItem { Text = m.Nombre, Value = m.IDVendedor.ToString() });
            }
            ViewBag.vendedor = listaven;




            return View();
        }

        [HttpPost]
        public ActionResult AntiguedadSaldosV(AntiguedadSaldosVen r, ClientesFacturasAV C)
        {
            int idvendedor = C.IDVendedor;
            try
            {

                VendedorContext dbc = new VendedorContext();
                Vendedor cls = dbc.Vendedores.Find(C.IDVendedor);
            }
            catch (Exception ERR)
            {

            }



            AntiguedadSaldosVen report = new AntiguedadSaldosVen();
            byte[] abytes = report.PrepareReport(idvendedor);
            return File(abytes, "application/pdf");
        }
 		public ActionResult FechaRevision(int id)
        {
            var elemento = db.encfacturas.Single(m => m.ID == id);
            return View(elemento);
        }

        [HttpPost]
        //[ValidateAntiForgeryToken]
        public ActionResult FechaRevision(Encfacturas encF, FormCollection collection, int id)
        {
            encF.FechaRevision = DateTime.Parse(collection.Get("FechaRevision"));

            DateTime FechaRe = encF.FechaRevision;
           
            try
            {
                
                var elemento = db.encfacturas.Single(m => m.ID == id);
               
                

                ClsDatoEntero contarfac = db.Database.SqlQuery<ClsDatoEntero>("select EncPrefactura.idCondicionesPago as dato from EncFacturas inner join EncPrefactura on EncFacturas.numero=EncPrefactura.numero and EncFacturas.serie=[EncPrefactura].serie and EncPrefactura.IDCondicionesPago <> 10 and EncPrefactura.IDCondicionesPago <>1 and EncPrefactura.IDCondicionesPago <>2  where EncFacturas.id=" + id).ToList().FirstOrDefault();
                int conPago = contarfac.Dato;
                string d = "select DiasCredito as dato from [CondicionesPago]  where idCondicionesPago=" + conPago;
                    ClsDatoDecimal DIASCRE = db.Database.SqlQuery<ClsDatoDecimal>(d).ToList().FirstOrDefault();
                decimal diasCredito = DIASCRE.Dato;
               

                DateTime FechaVen = FechaRe.AddDays(Convert.ToInt32(diasCredito));

                string cadena = "update EncFacturas set FechaRevision='" + FechaRe.Year + "-" + FechaRe.Month + "-" + FechaRe.Day + "', FechaVencimiento='"+ FechaVen.Year + "-" + FechaVen.Month + "-" + FechaVen.Day + "' where ID=" + id;
                db.Database.ExecuteSqlCommand(cadena);





            }
            catch (Exception err)
            {
                return View("index");

            }

            

            return View();

        }


        public void GenerarExcelFacturas(int num)
        {

            //Generar el listado de datos
            if (num == 1)
            {
                //var facturassaldos = dbs.EncfacturasSaldos.ToList();
                //Todas las facturas
                var facturassaldos = dbs.Database.SqlQuery<VEncfacturasSaldosVen>("select * from [dbo].[VEncfacturasSaldosVen]").ToList();
                ViewBag.facturassaldos = facturassaldos;
            }
            if (num == 12)
            {
                ////Facturas de los ultimos 12 meses
                DateTime fecha = DateTime.Parse(DateTime.Now.Year + "-" + DateTime.Now.Month + "-01").AddMonths(-12);

                var facturassaldos = dbs.Database.SqlQuery<VEncfacturasSaldosVen>("select * from [dbo].[VEncfacturasSaldosVen] where Fecha >= '" + fecha.Year + "-" + fecha.Month + " -01'").ToList();
                ViewBag.facturassaldos = facturassaldos;
            }
            if (num == 6)
            {
                //Facturas de los ultimos 6 meses

                DateTime fecha = DateTime.Parse(DateTime.Now.Year + "-" + DateTime.Now.Month + "-01").AddMonths(-6);
                var facturassaldos = dbs.Database.SqlQuery<VEncfacturasSaldosVen>("select * from [dbo].[VEncfacturasSaldosVen] where Fecha >= '" + fecha.Year + "-" + fecha.Month + " -01'").ToList();
                ViewBag.facturassaldos = facturassaldos;
            }
            if (num == 3)
            {
                //Facturas de los ultimos 9 meses
                DateTime fecha = DateTime.Parse(DateTime.Now.Year + "-" + DateTime.Now.Month + "-01").AddMonths(-3);
                var facturassaldos = dbs.Database.SqlQuery<VEncfacturasSaldosVen>("select * from [dbo].[VEncfacturasSaldosVen] where Fecha >= '" + fecha.Year + "-" + fecha.Month + " -01'").ToList();
                ViewBag.facturassaldos = facturassaldos;
            }
            ExcelPackage Ep = new ExcelPackage();
            //Crear la hoja y poner el nombre de la pestaña del libro
            var Sheet = Ep.Workbook.Worksheets.Add("Facturas");

            // en la fila1 formateo las celdas y coloco el título de la hoja
            // RichText permite agregar las propiedades de tipo de letra: color, negrita, etc.
            int row = 1;
            //Fijar la fuente para A1:Q1
            Sheet.Cells["A1:V1"].Style.Font.Size = 20;
            Sheet.Cells["A1:V1"].Style.Font.Name = "Calibri";
            Sheet.Cells["A1:V3"].Style.Font.Bold = true;
            Sheet.Cells["A1:V1"].Style.Font.Color.SetColor(Color.DarkBlue);
            Sheet.Cells["A1:V1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
            Sheet.Cells["A1"].RichText.Add("Listado de Facturas");

            row = 2;
            Sheet.Cells["A1:V1"].Style.Font.Size = 12;
            Sheet.Cells["A1:V1"].Style.Font.Name = "Calibri";
            Sheet.Cells["A1:V1"].Style.Border.Bottom.Style = ExcelBorderStyle.Hair;
            Sheet.Cells["A2:V2"].Style.Font.Bold = true;
            //Subtitulo según el filtrado de datos
            if (num == 1)
            {
                Sheet.Cells["A2"].RichText.Add("Listado de todas las Facturas");
            }
            if (num == 12)
            {
                Sheet.Cells["A2"].RichText.Add("Listado de las Facturas de los 12 últimos meses");
            }
            if (num == 6)
            {
                Sheet.Cells["A2"].RichText.Add("Listado de las Facturas de los 6 últimos meses");
            }
            if (num == 3)
            {
                Sheet.Cells["A2"].RichText.Add("Listado de las Facturas de los 3 últimos meses");
            }

            //En la fila3 se da el formato a el encabezado
            row = 3;
            Sheet.Cells.Style.Font.Name = "Calibri";
            Sheet.Cells.Style.Font.Size = 10;
            Sheet.Cells["A3:V3"].Style.Font.Bold = true;
            Sheet.Cells["A3:V3"].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
            Sheet.Cells["A3:V3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

            // Se establece el nombre que identifica a cada una de las columnas de datos.
            Sheet.Cells["A3"].RichText.Add("Serie");
            Sheet.Cells["B3"].RichText.Add("Numero");
            Sheet.Cells["C3"].RichText.Add("Fecha");
            Sheet.Cells["D3"].RichText.Add("Cliente");
            Sheet.Cells["E3"].RichText.Add("Subtotal");
            Sheet.Cells["F3"].RichText.Add("Iva");
            Sheet.Cells["G3"].RichText.Add("Total");
            Sheet.Cells["H3"].RichText.Add("Moneda");
            Sheet.Cells["I3"].RichText.Add("Tipo de Cambio Factura");
            Sheet.Cells["J3"].RichText.Add("Tipo de Cambio Del Día");
            Sheet.Cells["K3"].RichText.Add("Metodo de pago");
            Sheet.Cells["L3"].RichText.Add("UUID");
            Sheet.Cells["M3"].RichText.Add("Estado");
            Sheet.Cells["N3"].RichText.Add("Pagada");
            Sheet.Cells["O3"].RichText.Add("Importe Pagado");
            Sheet.Cells["P3"].RichText.Add("Saldo Insoluto");
            Sheet.Cells["Q3"].RichText.Add("Fecha de Revisión");
            Sheet.Cells["R3"].RichText.Add("Fecha de Vencimiento");
            Sheet.Cells["S3"].RichText.Add("Dias Vencidos");
            Sheet.Cells["T3"].RichText.Add("Telefono");
            Sheet.Cells["U3"].RichText.Add("Vendedor");
            Sheet.Cells["V3"].RichText.Add("Oficina");
            //.Value solo trae datos, sin formato, a diferencia de .RichText que permite aplicar: tipos, tamaños, colores, negrita
            //Sheet.Cells["A3"].Value = "Serie";

            //Aplicar borde doble al rango de celdas A3:Q3
            Sheet.Cells["A3:S3"].Style.Border.Bottom.Style = ExcelBorderStyle.Double;

            // en la fila4, el foreach llenara cada fila de la hoja de excel, con cada fila que trae de la bd.
            // Se establecen los formatos para las celdas: Fecha, Moneda
            row = 4;
            Sheet.Cells.Style.Font.Bold = false;
            foreach (var item in ViewBag.facturassaldos)
            {

                Sheet.Cells[string.Format("A{0}", row)].Value = item.Serie;
                Sheet.Cells[string.Format("B{0}", row)].Value = item.Numero;
                Sheet.Cells[string.Format("C{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("C{0}", row)].Value = item.Fecha;
                Sheet.Cells[string.Format("D{0}", row)].Value = item.Nombre_cliente;
                Sheet.Cells[string.Format("E{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("E{0}", row)].Value = item.Subtotal;
                Sheet.Cells[string.Format("F{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("F{0}", row)].Value = item.IVA;
                Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("G{0}", row)].Value = item.Total;
                Sheet.Cells[string.Format("H{0}", row)].Value = item.Moneda;
                Sheet.Cells[string.Format("I{0}", row)].Value = item.TC;
                string fecfac = item.Fecha.Year.ToString() + "-" + item.Fecha.Month.ToString() + "-" + item.Fecha.Day.ToString();
                decimal tcd = db.Database.SqlQuery<ClsDatoDecimal>("select [dbo].[GetTipocambioCadena]('" + fecfac + "','USD', 'MXN') as Dato").ToList().FirstOrDefault().Dato;
                Sheet.Cells[string.Format("J{0}", row)].Value = tcd;

                Sheet.Cells[string.Format("K{0}", row)].Value = item.IDMetododepago;
                Sheet.Cells[string.Format("L{0}", row)].Value = item.UUID;
                Sheet.Cells[string.Format("M{0}", row)].Value = item.Estado;
                //Como item.pagada es de tipo booleano (verdadero o falso), se imprime en pantalla (si o no), según corresponda.
                if (item.pagada == false)
                {
                    Sheet.Cells[string.Format("N{0}", row)].Value = "No";
                }
                else
                {
                    Sheet.Cells[string.Format("N{0}", row)].Value = "Si";
                }
                Sheet.Cells[string.Format("O{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("O{0}", row)].Value = item.ImportePagado;
                Sheet.Cells[string.Format("P{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                Sheet.Cells[string.Format("P{0}", row)].Value = item.ImporteSaldoInsoluto;

                Sheet.Cells[string.Format("Q{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("Q{0}", row)].Value = item.FechaRevision;
                Sheet.Cells[string.Format("R{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("R{0}", row)].Value = item.FechaVencimiento;
                ClsOperacionesFecha fecha = new ClsOperacionesFecha();
                fecha.fechaini = item.FechaVencimiento;
                fecha.fechafin = DateTime.Now;
                int diasvencidos = fecha.getDiferencia();
                if (item.ImporteSaldoInsoluto < 0.10M)
                { diasvencidos = 0; }

                Sheet.Cells[string.Format("S{0}", row)].Value = diasvencidos;
                Sheet.Cells[string.Format("T{0}", row)].Value = item.Telefono;
                Sheet.Cells[string.Format("U{0}", row)].Value = item.Vendedor;
                Sheet.Cells[string.Format("V{0}", row)].Value = item.NombreOficina;
                row++;
            }
            //Se genera el archivo y se descarga

            Sheet.Cells["A:AZ"].AutoFitColumns();
            Response.Clear();
            Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
            Response.AddHeader("content-disposition", "attachment: filename=" + "ReporteExcelFacturas.xlsx");
            Response.BinaryWrite(Ep.GetAsByteArray());
            Response.End();
        }
        public ActionResult EntreFechasLFac()
        {
            fechasReporteFac elemento = new fechasReporteFac();


            return View(elemento);
        }


        [HttpPost]
        public ActionResult EntreFechasLFac(ReporteListadoF modelo, FormCollection coleccion)
        {
            string FI = modelo.fechaini.Year.ToString() + "-" + modelo.fechaini.Month.ToString() + "-" + modelo.fechaini.Day.ToString();
            string FF = modelo.fechafin.Year.ToString() + "-" + modelo.fechafin.Month.ToString() + "-" + modelo.fechafin.Day.ToString();

            string cual = coleccion.Get("Enviar");
            if (cual == "Generar reporte")
            {
                ReporteListadoF report = new ReporteListadoF();
                //byte[] abytes = report.PrepareReport(DateTime.Parse("2019-07-01"),DateTime.Parse( "2019-07-30"));
                byte[] abytes = report.PrepareReport(modelo.fechaini, modelo.fechafin);
                return File(abytes, "application/pdf", "ReporteSaldoFactura.pdf");
            }
            else
            {
                EncFacturaOfVenContext dbe = new EncFacturaOfVenContext();
                string cadena = "select * from [dbo].[EncFacturaOfVen] where Fecha >= '" + FI + "' and Fecha <='" + FF + "'";
                var facturassaldos = dbe.Database.SqlQuery<EncFacturaOfVen>(cadena).ToList();
                ViewBag.facturassaldos = facturassaldos;
                ExcelPackage Ep = new ExcelPackage();
                //Crear la hoja y poner el nombre de la pestaña del libro
                var Sheet = Ep.Workbook.Worksheets.Add("Facturas");

                // en la fila1 formateo las celdas y coloco el título de la hoja
                // RichText permite agregar las propiedades de tipo de letra: color, negrita, etc.
                int row = 1;
                //Fijar la fuente para A1:Q1
                Sheet.Cells["A1:X1"].Style.Font.Size = 20;
                Sheet.Cells["A1:X1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:X3"].Style.Font.Bold = true;
                Sheet.Cells["A1:X1"].Style.Font.Color.SetColor(Color.DarkBlue);
                Sheet.Cells["A1:X1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["A1"].RichText.Add("Listado de Facturas");

                row = 2;
                Sheet.Cells["A1:X1"].Style.Font.Size = 12;
                Sheet.Cells["A1:X1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:X1"].Style.Border.Bottom.Style = ExcelBorderStyle.Hair;
                Sheet.Cells["A2:X2"].Style.Font.Bold = true;
                //Subtitulo según el filtrado del periodo de datos
                row = 2;
                Sheet.Cells[string.Format("A2", row)].Value = "Fecha inicial";
                Sheet.Cells[string.Format("B2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("B2", row)].Value = FI;
                Sheet.Cells[string.Format("D2", row)].Value = "Fecha Final";
                Sheet.Cells[string.Format("E2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("E2", row)].Value = FF;
                //En la fila3 se da el formato a el encabezado
                row = 3;
                Sheet.Cells.Style.Font.Name = "Calibri";
                Sheet.Cells.Style.Font.Size = 10;
                Sheet.Cells["A3:X3"].Style.Font.Bold = true;
                Sheet.Cells["A3:X3"].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                Sheet.Cells["A3:X3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                // Se establece el nombre que identifica a cada una de las columnas de datos.
                Sheet.Cells["A3"].RichText.Add("Serie");
                Sheet.Cells["B3"].RichText.Add("Numero");
                Sheet.Cells["C3"].RichText.Add("Fecha");
                Sheet.Cells["D3"].RichText.Add("Cliente");
                Sheet.Cells["E3"].RichText.Add("Subtotal");
                Sheet.Cells["F3"].RichText.Add("Iva");
                Sheet.Cells["G3"].RichText.Add("Total");
                Sheet.Cells["H3"].RichText.Add("Moneda");
                Sheet.Cells["I3"].RichText.Add("Tipo de Cambio");
                Sheet.Cells["J3"].RichText.Add("Metodo de pago");
                Sheet.Cells["K3"].RichText.Add("UUID");
                Sheet.Cells["L3"].RichText.Add("Estado");
                Sheet.Cells["M3"].RichText.Add("Pagada");
                Sheet.Cells["N3"].RichText.Add("Importe Pagado");
                Sheet.Cells["O3"].RichText.Add("Saldo Insoluto");
                Sheet.Cells["P3"].RichText.Add("Fecha de Revisión");
                Sheet.Cells["Q3"].RichText.Add("Fecha de Vencimiento");
                Sheet.Cells["R3"].RichText.Add("Telefono");
                Sheet.Cells["S3"].RichText.Add("IDOficina");
                Sheet.Cells["T3"].RichText.Add("Oficina");
                Sheet.Cells["U3"].RichText.Add("IDVendedor");
                Sheet.Cells["V3"].RichText.Add("Vendedor");
                Sheet.Cells["W3"].RichText.Add("TipoCliente");
                Sheet.Cells["X3"].RichText.Add("Fecha Alta");



                //.Value solo trae datos, sin formato, a diferencia de .RichText que permite aplicar: tipos, tamaños, colores, negrita
                //Sheet.Cells["A3"].Value = "Serie";

                //Aplicar borde doble al rango de celdas A3:Q3
                Sheet.Cells["A3:X3"].Style.Border.Bottom.Style = ExcelBorderStyle.Double;

                // en la fila4, el foreach llenara cada fila de la hoja de excel, con cada fila que trae de la bd.
                // Se establecen los formatos para las celdas: Fecha, Moneda
                row = 4;
                Sheet.Cells.Style.Font.Bold = false;
                foreach (var item in ViewBag.facturassaldos)
                {

                    Sheet.Cells[string.Format("A{0}", row)].Value = item.Serie;
                    Sheet.Cells[string.Format("B{0}", row)].Value = item.Numero;
                    Sheet.Cells[string.Format("C{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("C{0}", row)].Value = item.Fecha;
                    Sheet.Cells[string.Format("D{0}", row)].Value = item.Nombre_cliente;
                    Sheet.Cells[string.Format("E{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("E{0}", row)].Value = item.Subtotal;
                    Sheet.Cells[string.Format("F{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("F{0}", row)].Value = item.IVA;
                    Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("G{0}", row)].Value = item.Total;
                    Sheet.Cells[string.Format("H{0}", row)].Value = item.Moneda;
                    Sheet.Cells[string.Format("I{0}", row)].Value = item.TC;
                    Sheet.Cells[string.Format("J{0}", row)].Value = item.IDMetododepago;
                    Sheet.Cells[string.Format("K{0}", row)].Value = item.UUID;
                    Sheet.Cells[string.Format("L{0}", row)].Value = item.Estado;
                    //Como item.pagada es de tipo booleano (verdadero o falso), se imprime en pantalla (si o no), según corresponda.
                    if (item.pagada == false)
                    {
                        Sheet.Cells[string.Format("M{0}", row)].Value = "No";
                    }
                    else
                    {
                        Sheet.Cells[string.Format("M{0}", row)].Value = "Si";
                    }
                    Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("N{0}", row)].Value = item.ImportePagado;
                    Sheet.Cells[string.Format("O{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("O{0}", row)].Value = item.ImporteSaldoInsoluto;

                    Sheet.Cells[string.Format("P{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("P{0}", row)].Value = item.FechaRevision;
                    Sheet.Cells[string.Format("Q{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("Q{0}", row)].Value = item.FechaVencimiento;
                    Sheet.Cells[string.Format("R{0}", row)].Value = item.Telefono;
                    Sheet.Cells[string.Format("S{0}", row)].Value = item.IDOficina;
                    Sheet.Cells[string.Format("T{0}", row)].Value = item.Oficina;
                    Sheet.Cells[string.Format("U{0}", row)].Value = item.IDVendedor;
                    Sheet.Cells[string.Format("V{0}", row)].Value = item.Vendedor;


                    Sheet.Cells[string.Format("W{0}", row)].Value = item.TipoCliente;

                    row++;
                }
                //Se genera el archivo y se descarga

                Sheet.Cells["A:AZ"].AutoFitColumns();
                Response.Clear();
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
                Response.AddHeader("content-disposition", "attachment: filename=" + "ReporteExcelFacturas.xlsx");
                Response.BinaryWrite(Ep.GetAsByteArray());
                Response.End();
                return Redirect("/blah");
            }
            //return Redirect("index");
        }

        public ActionResult EntreFechasLFacClie()
        {
            fechasReporteFacClie elemento = new fechasReporteFacClie();
            ClientesContext dbc = new ClientesContext();
            //ViewBag.idcliente = new SelectList(dbc.Clientes, "IDCliente", "Nombre");
            ViewBag.idcliente = new ClienteAllRepository().GetClientes();
            return View(elemento);
        }

        [HttpPost]
        public ActionResult EntreFechasLFacClie(ReporteListadoFClie modelo, FormCollection coleccion)
        {
            string FI = modelo.fechaini.Year.ToString() + "-" + modelo.fechaini.Month.ToString() + "-" + modelo.fechaini.Day.ToString();
            string FF = modelo.fechafin.Year.ToString() + "-" + modelo.fechafin.Month.ToString() + "-" + modelo.fechafin.Day.ToString();
            int idClie = modelo.idcliente;
            string cual = coleccion.Get("Enviar");
            string cadena = "";
            if (cual == "Generar reporte")
            {
                ReporteListadoFClie report = new ReporteListadoFClie();
                //byte[] abytes = report.PrepareReport(DateTime.Parse("2019-07-01"),DateTime.Parse( "2019-07-30"));
                byte[] abytes = report.PrepareReport(modelo.fechaini, modelo.fechafin, modelo.idcliente);
                return File(abytes, "application/pdf", "ListadoFacturasClientes.pdf");
            }
            else
            {
                if (modelo.idcliente == 0)
                {
                    cadena = "select * from [dbo].[EncfacturasSaldos] where Fecha >= '" + FI + "' and Fecha <='" + FF + "' ";
                }
                else
                {
                    ClsDatoString cliente = db.Database.SqlQuery<ClsDatoString>("select Nombre as Dato  from [dbo].[Clientes] where IDCliente = '" + modelo.idcliente + "'").ToList()[0];
                    cadena = "select * from [dbo].[EncfacturasSaldos] where Fecha >= '" + FI + "' and Fecha <='" + FF + "' and Nombre_Cliente = '" + cliente.Dato + "' ";
                }


                List<EncfacturasSaldos> facturassaldos = dbs.Database.SqlQuery<EncfacturasSaldos>(cadena).ToList();
                ViewBag.facturassaldos = facturassaldos;
                ExcelPackage Ep = new ExcelPackage();
                //Crear la hoja y poner el nombre de la pestaña del libro
                var Sheet = Ep.Workbook.Worksheets.Add("Facturas");

                // en la fila1 formateo las celdas y coloco el título de la hoja
                // RichText permite agregar las propiedades de tipo de letra: color, negrita, etc.
                int row = 1;
                //Fijar la fuente para A1:Q1
                Sheet.Cells["A1:S1"].Style.Font.Size = 20;
                Sheet.Cells["A1:S1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:S3"].Style.Font.Bold = true;
                Sheet.Cells["A1:S1"].Style.Font.Color.SetColor(Color.DarkBlue);
                Sheet.Cells["A1:S1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["A1"].RichText.Add("Listado de Facturas");

                row = 2;
                Sheet.Cells["A1:S1"].Style.Font.Size = 12;
                Sheet.Cells["A1:S1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:S1"].Style.Border.Bottom.Style = ExcelBorderStyle.Hair;
                Sheet.Cells["A2:S2"].Style.Font.Bold = true;
                //Subtitulo según el filtrado del periodo de datos
                row = 2;
                Sheet.Cells[string.Format("A2", row)].Value = "Fecha inicial";
                Sheet.Cells[string.Format("B2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("B2", row)].Value = FI;
                Sheet.Cells[string.Format("D2", row)].Value = "Fecha Final";
                Sheet.Cells[string.Format("E2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("E2", row)].Value = FF;
                //En la fila3 se da el formato a el encabezado
                row = 3;
                Sheet.Cells.Style.Font.Name = "Calibri";
                Sheet.Cells.Style.Font.Size = 10;
                Sheet.Cells["A3:S3"].Style.Font.Bold = true;
                Sheet.Cells["A3:S3"].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                Sheet.Cells["A3:S3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                // Se establece el nombre que identifica a cada una de las columnas de datos.
                Sheet.Cells["A3"].RichText.Add("Serie");
                Sheet.Cells["B3"].RichText.Add("Numero");
                Sheet.Cells["C3"].RichText.Add("Fecha");
                Sheet.Cells["D3"].RichText.Add("Cliente");
                Sheet.Cells["E3"].RichText.Add("Subtotal");
                Sheet.Cells["F3"].RichText.Add("Iva");
                Sheet.Cells["G3"].RichText.Add("Total");
                Sheet.Cells["H3"].RichText.Add("Moneda");
                Sheet.Cells["I3"].RichText.Add("Tipo de Cambio");
                Sheet.Cells["J3"].RichText.Add("Metodo de pago");
                Sheet.Cells["K3"].RichText.Add("UUID");
                Sheet.Cells["L3"].RichText.Add("Estado");
                Sheet.Cells["M3"].RichText.Add("Pagada");
                Sheet.Cells["N3"].RichText.Add("Importe Pagado");
                Sheet.Cells["O3"].RichText.Add("Saldo Insoluto");
                Sheet.Cells["P3"].RichText.Add("Fecha de Revisión");
                Sheet.Cells["Q3"].RichText.Add("Fecha de Vencimiento");
                Sheet.Cells["R3"].RichText.Add("Telefono");
                Sheet.Cells["S3"].RichText.Add("Vendedor");
   //.Value solo trae datos, sin formato, a diferencia de .RichText que permite aplicar: tipos, tamaños, colores, negrita
                //Sheet.Cells["A3"].Value = "Serie";

                //Aplicar borde doble al rango de celdas A3:Q3
                Sheet.Cells["A3:R3"].Style.Border.Bottom.Style = ExcelBorderStyle.Double;

                // en la fila4, el foreach llenara cada fila de la hoja de excel, con cada fila que trae de la bd.
                // Se establecen los formatos para las celdas: Fecha, Moneda
                row = 4;
                Sheet.Cells.Style.Font.Bold = false;
                foreach (EncfacturasSaldos item in ViewBag.facturassaldos)
                {

                   

                    Sheet.Cells[string.Format("A{0}", row)].Value = item.Serie;
                    Sheet.Cells[string.Format("B{0}", row)].Value = item.Numero;
                    Sheet.Cells[string.Format("C{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("C{0}", row)].Value = item.Fecha;
                    Sheet.Cells[string.Format("D{0}", row)].Value = item.Nombre_cliente;
                    Sheet.Cells[string.Format("E{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("E{0}", row)].Value = item.Subtotal;
                    Sheet.Cells[string.Format("F{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("F{0}", row)].Value = item.IVA;
                    Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("G{0}", row)].Value = item.Total;
                    Sheet.Cells[string.Format("H{0}", row)].Value = item.Moneda;
                    Sheet.Cells[string.Format("I{0}", row)].Value = item.TC;
                    Sheet.Cells[string.Format("J{0}", row)].Value = item.IDMetododepago;
                    Sheet.Cells[string.Format("K{0}", row)].Value = item.UUID;
                    Sheet.Cells[string.Format("L{0}", row)].Value = item.Estado;
                    //Como item.pagada es de tipo booleano (verdadero o falso), se imprime en pantalla (si o no), según corresponda.
                    if (item.pagada == false)
                    {
                        Sheet.Cells[string.Format("M{0}", row)].Value = "No";
                    }
                    else
                    {
                        Sheet.Cells[string.Format("M{0}", row)].Value = "Si";
                    }
                    Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("N{0}", row)].Value = item.ImportePagado;
                    Sheet.Cells[string.Format("O{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("O{0}", row)].Value = item.ImporteSaldoInsoluto;

                    Sheet.Cells[string.Format("P{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("P{0}", row)].Value = item.FechaRevision;
                    Sheet.Cells[string.Format("Q{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("Q{0}", row)].Value = item.FechaVencimiento;
                    Sheet.Cells[string.Format("R{0}", row)].Value = item.Telefono;
                    string cadenaf = "select * from encprefactura where seriedigital='" + item.Serie + "' and numerodigital=" + item.Numero;

                    try
                    {
                        EncPrefactura prefac = new PrefacturaContext().Database.SqlQuery<EncPrefactura>(cadenaf).ToList().FirstOrDefault();

                        Vendedor vendedor = new VendedorContext().Vendedores.Find(prefac.IDVendedor);
                        Sheet.Cells[string.Format("S{0}", row)].Value = vendedor.Nombre;
                    }
                    catch (Exception err)
                    {
                        Sheet.Cells[string.Format("S{0}", row)].Value = "Sin vendedor";
                    }
                    row++;
                }
                //Se genera el archivo y se descarga

                Sheet.Cells["A:AZ"].AutoFitColumns();
                Response.Clear();
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
                Response.AddHeader("content-disposition", "attachment: filename=" + "ReporteExcelFacturas.xlsx");
                Response.BinaryWrite(Ep.GetAsByteArray());
                Response.End();
                return Redirect("/blah");
            }
            //return Redirect("index");
        }

        public ActionResult EntreFechasNC()
        {
            EFecha elemento = new EFecha();

            return View(elemento);
        }

        [HttpPost]
        public ActionResult EntreFechasNC(EFecha modelo, FormCollection coleccion)
        {
            string FI = modelo.fechaini.Year.ToString() + "-" + modelo.fechaini.Month.ToString() + "-" + modelo.fechaini.Day.ToString();
            string FF = modelo.fechafin.Year.ToString() + "-" + modelo.fechafin.Month.ToString() + "-" + modelo.fechafin.Day.ToString();

            string cual = coleccion.Get("Enviar");
            if (cual == "Generar reporte")
            {

            }
            if (cual == "Generar excel")
            {

                string cadena = "select * from [dbo].[Encfacturas] where Serie = 'N' and (Fecha >= '" + FI + "' and Fecha <='" + FF + "')";
                var notas = dbs.Database.SqlQuery<Encfacturas>(cadena).ToList();
                ViewBag.notas = notas;
                ExcelPackage Ep = new ExcelPackage();
                //Crear la hoja y poner el nombre de la pestaña del libro
                var Sheet = Ep.Workbook.Worksheets.Add("Notas de Crédito");

                // en la fila1 formateo las celdas y coloco el título de la hoja
                // RichText permite agregar las propiedades de tipo de letra: color, negrita, etc.
                int row = 1;
                //Fijar la fuente para A1:Q1
                Sheet.Cells["A1:J1"].Style.Font.Size = 20;
                Sheet.Cells["A1:J1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:J3"].Style.Font.Bold = true;
                Sheet.Cells["A1:J1"].Style.Font.Color.SetColor(Color.DarkBlue);
                Sheet.Cells["A1:J1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["A1"].RichText.Add("Listado de Notas de Crédito");

                row = 2;
                Sheet.Cells["A1:J1"].Style.Font.Size = 12;
                Sheet.Cells["A1:J1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:J1"].Style.Border.Bottom.Style = ExcelBorderStyle.Hair;
                Sheet.Cells["A2:J2"].Style.Font.Bold = true;
                //Subtitulo según el filtrado del periodo de datos
                row = 2;
                Sheet.Cells[string.Format("A2", row)].Value = "Fecha inicial";
                Sheet.Cells[string.Format("B2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("B2", row)].Value = FI;
                Sheet.Cells[string.Format("D2", row)].Value = "Fecha Final";
                Sheet.Cells[string.Format("E2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("E2", row)].Value = FF;
                //En la fila3 se da el formato a el encabezado
                row = 3;
                Sheet.Cells.Style.Font.Name = "Calibri";
                Sheet.Cells.Style.Font.Size = 10;
                Sheet.Cells["A3:J3"].Style.Font.Bold = true;
                Sheet.Cells["A3:J3"].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                Sheet.Cells["A3:J3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                // Se establece el nombre que identifica a cada una de las columnas de datos.
                Sheet.Cells["A3"].RichText.Add("Serie");
                Sheet.Cells["B3"].RichText.Add("Numero");
                Sheet.Cells["C3"].RichText.Add("Fecha");
                Sheet.Cells["D3"].RichText.Add("Cliente");
                Sheet.Cells["E3"].RichText.Add("Subtotal");
                Sheet.Cells["F3"].RichText.Add("Iva");
                Sheet.Cells["G3"].RichText.Add("Total");
                Sheet.Cells["H3"].RichText.Add("Moneda");
                Sheet.Cells["I3"].RichText.Add("UUID");
                Sheet.Cells["J3"].RichText.Add("Estado");

                //.Value solo trae datos, sin formato, a diferencia de .RichText que permite aplicar: tipos, tamaños, colores, negrita
                //Sheet.Cells["A3"].Value = "Serie";

                //Aplicar borde doble al rango de celdas A3:Q3
                Sheet.Cells["A3:R3"].Style.Border.Bottom.Style = ExcelBorderStyle.Double;

                // en la fila4, el foreach llenara cada fila de la hoja de excel, con cada fila que trae de la bd.
                // Se establecen los formatos para las celdas: Fecha, Moneda
                row = 4;
                Sheet.Cells.Style.Font.Bold = false;
                foreach (Encfacturas item in ViewBag.notas)
                {


                    Sheet.Cells[string.Format("A{0}", row)].Value = item.Serie;
                    Sheet.Cells[string.Format("B{0}", row)].Value = item.Numero;
                    Sheet.Cells[string.Format("C{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("C{0}", row)].Value = item.Fecha;
                    Sheet.Cells[string.Format("D{0}", row)].Value = item.Nombre_cliente;
                    Sheet.Cells[string.Format("E{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("E{0}", row)].Value = item.Subtotal;
                    Sheet.Cells[string.Format("F{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("F{0}", row)].Value = item.IVA;
                    Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("G{0}", row)].Value = item.Total;
                    Sheet.Cells[string.Format("H{0}", row)].Value = item.Moneda;
                    Sheet.Cells[string.Format("I{0}", row)].Value = item.UUID;
                    Sheet.Cells[string.Format("J{0}", row)].Value = item.Estado;

                    row++;
                }
                //Se genera el archivo y se descarga

                Sheet.Cells["A:AZ"].AutoFitColumns();
                Response.Clear();
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
                Response.AddHeader("content-disposition", "attachment: filename=" + "ReporteExcelNC.xlsx");
                Response.BinaryWrite(Ep.GetAsByteArray());
                Response.End();
                return Redirect("/blah");
            }
            return Redirect("index");
        }


        public ActionResult HFacturacion()
        {
            EFecha elemento = new EFecha();

            return View(elemento);
        }

        [HttpPost]
        public ActionResult HFacturacion(EFecha modelo, FormCollection coleccion)
        {
            string FI = modelo.fechaini.Year.ToString() + "-" + modelo.fechaini.Month.ToString() + "-" + modelo.fechaini.Day.ToString();
            string FF = modelo.fechafin.Year.ToString() + "-" + modelo.fechafin.Month.ToString() + "-" + modelo.fechafin.Day.ToString();
            decimal antesT = 0;
            decimal enT = 0;
            decimal fueraT = 0;
            decimal antesTP = 0;
            decimal enTP = 0;
            decimal fueraTP = 0;
            decimal Tot = 0;

            string cual = coleccion.Get("Enviar");
            if (cual == "Generar reporte")
            {

            }
            if (cual == "Generar excel")
            {
                //Elimino la tabla temporal



                string quita = "IF OBJECT_ID(N'dbo.TempFacturacion', N'U') IS NOT NULL drop table dbo.TempFacturacion";
                db.Database.ExecuteSqlCommand(quita);
                //Crea la tabla temporal
                string crea = "SELECT * INTO dbo.TempFacturacion FROM dbo.VFacturacion WHERE FechaFac >= '" + FI + " 00:00:00.1' and FechaFac <= '" + FF + " 23:59:59.999' order by Ticket;";
                db.Database.ExecuteSqlCommand(crea);

                string cadena = "select * from dbo.TempFacturacion";
                TempFacturacionContext dbf = new TempFacturacionContext();
                var datos = dbf.Database.SqlQuery<TempFacturacion>(cadena).ToList();

                ViewBag.datos = datos;
                ExcelPackage Ep = new ExcelPackage();
                //Crear la hoja y poner el nombre de la pestaña del libro
                var Sheet = Ep.Workbook.Worksheets.Add("Facturación");

                // en la fila1 formateo las celdas y coloco el título de la hoja
                // RichText permite agregar las propiedades de tipo de letra: color, negrita, etc.
                int row = 1;
                //Fijar la fuente para A1:Q1
                Sheet.Cells["A1:J1"].Style.Font.Size = 20;
                Sheet.Cells["A1:J1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:J3"].Style.Font.Bold = true;
                Sheet.Cells["A1:J1"].Style.Font.Color.SetColor(Color.DarkBlue);
                Sheet.Cells["A1:J1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["A1"].RichText.Add("Facturación");

                row = 2;
                Sheet.Cells["A1:J1"].Style.Font.Size = 12;
                Sheet.Cells["A1:J1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:J1"].Style.Border.Bottom.Style = ExcelBorderStyle.Hair;
                Sheet.Cells["A2:J2"].Style.Font.Bold = true;
                //Subtitulo según el filtrado del periodo de datos
                row = 2;
                Sheet.Cells[string.Format("A2", row)].Value = "Fecha inicial";
                Sheet.Cells[string.Format("B2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("B2", row)].Value = FI;
                Sheet.Cells[string.Format("D2", row)].Value = "Fecha Final";
                Sheet.Cells[string.Format("E2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("E2", row)].Value = FF;
                Sheet.Cells[string.Format("G2", row)].Value = "Fecha Reporte";
                Sheet.Cells[string.Format("H2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                DateTime fecAct = DateTime.Today;
                Sheet.Cells[string.Format("H2", row)].Value = fecAct;
                row = 3;
                //En la fila3 se da el formato a el encabezado
                Sheet.Cells.Style.Font.Name = "Calibri";
                Sheet.Cells.Style.Font.Size = 10;
                Sheet.Cells["A3:N3"].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                Sheet.Cells["A3:N3"].Style.Font.Bold = true;

                // Se establece el nombre que identifica a cada una de las columnas de datos. 

                Sheet.Cells["A3:E3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Brown);
                Sheet.Cells["A3:E3"].Style.Fill.BackgroundColor.SetColor(Color.Goldenrod);
                Sheet.Cells[string.Format("A3", row)].Value = "Facturas";

                Sheet.Cells["F3:I3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["F3:I3"].Style.Font.Color.SetColor(Color.White);
                Sheet.Cells["F3:I3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.MidnightBlue);
                Sheet.Cells[string.Format("F3", row)].Value = "Prefactura";

                // Se establece el nombre que identifica a cada una de las columnas de datos. 
                Sheet.Cells["J3:K3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.Brown);
                Sheet.Cells["J3:K3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.Goldenrod);
                Sheet.Cells[string.Format("J3", row)].Value = "Remisión";

                Sheet.Cells["L3:N3"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["L3:N3"].Style.Font.Color.SetColor(Color.White);
                Sheet.Cells["L3:N3"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.MidnightBlue);
                Sheet.Cells[string.Format("L3", row)].Value = "Pedido";

                //Aplicar borde doble al rango de celdas A3:Q3
                Sheet.Cells["C3:H3"].Style.Border.Bottom.Style = ExcelBorderStyle.Hair;

                row = 4;
                Sheet.Cells.Style.Font.Name = "Calibri";
                Sheet.Cells.Style.Font.Size = 10;
                Sheet.Cells["A4:S4"].Style.Font.Bold = true;
                Sheet.Cells["A4:S4"].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;

                // Se establece el nombre que identifica a cada una de las columnas de datos.
                Sheet.Cells["A4:E4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.PaleGoldenrod);
                Sheet.Cells["A4"].RichText.Add("IDOperacion");
                Sheet.Cells["B4"].RichText.Add("Serie");
                Sheet.Cells["C4"].RichText.Add("Numero");
                Sheet.Cells["D4"].RichText.Add("Fecha");
                Sheet.Cells["E4"].RichText.Add("Estado");

                Sheet.Cells["F4:I4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.PowderBlue);
                Sheet.Cells["F4"].RichText.Add("ID");
                Sheet.Cells["G4"].RichText.Add("Serie");
                Sheet.Cells["H4"].RichText.Add("Numero");
                Sheet.Cells["I4"].RichText.Add("Fecha");

                Sheet.Cells["J4:K4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.PaleGoldenrod);
                Sheet.Cells["J4"].RichText.Add("No.");
                Sheet.Cells["K4"].RichText.Add("Fecha");

                Sheet.Cells["L4:N4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.PowderBlue);
                Sheet.Cells["L4"].RichText.Add("No.");
                Sheet.Cells["M4"].RichText.Add("Fecha");
                Sheet.Cells["N4"].RichText.Add("Fecha Compromiso");

                Sheet.Cells["O4:S4"].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);
                Sheet.Cells["O4"].RichText.Add("Se Facturo desde");
                Sheet.Cells["P4"].RichText.Add("Fecha Factura -Fecha Prefactura");
                Sheet.Cells["Q4"].RichText.Add("Fecha Factura -Fecha Remisión");
                Sheet.Cells["R4"].RichText.Add("Fecha Factura -Fecha Pedido");
                Sheet.Cells["S4"].RichText.Add("Fecha Factura -Fecha Compromiso");

                //.Value solo trae datos, sin formato, a diferencia de .RichText que permite aplicar: tipos, tamaños, colores, negrita
                //Sheet.Cells["A3"].Value = "Serie";

                //Aplicar borde doble al rango de celdas A3:Q3
                Sheet.Cells["A4:N4"].Style.Border.Bottom.Style = ExcelBorderStyle.Double;

                // en la fila4, el foreach llenara cada fila de la hoja de excel, con cada fila que trae de la bd.
                // Se establecen los formatos para las celdas: Fecha, Moneda
                row = 5;
                Sheet.Cells.Style.Font.Bold = false;
                int renglones = datos.Count + row;
                Sheet.Cells["S4:S" + renglones].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                foreach (TempFacturacion item in ViewBag.datos)
                {


                    Sheet.Cells[string.Format("A{0}", row)].Value = item.Ticket;
                    Sheet.Cells[string.Format("B{0}", row)].Value = item.SerieDigital;
                    Sheet.Cells[string.Format("C{0}", row)].Value = item.NumeroDigital;
                    Sheet.Cells[string.Format("D{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("D{0}", row)].Value = item.FechaFac;
                    Sheet.Cells[string.Format("E{0}", row)].Value = item.Estado;

                    Sheet.Cells[string.Format("F{0}", row)].Value = item.IDPrefactura;
                    Sheet.Cells[string.Format("G{0}", row)].Value = item.SeriePre;
                    Sheet.Cells[string.Format("H{0}", row)].Value = item.NumeroPre;
                    Sheet.Cells[string.Format("I{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("I{0}", row)].Value = item.FechaPrefactura;

                    Sheet.Cells[string.Format("J{0}", row)].Value = item.iDRemision;
                    Sheet.Cells[string.Format("K{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("K{0}", row)].Value = item.FechaRem;

                    Sheet.Cells[string.Format("L{0}", row)].Value = item.IDPedido;
                    Sheet.Cells[string.Format("M{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("M{0}", row)].Value = item.FechaPed;
                    Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                    Sheet.Cells[string.Format("N{0}", row)].Value = item.FechaRequiere;

                    Sheet.Cells[string.Format("O{0}", row)].Value = item.Proviene;
                    int dias1 = DiasHabiles(item.FechaPrefactura, item.FechaFac);
                    int dias2 = DiasHabiles(item.FechaRem, item.FechaFac);
                    int dias3 = DiasHabiles(item.FechaPed, item.FechaFac);
                    int dias4 = DiasHabiles(item.FechaRequiere, item.FechaFac);
                    Sheet.Cells[string.Format("P{0}", row)].Value = dias1;
                    Sheet.Cells[string.Format("Q{0}", row)].Value = dias2;
                    Sheet.Cells[string.Format("R{0}", row)].Value = dias3;
                    if (dias4 < 0)
                    {
                        Sheet.Cells[string.Format("S{0}", row)].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGreen);
                        Sheet.Cells[string.Format("S{0}", row)].Value = dias4;
                        antesT += 1;
                    }
                    if (dias4 == 0)
                    {
                        Sheet.Cells[string.Format("S{0}", row)].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.PapayaWhip);
                        Sheet.Cells[string.Format("S{0}", row)].Value = dias4;
                        enT += 1;
                    }
                    if (dias4 > 0)
                    {
                        Sheet.Cells[string.Format("S{0}", row)].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightCoral);
                        Sheet.Cells[string.Format("S{0}", row)].Value = dias4;
                        fueraT += 1;
                    }
                    row++;
                }
                Tot = antesT + enT + fueraT;

                int nreg = renglones + 1;
                Sheet.Cells["A" + nreg + ":D" + nreg].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                Sheet.Cells["A" + nreg + ":D" + nreg].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.DarkCyan);
                Sheet.Cells["A" + nreg + ":D" + nreg].Style.Font.Color.SetColor(Color.White);
                Sheet.Cells["A" + nreg + ":D" + nreg].Style.Font.Bold = true;
                Sheet.Cells["A" + nreg].RichText.Add("Total Facturas");
                Sheet.Cells["B" + nreg].RichText.Add("Antes de Tiempo");
                Sheet.Cells["C" + nreg].RichText.Add("En Tiempo");
                Sheet.Cells["D" + nreg].RichText.Add("Fuera de Tiempo");
                nreg += 1;
                Sheet.Cells[string.Format("A" + nreg)].Value = Tot;
                Sheet.Cells[string.Format("B" + nreg)].Value = antesT;
                Sheet.Cells[string.Format("C" + nreg)].Value = enT;
                Sheet.Cells[string.Format("D" + nreg)].Value = fueraT;
                nreg += 1;
                antesTP = (100 / Tot) * antesT;
                enTP = (100 / Tot) * enT;
                fueraTP = (100 / Tot) * fueraT;

                Sheet.Cells[string.Format("A" + nreg)].Style.Numberformat.Format = "#0\\.00%";
                Sheet.Cells[string.Format("A" + nreg)].Value = "100";
                Sheet.Cells[string.Format("B" + nreg)].Style.Numberformat.Format = "#0\\.00%";
                Sheet.Cells[string.Format("B" + nreg)].Value = antesTP;
                Sheet.Cells[string.Format("C" + nreg)].Style.Numberformat.Format = "#0\\.00%";
                Sheet.Cells[string.Format("C" + nreg)].Value = enTP;
                Sheet.Cells[string.Format("D" + nreg)].Style.Numberformat.Format = "#0\\.00%";
                Sheet.Cells[string.Format("D" + nreg)].Value = fueraTP;
                //Sheet.Cells[string.Format("E" + nreg)].Value = "%";


                //Se genera el archivo y se descarga

                Sheet.Cells["A:AZ"].AutoFitColumns();
                Response.Clear();
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
                Response.AddHeader("content-disposition", "attachment: filename=" + "ReporteExcelNC.xlsx");
                Response.BinaryWrite(Ep.GetAsByteArray());
                Response.End();
                return Redirect("/blah");
            }
            return Redirect("index");
        }

        public int DiasHabiles(DateTime firstDay, DateTime lastDay)
        {
            List<DateTime> bankHolidays = new List<DateTime>();
            DateTime uno = DateTime.Parse(DateTime.Now.Year + "/05/01");
            DateTime dos = DateTime.Parse(DateTime.Now.Year + "/05/05");
            DateTime tres = DateTime.Parse(DateTime.Now.Year + "/12/24");
            DateTime cuatro = DateTime.Parse(DateTime.Now.Year + "/12/25");
            DateTime cinco = DateTime.Parse(DateTime.Now.Year + "/12/12");
            DateTime seis = DateTime.Parse(DateTime.Now.Year + "/12/31");
            DateTime siete = DateTime.Parse(DateTime.Now.Year + "/01/01");
            DateTime ocho = DateTime.Parse(DateTime.Now.Year + "/12/24");
            DateTime nueve = DateTime.Parse(DateTime.Now.Year + "/09/16");
            bankHolidays.Add(uno);
            bankHolidays.Add(dos);
            bankHolidays.Add(tres);
            bankHolidays.Add(cuatro);
            bankHolidays.Add(cinco);
            bankHolidays.Add(seis);
            bankHolidays.Add(siete);
            bankHolidays.Add(ocho);
            bankHolidays.Add(nueve);

            firstDay = firstDay.Date;
            lastDay = lastDay.Date;
            //if (firstDay > lastDay)
            //    throw new ArgumentException("Incorrect last day " + lastDay);

            TimeSpan span = lastDay - firstDay;
            int businessDays = span.Days;// + 1;
            int fullWeekCount = businessDays / 7;
            // find out if there are weekends during the time exceedng the full weeks
            if (businessDays > fullWeekCount * 7)
            {
                // we are here to find out if there is a 1-day or 2-days weekend
                // in the time interval remaining after subtracting the complete weeks
                int firstDayOfWeek = (int)firstDay.DayOfWeek;
                int lastDayOfWeek = (int)lastDay.DayOfWeek;
                if (lastDayOfWeek < firstDayOfWeek)
                    lastDayOfWeek += 7;
                if (firstDayOfWeek <= 6)
                {
                    if (lastDayOfWeek >= 7)// Both Saturday and Sunday are in the remaining time interval
                        businessDays -= 2;
                    else if (lastDayOfWeek >= 6)// Only Saturday is in the remaining time interval
                        businessDays -= 1;
                }
                else if (firstDayOfWeek <= 7 && lastDayOfWeek >= 7)// Only Sunday is in the remaining time interval
                    businessDays -= 1;
            }

            // subtract the weekends during the full weeks in the interval
            businessDays -= fullWeekCount + fullWeekCount;

            // subtract the number of bank holidays during the time interval
            foreach (DateTime bankHoliday in bankHolidays)
            {
                DateTime bh = bankHoliday.Date;
                if (firstDay <= bh && bh <= lastDay)
                    --businessDays;
            }

            return businessDays;
        }

        public ActionResult EntreFechasFV()
        {
            EFecha elemento = new EFecha();
            return View(elemento);
        }

        [HttpPost]
        public ActionResult EntreFechasFV(EFecha modelo, FormCollection coleccion)
        {
            string FI = modelo.fechaini.Year.ToString() + "-" + modelo.fechaini.Month.ToString() + "-" + modelo.fechaini.Day.ToString();
            string FF = modelo.fechafin.Year.ToString() + "-" + modelo.fechafin.Month.ToString() + "-" + modelo.fechafin.Day.ToString();

            string cual = coleccion.Get("Enviar");
            if (cual == "Excel con Costo")
            {
                int fila = 3;
                int row = 1;
                decimal totalMXNVen = 0;
                decimal totalUSDVen = 0;
                decimal totalMXN = 0;
                decimal totalUSD = 0;
                decimal subtMXN = 0;
                decimal ivaMXN = 0;
                decimal totMXN = 0;
                decimal GsubtMXN = 0;
                decimal GivaMXN = 0;
                decimal GtotMXN = 0;
                decimal subtUSD = 0;
                decimal ivaUSD = 0;
                decimal totUSD = 0;
                decimal GsubtUSD = 0;
                decimal GivaUSD = 0;
                decimal GtotUSD = 0;
                string cadenaV = "select distinct C.IDVendedor, V.Nombre, V.CuotaVendedor, M.ClaveMoneda from [dbo].[Encfacturas] E inner join (Clientes C inner join ([dbo].[Vendedor] as V inner join [dbo].[c_Moneda] as M on V.IDMoneda = M.IDMoneda) on C.IDVendedor = V.IDVendedor) on E.IDcliente= C.IDCliente where Serie = 'MX' and (Fecha >= '" + FI + " 00:00:00.1' and Fecha <='" + FF + " 23:59:59.999') order by V.Nombre";
                var vendedor = dbs.Database.SqlQuery<VendedorPedidoDls>(cadenaV).ToList();
                ViewBag.vendedor = vendedor;

                ExcelPackage Ep = new ExcelPackage();
                //Crear la hoja y poner el nombre de la pestaña del libro
                var Sheet = Ep.Workbook.Worksheets.Add("Facturación");

                // en la fila1 formateo las celdas y coloco el título de la hoja
                // RichText permite agregar las propiedades de tipo de letra: color, negrita, etc.

                //Fijar la fuente para A1:Q1
                Sheet.Cells["A1:P1"].Style.Font.Size = 20;
                Sheet.Cells["A1:P1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:P1"].Style.Font.Color.SetColor(Color.DarkBlue);
                Sheet.Cells["A1:P1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["A1:P1"].Style.Font.Bold = true;
                Sheet.Cells["A1"].RichText.Add("Listado de Facturas en Dolares por Vendedor");

                row = 2;
                Sheet.Cells["A2:P2"].Style.Font.Size = 12;
                Sheet.Cells["A2:P2"].Style.Font.Name = "Calibri";
                Sheet.Cells["A2:P2"].Style.Border.Bottom.Style = ExcelBorderStyle.Hair;
                Sheet.Cells["A2:P2"].Style.Font.Bold = true;
                //Subtitulo según el filtrado del periodo de datos

                Sheet.Cells[string.Format("A2", row)].Value = "Fecha inicial";
                Sheet.Cells[string.Format("B2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("B2", row)].Value = FI;
                Sheet.Cells[string.Format("D2", row)].Value = "Fecha Final";
                Sheet.Cells[string.Format("E2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("E2", row)].Value = FF;
                Sheet.Cells[string.Format("F2", row)].Value = "TC";
                decimal tcd = db.Database.SqlQuery<ClsDatoDecimal>("select dbo.GetTipocambio(GETDATE(),(select idMoneda from C_MONEDA WHERE clavemoneda='USD'),(select idMoneda from C_MONEDA WHERE clavemoneda='MXN')  )  as Dato").ToList()[0].Dato;
                Sheet.Cells[string.Format("G2", row)].Style.Numberformat.Format = "#,##0.00";
                Sheet.Cells[string.Format("G2", row)].Value = tcd;
                //En la fila3 se da el formato a el encabezado

                row = 4;

                foreach (VendedorPedidoDls item in ViewBag.vendedor)
                {
                    fila = row;
                    Sheet.Cells.Style.Font.Name = "Calibri";
                    Sheet.Cells.Style.Font.Size = 10;
                    Sheet.Cells["A" + fila + ":P" + fila].Style.Font.Bold = true;
                    Sheet.Cells["A" + fila + ":P" + fila].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    Sheet.Cells["A" + fila + ":P" + fila].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightBlue);

                    // Se establecen los datos del vendedor.
                    Sheet.Cells["A" + fila].RichText.Add("No. Vendedor");
                    Sheet.Cells["B" + fila].RichText.Add("Vendedor");
                    Sheet.Cells["C" + fila].RichText.Add("Cuota");
                    Sheet.Cells["D" + fila].RichText.Add("Moneda");

                    //Aplicar borde doble al rango de celdas A3:Q3
                    Sheet.Cells["A" + fila + ":P" + fila].Style.Border.Bottom.Style = ExcelBorderStyle.Double;

                    // en la fila4, el foreach llenara cada fila de la hoja de excel, con cada fila que trae de la bd.
                    // Se establecen los formatos para las celdas: Fecha, Moneda
                    Sheet.Cells.Style.Font.Bold = false;

                    fila += 1;
                    row = fila;

                    Sheet.Cells[string.Format("A{0}", row)].Value = item.IDVendedor;
                    Sheet.Cells[string.Format("B{0}", row)].Value = item.Nombre;
                    Sheet.Cells[string.Format("C{0}", row)].Value = item.CuotaVendedor;
                    Sheet.Cells[string.Format("D{0}", row)].Value = item.ClaveMoneda;

                    fila += 1;
                    row = fila;
                    Sheet.Cells.Style.Font.Name = "Calibri";
                    Sheet.Cells.Style.Font.Size = 10;
                    Sheet.Cells["A" + fila + ":P" + fila].Style.Font.Bold = true;
                    Sheet.Cells["A" + fila + ":P" + fila].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    Sheet.Cells["A" + fila + ":P" + fila].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                    // Se establecen los datos del vendedor.
                    Sheet.Cells["A" + fila].RichText.Add("Ticket");
                    Sheet.Cells["B" + fila].RichText.Add("Serie");
                    Sheet.Cells["C" + fila].RichText.Add("Numero");
                    Sheet.Cells["D" + fila].RichText.Add("Fecha");
                    Sheet.Cells["E" + fila].RichText.Add("No. Cliente");
                    Sheet.Cells["F" + fila].RichText.Add("Nombre");
                    Sheet.Cells["G" + fila].RichText.Add("Subtotal");
                    Sheet.Cells["H" + fila].RichText.Add("IVA");
                    Sheet.Cells["I" + fila].RichText.Add("Total");
                    Sheet.Cells["J" + fila].RichText.Add("Moneda Factura");
                    Sheet.Cells["K" + fila].RichText.Add("TC");
                    Sheet.Cells["L" + fila].RichText.Add("Estado");
                    Sheet.Cells["M" + fila].RichText.Add("Total MXN");
                    Sheet.Cells["N" + fila].RichText.Add("Total USD");
                    Sheet.Cells["O" + fila].RichText.Add("Rentabilidad");
                    Sheet.Cells["P" + fila].RichText.Add("Costo");
                    string cadenaF = "select  F.[ID], F.[Serie], F.[Numero], F.[Fecha], F.IDCliente, C.Nombre, F.[Subtotal],F.[IVA], F.[Total], F.[Estado], F.[TC], F.[IDMoneda], M.ClaveMoneda as MonedaFactura, V.IDVendedor, V.Nombre as Vendedor from [dbo].[Encfacturas] F 	inner join Clientes C on F.IDcliente= C.IDCliente inner join [dbo].[Vendedor] as V on C.IDVendedor = V.IDVendedor inner join [dbo].[c_Moneda] as M on F.IDMoneda = M.IDMoneda where Serie = 'MX' and (Fecha >= '" + FI + " 00:00:00.1' and Fecha <='" + FF + " 23:59:59.999') and V.IDVendedor=" + item.IDVendedor + " order by V.Nombre, C.Nombre, F.Numero";
                    var factura = dbs.Database.SqlQuery<FactVen>(cadenaF).ToList();
                    ViewBag.factura = factura;
                    totalMXNVen = 0;
                    totalUSDVen = 0;
                    subtMXN = 0;
                    ivaMXN = 0;
                    totMXN = 0;
                    subtUSD = 0;
                    ivaUSD = 0;
                    totUSD = 0;

                    fila += 1;
                    row = fila;

                    foreach (FactVen itemf in ViewBag.factura)
                    {

                        EncPrefactura prefactura = new PrefacturaContext().EncPrefactura.Where(s => s.SerieDigital == itemf.Serie && s.NumeroDigital == itemf.Numero.ToString()).FirstOrDefault();

                        decimal Rentabilidad = 0;
                        decimal Costo = 0;
                        try
                        {
                            if (prefactura != null)
                            {
                                string NoPedido = r_Pedidos(prefactura.IDPrefactura);//
                                string[] pedidos = NoPedido.Split(' ');
                                int pedido = int.Parse(pedidos[0]);
                                DateTime FechaPedido = r_FechaPedido(pedido);//
                              Costo = c_Costo(prefactura, pedido);//
                                //int comisionableart = comisionablearticulo(prefactura);

                                decimal basecomisionable = c_basecomisionable(prefactura);
                              
                                try
                                {
                                    Rentabilidad = 1 - (Costo / basecomisionable);
                                }
                                catch (Exception err)
                                {
                                    Rentabilidad = 0.3M;
                                }
                                //
                                string MonedaFactura = "";
                                try
                                {
                                    MonedaFactura = prefactura.c_Moneda.ClaveMoneda;
                                }
                                catch (Exception err)
                                {

                                }
                                string MonedaCosto = "";
                                try
                                {
                                    MonedaCosto = prefactura.c_Moneda.ClaveMoneda;
                                }
                                catch (Exception err)
                                {

                                }

                                //string cadena0 = "Select monto as Dato from PenalizacionFactura where idfactura=" +;
                                //ClsDatoDecimal costo = db.Database.SqlQuery<ClsDatoDecimal>(cadena0).ToList().FirstOrDefault();

                                decimal montoPenalizacion = 0;

                                //if (costo == null)
                                //{
                                //    //montoPenalizacion = 0;

                                //    montoPenalizacion = VerificarPCliente(itemf.IDCliente, elemento.subtotal, elemento.ID);

                                //}
                                //else
                                //{
                                //    montoPenalizacion = costo.Dato;
                                //}

                                VCambio cambio;
                                int monedaorigen = prefactura.c_Moneda.IDMoneda;
                                string fecha = FechaPedido.ToString("yyyy/MM/dd");
                                List<c_Moneda> monedadestino = db.Database.SqlQuery<c_Moneda>("select * from c_Moneda WHERE ClaveMoneda='MXN'").ToList();
                                int destino = monedadestino.Select(s => s.IDMoneda).FirstOrDefault();

                                try
                                {
                                    cambio = db.Database.SqlQuery<VCambio>("select dbo.GetTipocambio('" + fecha + "'," + monedaorigen + "," + destino + ") as TC").ToList()[0];

                                }
                                catch (Exception err)
                                {
                                    cambio = db.Database.SqlQuery<VCambio>("select dbo.GetTipocambio('" + fecha + "',180,180) as TC").ToList()[0];
                                    string mensajeerror = err.Message;
                                }

                              

                                decimal MontoRentabilidad = 0;
                                decimal MontoComision = 0;
                                ClsDatoDecimal can = db.Database.SqlQuery<ClsDatoDecimal>("select subtotal as Dato from encpedido where idpedido=" + pedido).ToList().FirstOrDefault();

                                decimal subtotal = can.Dato;
                                decimal basecomisionablereal = subtotal - montoPenalizacion - (subtotal - basecomisionable);


                                if (basecomisionablereal < 0)
                                {
                                    basecomisionablereal = 0;
                                }
                                if (Rentabilidad < 0)
                                {
                                    Rentabilidad = 0;
                                }

                             
                                if (item.IDVendedor == 5)
                                {

                                    try
                                    {
                                        MontoRentabilidad = basecomisionablereal - Costo;
                                        if (MontoRentabilidad < 0)
                                        {
                                            MontoRentabilidad = 0;
                                        }
                                    }
                                    catch (Exception err)
                                    {

                                    }

                                   
                                }
                                else
                                {

                                    try
                                    {
                                        MontoRentabilidad = basecomisionablereal * Rentabilidad;
                                    }
                                    catch (Exception err)
                                    {

                                    }

                                   
                                }




                            }
                        }
                        catch (Exception err)
                        {
                            string mensaje = err.Message;
                        }


                        Sheet.Cells[string.Format("A{0}", row)].Value = itemf.ID;
                        Sheet.Cells[string.Format("B{0}", row)].Value = itemf.Serie;
                        Sheet.Cells[string.Format("C{0}", row)].Value = itemf.Numero;
                        Sheet.Cells[string.Format("D{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        Sheet.Cells[string.Format("D{0}", row)].Value = itemf.Fecha;
                        Sheet.Cells[string.Format("E{0}", row)].Value = itemf.IDCliente;
                        Sheet.Cells[string.Format("F{0}", row)].Value = itemf.Nombre;
                        Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("G{0}", row)].Value = itemf.Subtotal;
                        Sheet.Cells[string.Format("H{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("H{0}", row)].Value = itemf.IVA;
                        Sheet.Cells[string.Format("I{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("I{0}", row)].Value = itemf.Total;
                        Sheet.Cells[string.Format("J{0}", row)].Value = itemf.MonedaFactura;
                        Sheet.Cells[string.Format("K{0}", row)].Value = itemf.TC;
                        if (itemf.Estado != "C")
                        {
                            Sheet.Cells[string.Format("L{0}", row)].Value = itemf.Estado;
                        }
                        else
                        {
                            Sheet.Cells["L" + fila].Style.Font.Color.SetColor(Color.Red);
                            Sheet.Cells[string.Format("L{0}", row)].Value = itemf.Estado;
                        }

                        if (itemf.MonedaFactura == "USD")
                        {
                            //Pesos

                            Sheet.Cells[string.Format("M{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                            Sheet.Cells[string.Format("M{0}", row)].Value = itemf.Total * itemf.TC;
                            //Dolares
                            Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                            Sheet.Cells[string.Format("N{0}", row)].Value = itemf.Total;
                            if (itemf.Estado != "C")
                            {
                                totalMXNVen += itemf.Total * itemf.TC;
                                totalUSDVen += itemf.Total;
                                totalMXN += itemf.Total * itemf.TC;
                                totalUSD += itemf.Total;

                                subtUSD += itemf.Subtotal;
                                ivaUSD += itemf.IVA;
                                totUSD += itemf.Total;
                                GsubtUSD += itemf.Subtotal;
                                GivaUSD += itemf.Total;
                                GtotUSD += itemf.Total;
                            }
                        }
                        if (itemf.MonedaFactura == "MXN")
                        {//Pesos
                            Sheet.Cells[string.Format("M{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                            Sheet.Cells[string.Format("M{0}", row)].Value = itemf.Total;
                            //Dolares
                            Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                            Sheet.Cells[string.Format("N{0}", row)].Value = itemf.Total / tcd;
                            if (itemf.Estado != "C")
                            {
                                totalMXNVen += itemf.Total;
                                totalUSDVen += itemf.Total / tcd;
                                totalMXN += itemf.Total;
                                totalUSD += itemf.Total / tcd;
                                subtMXN += itemf.Subtotal;
                                ivaMXN += itemf.IVA;
                                totMXN += itemf.Total;
                                GsubtMXN += itemf.Subtotal;
                                GivaMXN += itemf.Total;
                                GtotMXN += itemf.Total;
                            }
                        }

                        //Rentabilidad
                        Sheet.Cells[string.Format("O{0}", row)].Style.Numberformat.Format = "#0.00%";
                        Sheet.Cells[string.Format("O{0}", row)].Value = Rentabilidad;
                        //Costo
                        Sheet.Cells[string.Format("P{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("P{0}", row)].Value = Costo;

                        fila += 1;
                        row = fila;

                    }
                    Sheet.Cells.Style.Font.Name = "Calibri";
                    Sheet.Cells.Style.Font.Size = 10;
                    Sheet.Cells["F" + fila + ":N" + (fila + 1)].Style.Font.Bold = true;
                    Sheet.Cells["F" + fila + ":N" + (fila + 1)].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    Sheet.Cells["F" + fila + ":N" + (fila + 1)].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGoldenrodYellow);
                    Sheet.Cells[string.Format("F{0}", row)].Value = "Total MXN";
                    Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("G{0}", row)].Value = subtMXN;
                    Sheet.Cells[string.Format("H{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("H{0}", row)].Value = ivaMXN;
                    Sheet.Cells[string.Format("I{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("I{0}", row)].Value = totMXN;
                    Sheet.Cells[string.Format("L{0}", row)].Value = "Total Vendedor";
                    //Pesos
                    Sheet.Cells[string.Format("M{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("M{0}", row)].Value = totalMXNVen;
                    //Dolares
                    Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("N{0}", row)].Value = totalUSDVen;
                    fila += 1;
                    row = fila;
                    Sheet.Cells[string.Format("F{0}", row)].Value = "Total USD";
                    Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("G{0}", row)].Value = subtUSD;
                    Sheet.Cells[string.Format("H{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("H{0}", row)].Value = ivaUSD;
                    Sheet.Cells[string.Format("I{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("I{0}", row)].Value = totUSD;
                    fila += 1;
                    row = fila;
                    row++;
                }

                //Se genera el archivo y se descarga

                Sheet.Cells["A:AZ"].AutoFitColumns();
                Response.Clear();
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
                Response.AddHeader("content-disposition", "attachment: filename=" + "ReporteExcelNC.xlsx");
                Response.BinaryWrite(Ep.GetAsByteArray());
                Response.End();
                return Redirect("/blah");
            }
            if (cual == "Excel")
            {
                int fila = 3;
                int row = 1;
                decimal totalMXNVen = 0;
                decimal totalUSDVen = 0;
                decimal totalMXN = 0;
                decimal totalUSD = 0;
                decimal subtMXN = 0;
                decimal ivaMXN = 0;
                decimal totMXN = 0;
                decimal GsubtMXN = 0;
                decimal GivaMXN = 0;
                decimal GtotMXN = 0;
                decimal subtUSD = 0;
                decimal ivaUSD = 0;
                decimal totUSD = 0;
                decimal GsubtUSD = 0;
                decimal GivaUSD = 0;
                decimal GtotUSD = 0;
                string cadenaV = "select distinct C.IDVendedor, V.Nombre, V.CuotaVendedor, M.ClaveMoneda from [dbo].[Encfacturas] E inner join (Clientes C inner join ([dbo].[Vendedor] as V inner join [dbo].[c_Moneda] as M on V.IDMoneda = M.IDMoneda) on C.IDVendedor = V.IDVendedor) on E.IDcliente= C.IDCliente where Serie = 'MX' and (Fecha >= '" + FI + " 00:00:00.1' and Fecha <='" + FF + " 23:59:59.999') order by V.Nombre";
                var vendedor = dbs.Database.SqlQuery<VendedorPedidoDls>(cadenaV).ToList();
                ViewBag.vendedor = vendedor;

                ExcelPackage Ep = new ExcelPackage();
                //Crear la hoja y poner el nombre de la pestaña del libro
                var Sheet = Ep.Workbook.Worksheets.Add("Facturación");

                // en la fila1 formateo las celdas y coloco el título de la hoja
                // RichText permite agregar las propiedades de tipo de letra: color, negrita, etc.

                //Fijar la fuente para A1:Q1
                Sheet.Cells["A1:N1"].Style.Font.Size = 20;
                Sheet.Cells["A1:N1"].Style.Font.Name = "Calibri";
                Sheet.Cells["A1:N1"].Style.Font.Color.SetColor(Color.DarkBlue);
                Sheet.Cells["A1:N1"].Style.HorizontalAlignment = ExcelHorizontalAlignment.CenterContinuous;
                Sheet.Cells["A1:N1"].Style.Font.Bold = true;
                Sheet.Cells["A1"].RichText.Add("Listado de Facturas en Dolares por Vendedor");

                row = 2;
                Sheet.Cells["A2:N2"].Style.Font.Size = 12;
                Sheet.Cells["A2:N2"].Style.Font.Name = "Calibri";
                Sheet.Cells["A2:N2"].Style.Border.Bottom.Style = ExcelBorderStyle.Hair;
                Sheet.Cells["A2:N2"].Style.Font.Bold = true;
                //Subtitulo según el filtrado del periodo de datos

                Sheet.Cells[string.Format("A2", row)].Value = "Fecha inicial";
                Sheet.Cells[string.Format("B2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("B2", row)].Value = FI;
                Sheet.Cells[string.Format("D2", row)].Value = "Fecha Final";
                Sheet.Cells[string.Format("E2", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                Sheet.Cells[string.Format("E2", row)].Value = FF;
                Sheet.Cells[string.Format("F2", row)].Value = "TC";
                decimal tcd = db.Database.SqlQuery<ClsDatoDecimal>("select dbo.GetTipocambio(GETDATE(),(select idMoneda from C_MONEDA WHERE clavemoneda='USD'),(select idMoneda from C_MONEDA WHERE clavemoneda='MXN')  )  as Dato").ToList()[0].Dato;
                Sheet.Cells[string.Format("G2", row)].Style.Numberformat.Format = "#,##0.00";
                Sheet.Cells[string.Format("G2", row)].Value = tcd;
                //En la fila3 se da el formato a el encabezado

                row = 4;

                foreach (VendedorPedidoDls item in ViewBag.vendedor)
                {
                    fila = row;
                    Sheet.Cells.Style.Font.Name = "Calibri";
                    Sheet.Cells.Style.Font.Size = 10;
                    Sheet.Cells["A" + fila + ":N" + fila].Style.Font.Bold = true;
                    Sheet.Cells["A" + fila + ":N" + fila].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    Sheet.Cells["A" + fila + ":N" + fila].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightBlue);

                    // Se establecen los datos del vendedor.
                    Sheet.Cells["A" + fila].RichText.Add("No. Vendedor");
                    Sheet.Cells["B" + fila].RichText.Add("Vendedor");
                    Sheet.Cells["C" + fila].RichText.Add("Cuota");
                    Sheet.Cells["D" + fila].RichText.Add("Moneda");

                    //Aplicar borde doble al rango de celdas A3:Q3
                    Sheet.Cells["A" + fila + ":N" + fila].Style.Border.Bottom.Style = ExcelBorderStyle.Double;

                    // en la fila4, el foreach llenara cada fila de la hoja de excel, con cada fila que trae de la bd.
                    // Se establecen los formatos para las celdas: Fecha, Moneda
                    Sheet.Cells.Style.Font.Bold = false;

                    fila += 1;
                    row = fila;

                    Sheet.Cells[string.Format("A{0}", row)].Value = item.IDVendedor;
                    Sheet.Cells[string.Format("B{0}", row)].Value = item.Nombre;
                    Sheet.Cells[string.Format("C{0}", row)].Value = item.CuotaVendedor;
                    Sheet.Cells[string.Format("D{0}", row)].Value = item.ClaveMoneda;

                    fila += 1;
                    row = fila;
                    Sheet.Cells.Style.Font.Name = "Calibri";
                    Sheet.Cells.Style.Font.Size = 10;
                    Sheet.Cells["A" + fila + ":N" + fila].Style.Font.Bold = true;
                    Sheet.Cells["A" + fila + ":N" + fila].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    Sheet.Cells["A" + fila + ":N" + fila].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGray);

                    // Se establecen los datos del vendedor.
                    Sheet.Cells["A" + fila].RichText.Add("Ticket");
                    Sheet.Cells["B" + fila].RichText.Add("Serie");
                    Sheet.Cells["C" + fila].RichText.Add("Numero");
                    Sheet.Cells["D" + fila].RichText.Add("Fecha");
                    Sheet.Cells["E" + fila].RichText.Add("No. Cliente");
                    Sheet.Cells["F" + fila].RichText.Add("Nombre");
                    Sheet.Cells["G" + fila].RichText.Add("Subtotal");
                    Sheet.Cells["H" + fila].RichText.Add("IVA");
                    Sheet.Cells["I" + fila].RichText.Add("Total");
                    Sheet.Cells["J" + fila].RichText.Add("Moneda Factura");
                    Sheet.Cells["K" + fila].RichText.Add("TC");
                    Sheet.Cells["L" + fila].RichText.Add("Estado");
                    Sheet.Cells["M" + fila].RichText.Add("Total MXN");
                    Sheet.Cells["N" + fila].RichText.Add("Total USD");

                    string cadenaF = "select  F.[ID], F.[Serie], F.[Numero], F.[Fecha], F.IDCliente, C.Nombre, F.[Subtotal],F.[IVA], F.[Total], F.[Estado], F.[TC], F.[IDMoneda], M.ClaveMoneda as MonedaFactura, V.IDVendedor, V.Nombre as Vendedor from [dbo].[Encfacturas] F 	inner join Clientes C on F.IDcliente= C.IDCliente inner join [dbo].[Vendedor] as V on C.IDVendedor = V.IDVendedor inner join [dbo].[c_Moneda] as M on F.IDMoneda = M.IDMoneda where Serie = 'MX' and (Fecha >= '" + FI + " 00:00:00.1' and Fecha <='" + FF + " 23:59:59.999') and V.IDVendedor=" + item.IDVendedor + " order by V.Nombre, C.Nombre, F.Numero";
                    var factura = dbs.Database.SqlQuery<FactVen>(cadenaF).ToList();
                    ViewBag.factura = factura;
                    totalMXNVen = 0;
                    totalUSDVen = 0;
                    subtMXN = 0;
                    ivaMXN = 0;
                    totMXN = 0;
                    subtUSD = 0;
                    ivaUSD = 0;
                    totUSD = 0;

                    fila += 1;
                    row = fila;

                    foreach (FactVen itemf in ViewBag.factura)
                    {
                        Sheet.Cells[string.Format("A{0}", row)].Value = itemf.ID;
                        Sheet.Cells[string.Format("B{0}", row)].Value = itemf.Serie;
                        Sheet.Cells[string.Format("C{0}", row)].Value = itemf.Numero;
                        Sheet.Cells[string.Format("D{0}", row)].Style.Numberformat.Format = DateTimeFormatInfo.CurrentInfo.ShortDatePattern;
                        Sheet.Cells[string.Format("D{0}", row)].Value = itemf.Fecha;
                        Sheet.Cells[string.Format("E{0}", row)].Value = itemf.IDCliente;
                        Sheet.Cells[string.Format("F{0}", row)].Value = itemf.Nombre;
                        Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("G{0}", row)].Value = itemf.Subtotal;
                        Sheet.Cells[string.Format("H{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("H{0}", row)].Value = itemf.IVA;
                        Sheet.Cells[string.Format("I{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                        Sheet.Cells[string.Format("I{0}", row)].Value = itemf.Total;
                        Sheet.Cells[string.Format("J{0}", row)].Value = itemf.MonedaFactura;
                        Sheet.Cells[string.Format("K{0}", row)].Value = itemf.TC;
                        if (itemf.Estado != "C")
                        {
                            Sheet.Cells[string.Format("L{0}", row)].Value = itemf.Estado;
                        }
                        else
                        {
                            Sheet.Cells["L" + fila].Style.Font.Color.SetColor(Color.Red);
                            Sheet.Cells[string.Format("L{0}", row)].Value = itemf.Estado;
                        }

                        if (itemf.MonedaFactura == "USD")
                        {
                            //Pesos

                            Sheet.Cells[string.Format("M{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                            Sheet.Cells[string.Format("M{0}", row)].Value = itemf.Total * itemf.TC;
                            //Dolares
                            Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                            Sheet.Cells[string.Format("N{0}", row)].Value = itemf.Total;
                            if (itemf.Estado != "C")
                            {
                                totalMXNVen += itemf.Total * itemf.TC;
                                totalUSDVen += itemf.Total;
                                totalMXN += itemf.Total * itemf.TC;
                                totalUSD += itemf.Total;

                                subtUSD += itemf.Subtotal;
                                ivaUSD += itemf.IVA;
                                totUSD += itemf.Total;
                                GsubtUSD += itemf.Subtotal;
                                GivaUSD += itemf.Total;
                                GtotUSD += itemf.Total;
                            }
                        }
                        if (itemf.MonedaFactura == "MXN")
                        {//Pesos
                            Sheet.Cells[string.Format("M{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                            Sheet.Cells[string.Format("M{0}", row)].Value = itemf.Total;
                            //Dolares
                            Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                            Sheet.Cells[string.Format("N{0}", row)].Value = itemf.Total / tcd;
                            if (itemf.Estado != "C")
                            {
                                totalMXNVen += itemf.Total;
                                totalUSDVen += itemf.Total / tcd;
                                totalMXN += itemf.Total;
                                totalUSD += itemf.Total / tcd;
                                subtMXN += itemf.Subtotal;
                                ivaMXN += itemf.IVA;
                                totMXN += itemf.Total;
                                GsubtMXN += itemf.Subtotal;
                                GivaMXN += itemf.Total;
                                GtotMXN += itemf.Total;
                            }
                        }


                        fila += 1;
                        row = fila;

                    }
                    Sheet.Cells.Style.Font.Name = "Calibri";
                    Sheet.Cells.Style.Font.Size = 10;
                    Sheet.Cells["F" + fila + ":N" + (fila + 1)].Style.Font.Bold = true;
                    Sheet.Cells["F" + fila + ":N" + (fila + 1)].Style.Fill.PatternType = OfficeOpenXml.Style.ExcelFillStyle.Solid;
                    Sheet.Cells["F" + fila + ":N" + (fila + 1)].Style.Fill.BackgroundColor.SetColor(System.Drawing.Color.LightGoldenrodYellow);
                    Sheet.Cells[string.Format("F{0}", row)].Value = "Total MXN";
                    Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("G{0}", row)].Value = subtMXN;
                    Sheet.Cells[string.Format("H{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("H{0}", row)].Value = ivaMXN;
                    Sheet.Cells[string.Format("I{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("I{0}", row)].Value = totMXN;
                    Sheet.Cells[string.Format("L{0}", row)].Value = "Total Vendedor";
                    //Pesos
                    Sheet.Cells[string.Format("M{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("M{0}", row)].Value = totalMXNVen;
                    //Dolares
                    Sheet.Cells[string.Format("N{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("N{0}", row)].Value = totalUSDVen;
                    fila += 1;
                    row = fila;
                    Sheet.Cells[string.Format("F{0}", row)].Value = "Total USD";
                    Sheet.Cells[string.Format("G{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("G{0}", row)].Value = subtUSD;
                    Sheet.Cells[string.Format("H{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("H{0}", row)].Value = ivaUSD;
                    Sheet.Cells[string.Format("I{0}", row)].Style.Numberformat.Format = "$#,##0.00";
                    Sheet.Cells[string.Format("I{0}", row)].Value = totUSD;
                    fila += 1;
                    row = fila;
                    row++;
                }

                //Se genera el archivo y se descarga

                Sheet.Cells["A:AZ"].AutoFitColumns();
                Response.Clear();
                Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
                Response.AddHeader("content-disposition", "attachment: filename=" + "ReporteExcelNC.xlsx");
                Response.BinaryWrite(Ep.GetAsByteArray());
                Response.End();
                return Redirect("/blah");
            }
            return Redirect("index");
        }
        public string r_Pedidos(int IDPrefactura)//Rastrear pedidos
        {
            string pedidos = string.Empty;
            try
            {
                if (IDPrefactura < 751)
                {
                    List<DetPrefactura> documentosEncPre = new PrefacturaContext().DetPrefactura.Where(s => s.IDPrefactura == IDPrefactura).ToList();
                    Hashtable documentoshash = new Hashtable();
                    foreach (DetPrefactura elemento in documentosEncPre)
                    {
                        string llave = elemento.Proviene + elemento.IDExterna;
                        if (!documentoshash.ContainsKey(llave))
                        { documentoshash.Add(llave, elemento); }
                    }
                    foreach (DictionaryEntry de in documentoshash)
                    {
                        DetPrefactura elementop = (DetPrefactura)documentoshash[de.Key];
                        if (elementop.Proviene == "Pedido")
                        {
                            pedidos += elementop.IDExterna + " ";
                        }
                        if (elementop.Proviene == "Remision")
                        {
                            ClsRastreaDA rastrea = new ClsRastreaDA();
                            List<NodoTrazo> nodos = rastrea.getDocumentoAnterior(elementop.Proviene, elementop.IDExterna, "Encabezado");
                            foreach (NodoTrazo nodo in nodos)
                            {
                                pedidos += nodo.ID + " ";
                            }
                        }
                    }
                    pedidos = pedidos.Trim();
                }
                if (IDPrefactura >= 751)
                {
                    List<elementosprefactura> documentos = new PrefacturaContext().elementosprefacturas.Where(s => s.idprefactura == IDPrefactura).ToList();
                    Hashtable documentoshash = new Hashtable();
                    foreach (elementosprefactura elemento in documentos)
                    {
                        string llave = elemento.documento + elemento.iddocumento;
                        if (!documentoshash.ContainsKey(llave))
                        { documentoshash.Add(llave, elemento); }
                    }
                    foreach (DictionaryEntry de in documentoshash)
                    {
                        elementosprefactura elementop = (elementosprefactura)documentoshash[de.Key];
                        if (elementop.documento == "Pedido")
                        {
                            pedidos += elementop.iddocumento + " ";
                        }
                        if (elementop.documento == "Remision")
                        {
                            ClsRastreaDA rastrea = new ClsRastreaDA();
                            List<NodoTrazo> nodos = rastrea.getDocumentoAnterior(elementop.documento, elementop.iddocumento, "Encabezado");
                            foreach (NodoTrazo nodo in nodos)
                            {
                                pedidos += nodo.ID + " ";
                            }
                        }

                    }
                    pedidos = pedidos.Trim();
                }

            }
            catch (Exception err)
            {

            }
            pedidos = pedidos.Trim();

            return pedidos;
        }
        public decimal c_Costo(EncPrefactura prefactura, int idpedido)
        {
            string Monedaprefactura = prefactura.c_Moneda.ClaveMoneda; /// USD MXN 
            var articulos = new PrefacturaContext().DetPrefactura.Where(s => s.IDPrefactura == prefactura.IDPrefactura);
            decimal acumuladorcosto = 0;
            foreach (DetPrefactura detalle in articulos)
            {
                if (r_escomisionale(detalle.IDArticulo))
                {
                    decimal costoxarti = 0;
                    try
                    {

                        ClsDatoDecimal can = db.Database.SqlQuery<ClsDatoDecimal>("select cantidad as Dato from DetPedido where idarticulo= " + detalle.IDArticulo + " and idpedido=" + idpedido).ToList().FirstOrDefault();
                        ClsDatoDecimal costoArt = db.Database.SqlQuery<ClsDatoDecimal>("select costo as Dato from DetPedido where idarticulo= " + detalle.IDArticulo + " and idpedido=" + idpedido).ToList().FirstOrDefault();






                        string cadenacostoxarticulo = "select dbo.getcosto(0," + detalle.IDArticulo + "," + can.Dato + ") as Dato";
                        costoxarti = new c_MonedaContext().Database.SqlQuery<ClsDatoDecimal>(cadenacostoxarticulo).FirstOrDefault().Dato;

                        Articulo Ar = db.Database.SqlQuery<Articulo>("select * from articulo where idarticulo= " + detalle.IDArticulo).ToList().FirstOrDefault();
                        string Monedaarticulo = "USD";

                        //if (Ar.IDFamilia == 10 || Ar.IDFamilia == 27 || Ar.IDFamilia == 19 || Ar.IDFamilia == 63)
                        //{
                        //    Monedaarticulo = "USD";
                        //}
                        //else
                        //{
                        c_MonedaContext C = new c_MonedaContext();
                        Monedaarticulo = C.c_Monedas.Find(Ar.IDMoneda).ClaveMoneda;
                        //}


                        if (costoxarti == 0)
                        {
                            try
                            {
                                DetOrdenCompra mc = new OrdenCompraContext().DetOrdenCompras.Where(s => s.IDArticulo == detalle.IDArticulo).OrderByDescending(s => s.IDDetOrdenCompra).FirstOrDefault();
                                costoxarti = mc.Costo;
                                C = new c_MonedaContext();
                                Monedaarticulo = C.c_Monedas.Find(mc.OrdenCompra.IDMoneda).ClaveMoneda;
                            }
                            catch (Exception err)
                            {
                                costoxarti = 0;
                            }
                        }

                        if (costoxarti == 0)  // sino tiene costo en ordendecompra va a lamatriz precioproveedor
                        {
                            try
                            {
                                MatrizPrecioProv mc = new MatrizPrecioProvContext().MatrizPP.Where(s => s.IDArticulo == detalle.IDArticulo).FirstOrDefault();
                                costoxarti = mc.Precio;
                                C = new c_MonedaContext();
                                Monedaarticulo = C.c_Monedas.Find(mc.IDMoneda).ClaveMoneda;
                            }
                            catch (Exception err)
                            {
                                costoxarti = 0;
                            }
                        }







                        if (costoxarti == 0)  // sino no tiene las anteriores va a la matriz de costo
                        {
                            MatrizCosto mc = new ArticuloContext().MatrizCostos.Where(s => s.IDArticulo == detalle.IDArticulo).FirstOrDefault();
                            costoxarti = mc.Precio;
                            C = new c_MonedaContext();
                            Monedaarticulo = C.c_Monedas.Find(Monedaarticulo).ClaveMoneda;

                        }

                        if (costoxarti == 0)  // sino no tiene las anteriores va a la matriz de costo
                        {
                            int iddetpedido = 0;

                            if (detalle.Proviene == "Pedido")
                            {
                                DetPedido detallepedido = new PedidoContext().DetPedido.Find(detalle.IDDetExterna);
                                iddetpedido = detallepedido.IDDetPedido;


                            }

                            if (detalle.Proviene == "Remision")
                            {
                                DetRemision detalleremision = new RemisionContext().DetRemisiones.Find(detalle.IDDetExterna);

                                iddetpedido = detalleremision.IDExterna;
                            }


                            int idordenproduccion = 0;
                            decimal cantidadproduccida = 0;

                            try
                            {
                                SIAAPI.Models.Produccion.OrdenProduccion orden = db.Database.SqlQuery
                                        <SIAAPI.Models.Produccion.OrdenProduccion>("select  * from OrdenProduccion where IDDetPedido=" + iddetpedido + " and EstadoOrden<>'Cancelada' ").ToList().FirstOrDefault();

                                cantidadproduccida = orden.Cantidad;

                                ClsDatoDecimal costo = new ArticuloContext().Database.SqlQuery<ClsDatoDecimal>("select sum(costoplaneado) as Dato from articuloproduccion where idorden =" + orden.IDOrden).FirstOrDefault();
                                try
                                {
                                    costoxarti = costo.Dato / orden.Cantidad;
                                }
                                catch (Exception err)
                                {

                                }

                            }
                            catch (Exception err)
                            {
                                string mensajeerr = err.Message;
                                idordenproduccion = 0;
                                cantidadproduccida = 0;
                                costoxarti = 0;

                            }

                        }

                        string cadenaaa = "select [dbo].[GetTipocambioCadena]('" + prefactura.Fecha.Year + "-" + prefactura.Fecha.Month + "-" + prefactura.Fecha.Day + "','" + Monedaarticulo + "','" + Monedaprefactura + "') as Dato";
                        decimal tipocambio = new ArticuloContext().Database.SqlQuery<ClsDatoDecimal>(cadenaaa).FirstOrDefault().Dato;

                        acumuladorcosto += ((costoxarti * tipocambio) * detalle.Cantidad);



                    }

                    catch (Exception err)
                    {

                    }

                }

            }

            return acumuladorcosto;
        }
        public decimal c_basecomisionable(EncPrefactura prefactura)
        {
            string Monedaprefactura = prefactura.c_Moneda.ClaveMoneda; /// USD MXN 
            var articulos = new PrefacturaContext().DetPrefactura.Where(s => s.IDPrefactura == prefactura.IDPrefactura);
            decimal acumuladorcosto = 0;
            foreach (DetPrefactura detalle in articulos)
            {
                if (r_escomisionale(detalle.IDArticulo))
                {

                    acumuladorcosto += (detalle.Importe);
                }

            }

            return acumuladorcosto;
        }

        public bool r_escomisionale(int IDArticuloComp)//Rastrear para saber si es comisionable
        {
            bool comisionable = true;

         
            //Articulo NO comisionable
            string cadena1 = "select count(*) as Dato from Articulo as A inner join ArticuloNOC as ANC on ANC.IDArticulo = A.IDArticulo where ANC.IDArticulo = " + IDArticuloComp + "";
            ClsDatoEntero Articulo_NOC = db.Database.SqlQuery<ClsDatoEntero>(cadena1).ToList().FirstOrDefault();
            try
            {
                if (Articulo_NOC.Dato != 0) //Si es diferente de 0 el articulo o el detprefactura es NO comisionable
                {
                    comisionable = false;
                }
            }
            catch (Exception err)
            {
                comisionable = false;
            }

            return comisionable;
        }

        public DateTime r_FechaPedido(int IDPedido)//Rastrear la fecha del pedido
        {
            //DateTime fechaPedido = DateTime.Now;
            //string cadena0 = "select Fecha as Dato from EncPedido where IDPedido = "+IDPedido+"";
            //ClsDatoString consulta = db.Database.SqlQuery<ClsDatoString>(cadena0).ToList().FirstOrDefault();
            EncPedido pedido = new PedidoContext().EncPedidos.Find(IDPedido);


            DateTime fechaPedido = pedido.Fecha;

            return fechaPedido;
        }

    }
}
